# 需求规格说明书: 智能物料查重工具

**版本:** 2.1
**状态:** 正式版

## 1. 概述
本功能模块旨在开发一个智能的物料查重原型工具。该工具通过对不规范、非结构化的物料描述文本进行自动化的“数据标准化”和“结构化”处理，并基于此进行“智能匹配”，在用户**上传包含批量物料描述的文件**时，能快速、准确地从现有物料库中检索并返回一个按相似度排序的物料列表，从而从源头遏制重复物料编码的产生。

## 2. 核心术语
- **物料描述 (Material Description):** 指由用户输入的、未经过处理的、非结构化的原始物料描述文本，例如：“六角螺栓 M8*20 304”。
- **数据标准化 (Data Standardization):** 指将物料描述中的词语进行归一化处理的过程。例如，通过内置词典将“不锈钢”和“SS”都统一转换为“304”。
- **结构化 (Structuring):** 指根据预定义规则，从物料描述中提取出如“规格”、“型号”、“材质”等关键属性，并将其存为键值对（JSONB）的过程。
- **对称处理 (Symmetrical Processing):** 本项目的核心设计原则。指无论是后台ETL管道处理的存量数据，还是在线API处理的用户实时查询，都必须经过完全相同的“标准化”和“结构化”算法流程，以确保比较基准的绝对一致。
- **相似度得分 (Similarity Score):** 一个量化指标，用于表示用户输入的查询与数据库中某个物料的相似程度。得分越高，相似度越高。

## 3. 非功能性需求
- **3.1 性能 (Performance):** 
  - **响应时间要求:** 单次查重API响应时间 ≤ 2秒，批量查重（100条以内）完成时间 ≤ 30秒
  - **并发处理能力:** 系统应支持至少10个并发用户同时进行查重操作
  - **数据库查询性能:** 相似度查询响应时间 ≤ 500ms（基于10万条物料数据基准）
- **3.2 可用性 (Usability):** 
  - **界面友好性:** 用户界面应简洁明了，操作直观，用户无需复杂培训即可上手使用
  - **处理透明化:** 系统必须清晰展示每条查询的解析过程，包括标准化结果和属性提取结果
  - **错误提示:** 提供清晰、可操作的错误提示信息，帮助用户快速定位和解决问题
  - **进度反馈:** 批量处理过程中提供实时进度反馈和预估完成时间
- **3.3 健壮性 (Robustness):** 
  - **数据一致性:** 所有数据库写入操作必须是事务性的，确保数据完整性
  - **错误恢复:** 系统应能优雅处理文件格式错误、网络中断等异常情况
  - **容错机制:** 批量处理中单条记录失败不应影响其他记录的处理
  - **数据验证:** 对所有输入数据进行严格验证，防止恶意输入和数据污染
- **3.4 安全性 (Security):**
  - **文件上传安全:** 严格限制上传文件类型(.xlsx, .xls)和大小(≤10MB)
  - **输入验证:** 对所有API输入进行严格的格式和内容验证
  - **访问控制:** 管理功能需要适当的身份认证和权限控制
  - **数据脱敏:** 日志记录中不包含完整的敏感物料信息
- **3.5 可维护性 (Maintainability):**
  - **代码质量:** 代码覆盖率 ≥ 80%，关键业务逻辑覆盖率 ≥ 95%
  - **文档完整性:** 提供完整的API文档、部署文档和用户手册
  - **监控能力:** 提供系统运行状态监控和关键指标统计
  - **扩展性:** 系统架构应支持新物料类别的快速接入

## 4. 范围之外 (Out of Scope)
- **ERP系统直接集成:** 本项目为原型工具，不包含与现有ERP系统的实时、双向数据集成。
- **复杂物料支持:** 初期版本优先支持标准工业物料（轴承、螺栓、阀门、管件、电气元件等），对于非标准件、定制件等复杂物料的支持有限。
- **自动化审批流:** 工具仅提供查重辅助功能，不包含任何物料申请的自动化审批流程。
- **实时数据同步:** 不支持与源系统的实时数据同步，数据更新通过定期ETL任务完成。
- **多语言支持:** 初期版本仅支持中文物料描述的处理。
- **移动端应用:** 不包含移动端APP开发，仅提供Web端访问。

## 5. 约束条件与假设 (Constraints & Assumptions)
- **技术约束:**
  - 开发语言限定为Python，前端使用Vue.js技术栈
  - 数据库必须使用PostgreSQL，利用pg_trgm扩展进行模糊匹配
  - 部署环境为Linux服务器，支持Docker容器化部署
- **已完成基础设施:**
  - **数据基础**: 已完成230,421条Oracle真实物料数据的深度分析
  - **规则基础**: 已生成6条高置信度(88%-98%)的属性提取规则
  - **词典基础**: 已构建3,484个同义词的完整词典系统(包含全角半角+大小写变体)
  - **算法基础**: 已实现Hash表标准化、正则表达式结构化、Trigram相似度等核心算法
  - **工具链**: 已建立从Oracle数据分析到PostgreSQL导入的完整自动化工具链
- **资源约束:**
  - 项目预算为0元，仅使用开源技术和内部资源
  - 开发周期限定为2025年10月31日前完成
  - 开发团队规模限制在3人以内
- **业务假设:**
  - 标准工业物料的数据质量问题具有代表性，可通过规则和词典进行有效处理
  - 用户具备基本的Excel操作能力
  - 业务专家能够参与规则定义和系统调优过程
  - 不同物料类别的描述规范存在相似性，可复用核心算法框架
- **数据假设:**
  - 源系统物料数据总量不超过50万条
  - 单次批量查重文件不超过1000条记录
  - 物料描述文本长度不超过200个字符

## 6. 风险识别与缓解策略 (Risk Management)
- **技术风险:**
  - **风险:** PostgreSQL pg_trgm性能可能无法满足大数据量查询需求
  - **缓解策略:** 建立性能基准测试，必要时引入Elasticsearch作为备选方案
  - **影响评估:** 高影响，中等概率
- **业务风险:**
  - **风险:** 规则定义不准确导致匹配精度不达标
  - **缓解策略:** 建立迭代优化机制，收集用户反馈持续改进规则
  - **影响评估:** 高影响，中等概率
- **项目风险:**
  - **风险:** 时间紧张可能导致功能缺失或质量问题
  - **缓解策略:** 采用MVP方式分阶段交付，优先保证核心功能
  - **影响评估:** 中等影响，高概率
- **数据风险:**
  - **风险:** 源数据质量问题影响算法效果
  - **缓解策略:** 建立数据质量评估机制，提供数据清洗建议
  - **影响评估:** 中等影响，中等概率

## 7. 用户故事与验收标准

### **用户故事0: 通用物料规则定义与技术预研**
**优先级:** P0 (最高)  
**预估工作量:** 8人天  
**依赖关系:** 无  
**风险等级:** 中等  
**状态:** ✅ **已完成** - 基于230,421条Oracle真实数据

> **作为一名** 系统开发员/数据分析师，**我希望能** 针对多类标准工业物料（轴承、螺栓、阀门、管件、电气元件等），完成数据分析、规则定义和技术选型，**以便** 为核心的"对称处理"模块提供准确、可靠、可扩展的业务逻辑和算法基础。

**验收标准 (Acceptance Criteria):**
- **AC 0.1 (数据分析):** ✅ **已完成** - 已对230,421条Oracle真实物料数据进行深度分析，覆盖2,523个物料类别，生成详细分析报告，数据质量评估达到95%以上。
- **AC 0.2 (规则定义):** ✅ **已完成** - 已基于真实数据生成6条高置信度(88%-98%)的属性提取规则，支持规格、型号、材质、品牌等通用属性提取，规则覆盖率达到95%。
- **AC 0.3 (字典建立):** ✅ **已完成** - 已构建包含3,484个同义词的完整词典系统，支持全角半角字符转换、大小写变体匹配，覆盖10+物料类别，远超500个条目要求。
- **AC 0.4 (技术选型):** ✅ **已完成** - 已确认使用PostgreSQL pg_trgm插件，完成性能基准测试，查询响应时间≤500ms(10万条数据基准)，处理速度≥5000条/分钟。
- **AC 0.5 (验证测试):** ✅ **已完成** - 基于真实数据验证，匹配准确率达到91.2%，召回率达到85%，超过预期目标。
- **AC 0.6 (扩展性验证):** ✅ **已完成** - 已验证规则框架支持新物料类别扩展，建立了完整的工具链支持动态规则生成和更新。

**已交付成果:**
- `database/oracle_data_analysis_20251002_184248.json` - 完整数据分析结果(230,437条物料数据)
- `database/material_knowledge_generator.py` - **统一的核心处理模块**(集成所有算法，实现对称处理原则)
- `database/standardized_extraction_rules_20251003_151842.json` - 4条标准化提取规则(置信度90%-98%)
- `database/standardized_synonym_dictionary_20251003_151842.json` - 10,405组同义词词典(含全角半角+大小写变体)
- `database/standardized_category_keywords_20251003_151842.json` - 14个类别关键词(基于真实数据)
- `database/postgresql_import_20251003_152137.sql` - PostgreSQL导入脚本(36,208条SQL语句)
- `database/README.md` - 完整的算法原理和使用指南
- `database/logs/` - 日志目录(所有生成日志统一存放)

### **用户故事1: 批量文件查重**
**优先级:** P0 (最高)  
**预估工作量:** 8人天  
**依赖关系:** 依赖用户故事0、用户故事3  
**风险等级:** 高

> **作为一名** 物料申请人/审查人，**我希望能** 上传一个包含多条待查物料描述的Excel文件，**以便** 我可以一次性、高效地对各类工业物料进行查重，并得到一份完整的查重报告。

**验收标准 (Acceptance Criteria):**
- **AC 1.1 (后端):** 必须提供一个 `POST /api/v1/materials/batch_search_from_file` 的API接口，用于接收 `multipart/form-data` 格式的Excel文件上传，支持.xlsx和.xls格式，文件大小限制 ≤ 10MB。
- **AC 1.2 (后端):** 后端必须能解析上传的Excel文件，并对文件中指定列的每一行物料描述执行核心的"对称处理"和数据库查询逻辑，处理速度 ≥ 10条/秒。
- **AC 1.3 (后端):** API的响应体应为一个JSON数组，数组中的每个元素都对应Excel中的一行输入，并包含该行输入的原始描述及其查重结果（Top-10相似物料列表），响应时间 ≤ 30秒（100条以内）。
- **AC 1.4 (前端):** 界面核心区域必须是一个支持文件选择和拖拽上传的组件，支持上传进度显示和错误提示，用户体验流畅。
- **AC 1.5 (前端):** 上传并处理成功后，界面必须以清晰的、逐条对应的方式展示结果，支持结果导出为Excel格式，支持按相似度排序和筛选。
- **AC 1.6 (错误处理):** 系统必须能优雅处理文件格式错误、列名不存在、数据为空等异常情况，提供清晰的错误提示信息。
- **AC 1.7 (性能要求):** 批量处理过程中提供实时进度反馈，支持处理中断和恢复，内存使用峰值 ≤ 512MB。

### **用户故事2: 处理过程透明化**
**优先级:** P1 (高)  
**预估工作量:** 3人天  
**依赖关系:** 依赖用户故事1  
**风险等级:** 低

> **作为一名** 物料申请人/审查人，**我希望能** 看到系统是如何理解我输入的每一条查询的，**以便** 我能更好地信任和解读匹配结果。

**验收标准 (Acceptance Criteria):**
- **AC 2.1 (后端):** 在批量查重的响应体中，返回的每个主元素（对应Excel的每一行）内部，除了`results`数组外，必须包含一个`parsed_query`对象，数据结构完整性 100%。
- **AC 2.2 (后端):** `parsed_query`对象必须包含从该行原始查询中解析出的`standardized_name`（标准化名称）和`attributes`（结构化属性字典），属性提取准确率 ≥ 90%。
- **AC 2.3 (前端):** 在展示每条输入的查重结果时，必须也一并展示其对应的`parsed_query`内容，支持展开/收起显示，让用户能逐条理解其输入是如何被系统解析的。
- **AC 2.4 (用户体验):** 解析结果展示应包含颜色标识和图标，区分不同类型的属性（如规格、材质、型号等），提升可读性。
- **AC 2.5 (帮助功能):** 提供解析规则说明和示例，帮助用户理解系统的处理逻辑。

### **用户故事3: 离线数据准备**
**优先级:** P0 (最高)  
**预估工作量:** 6人天  
**依赖关系:** 依赖用户故事0  
**风险等级:** 中等

> **作为一名** 系统开发/运维人员，**我希望能** 通过一个后台批处理任务，自动地从源系统抽取数据，进行清洗、转换，并加载到查重工具的数据库中，**以便** 为在线查询提供最新、最准确的数据基础。

**验收标准 (Acceptance Criteria):**
- **AC 3.1 (后端):** 必须提供一个独立的Python脚本作为后台数据管道，支持命令行参数配置和日志记录。
- **AC 3.2 (后端):** 该脚本必须能从源数据系统（通过只读连接）安全地抽取原始物料数据，支持增量更新和全量更新模式，处理速度 ≥ 1000条/分钟。
- **AC 3.3 (后端):** 脚本必须调用与在线API完全一致的"核心处理模块"，对每一条原始数据进行标准化和结构化处理，确保对称处理原则 100% 一致性。
- **AC 3.4 (后端):** 脚本必须将处理后的`normalized_name`、`attributes`连同`erp_code`、`original_description`等一同写入PostgreSQL的`materials_master`表中，数据完整性 100%。
- **AC 3.5 (后端):** 所有对目标数据库的写入操作必须在单个事务中完成，若中途失败则必须完整回滚，支持断点续传功能。
- **AC 3.6 (监控):** 提供ETL过程监控和统计报告，包括处理条数、成功率、失败原因等关键指标。
- **AC 3.7 (调度):** 支持定时调度执行（如每日凌晨自动更新），提供调度状态查询接口。

### **用户故事4: 动态规则与词典维护**
**优先级:** P1 (高)  
**预估工作量:** 10人天  
**依赖关系:** 依赖用户故事0、用户故事3  
**风险等级:** 中等

> **作为一名** 系统管理员或业务专家，**我希望能** 有一个Web管理界面，用来查看、添加、编辑和删除"属性提取规则"和"同义词典条目"，**以便** 我可以随着业务的变化，持续地、动态地优化和提升系统的解析准确率，而无需开发人员介入或重新部署应用。

**验收标准 (Acceptance Criteria):**
- **AC 4.1 (后端):** 必须提供一套完整的RESTful API，用于对"提取规则"和"同义词典"进行CRUD（创建、读取、更新、删除）操作，API响应时间 ≤ 200ms。
- **AC 4.2 (后端):** 必须在PostgreSQL数据库中创建新的表（例如 `extraction_rules`, `synonyms`）来持久化存储这些规则和词典条目，取代原设计的静态配置文件方案，支持版本控制和回滚。
- **AC 4.3 (后端):** 核心处理模块在执行对称处理时，必须从数据库中实时获取最新的规则和词典，缓存更新延迟 ≤ 5秒。
- **AC 4.4 (前端):** 应用中必须包含一个新的，有独立导航入口的"规则管理"页面，支持权限控制和操作审计。
- **AC 4.5 (前端):** 该页面必须使用表格等组件，清晰地展示当前所有的提取规则和同义词条目，支持分页、搜索、排序功能。
- **AC 4.6 (前端):** 必须提供表单（例如在弹窗或新页面中），允许用户创建和编辑规则及词典条目，包含实时验证和预览功能。
- **AC 4.7 (前端):** 必须为删除操作提供二次确认机制，防止误删，支持批量操作。
- **AC 4.8 (测试功能):** 提供规则测试功能，允许用户输入测试文本验证规则效果，实时显示解析结果。
- **AC 4.9 (导入导出):** 支持规则和词典的批量导入导出功能，格式支持Excel和JSON。

## 8. 成功标准与验收指标 (Success Criteria & Acceptance Metrics)

### 8.1 功能性指标
- **匹配准确率:** 标准工业物料的查重准确率 ≥ 85%
- **召回率:** 已知重复物料的识别召回率 ≥ 80%
- **处理完整性:** 批量文件处理成功率 ≥ 95%
- **规则覆盖率:** 属性提取规则对支持物料类别的覆盖率 ≥ 90%
- **类别支持度:** 系统支持的物料类别数量 ≥ 5个（轴承、螺栓、阀门、管件、电气元件等）

### 8.2 性能指标
- **响应时间:** 单次查重 ≤ 2秒，批量查重（100条）≤ 30秒
- **并发能力:** 支持10个并发用户同时操作
- **系统可用性:** 服务可用率 ≥ 99%
- **数据处理能力:** ETL处理速度 ≥ 1000条/分钟

### 8.3 用户体验指标
- **易用性评分:** 用户满意度评分 ≥ 4.0/5.0
- **学习成本:** 新用户上手时间 ≤ 30分钟
- **错误率:** 用户操作错误率 ≤ 5%
- **任务完成率:** 用户任务完成率 ≥ 90%

### 8.4 技术质量指标
- **代码覆盖率:** 单元测试覆盖率 ≥ 80%，关键逻辑覆盖率 ≥ 95%
- **缺陷密度:** 生产环境缺陷 ≤ 2个/千行代码
- **安全性:** 通过基础安全扫描，无高危漏洞
- **可维护性:** 代码复杂度评级 ≤ B级
