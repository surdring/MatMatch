# 对称处理优化验证手册

## 📋 概述

本手册指导如何验证和测试对称处理优化后的系统功能，确保：
1. ✅ 前端和后端使用一致的清洗规则
2. ✅ 重复判定逻辑准确（三级判定标准）
3. ✅ 知识库基于清洗后数据生成
4. ✅ 相似度算法优化生效

---

## 🎯 本次优化内容

### 1. 对称处理完善（核心修复）
- **问题1**：前端使用原始数据，后端使用清洗后数据，对比不一致
- **解决1**：
  - 后端返回 `cleaned_name`、`cleaned_spec`、`cleaned_unit` 字段
  - 前端使用清洗后的数据进行对比
  
- **问题2（关键）**：ETL存储的 `full_description` 未应用清洗规则，导致相似度计算为0
- **解决2**：
  - ✅ **ETL修复**：`full_description` = `standardized_text`（13条规则+同义词替换）
  - ✅ **在线查询修复**：`full_description` = `standardized_text`（13条规则+同义词替换）
  - ✅ 确保ETL存储和在线查询完全对称，相似度计算正确

### 2. 重复判定逻辑优化
- **旧逻辑**：仅基于相似度≥90%判定重复
- **新逻辑**：三级判定标准
  - 🔴 **完全重复**：清洗后名称 + 规格 + 单位完全匹配
  - 🟠 **疑似重复**：清洗后名称 + 规格匹配，但单位不同
  - 🟠 **高度相似**：相似度≥90%

### 3. 相似度算法优化
- **调整权重**：
  - 名称相似度：40% → **50%**
  - 描述相似度：30% → **30%**
  - 属性相似度：20% → **20%**
  - 分类相似度：10% → **0%**（取消）

### 4. 知识库生成器重构
- **旧模式**：从Oracle原始数据生成规则
- **新模式**：仅从PostgreSQL清洗后数据生成规则
- **优势**：生成的规则天然匹配13条清洗规则

---

## 🚀 完整验证流程

### ⭐ 方式1：一键自动化执行（强烈推荐）

使用集成脚本 `run_complete_pipeline.py` 自动完成所有步骤：

```bash
# 完整流程（ETL同步 → 知识库生成 → 导入数据库）
.\venv\Scripts\python.exe run_complete_pipeline.py
```

**执行内容：**
1. **ETL同步**（步骤1）
   - 清空 `materials_master` 表
   - 从Oracle提取全部221,029条数据
   - 应用13条清洗规则到每条数据
   - `full_description` 保存为 `standardized_text`（13条规则+同义词）
   - 写入PostgreSQL

2. **知识库生成**（步骤2）
   - 从PostgreSQL加载**全部221,029条已清洗数据**
   - 基于清洗后数据生成知识库
   - 生成1,568个分类关键词
   - 生成4条提取规则
   - 生成72个同义词组（124条记录）
   - 保存到JSON文件

3. **知识库导入**（步骤3）
   - 清空现有知识库表
   - 导入到数据库（extraction_rules, synonyms, knowledge_categories）
   - 验证数据一致性

**可选参数：**
```bash
# 跳过ETL（如果数据已是最新且已应用清洗规则）
.\venv\Scripts\python.exe run_complete_pipeline.py --skip-etl

# 仅生成知识库文件（不导入数据库）
.\venv\Scripts\python.exe run_complete_pipeline.py --skip-import
```

**⚠️ 重要说明：**
- 必须先执行ETL同步（或使用已经正确清洗的数据）
- 知识库生成依赖PostgreSQL中**已清洗的数据**
- 确保 `full_description` 字段已应用13条清洗规则

---

### 方式2：分步手动执行（调试用）

仅在需要单独测试某个步骤时使用：

#### 步骤1：ETL同步
```bash
.\venv\Scripts\python.exe backend\scripts\truncate_and_full_sync.py
```

**验证要点：**
- ✅ 检查 `full_description` 是否已清洗（应为小写+下划线格式）
- ✅ 检查数据总量：221,029条

#### 步骤2：知识库生成
```bash
.\venv\Scripts\python.exe database\generate_knowledge_from_pg.py
```

**验证要点：**
- ✅ 确认加载数据量：221,029条
- ✅ 确认数据来源：PostgreSQL（非Oracle）

#### 步骤3：知识库导入
```bash
.\venv\Scripts\python.exe backend\scripts\import_knowledge_base.py --clear
```

**验证要点：**
- ✅ 确认JSON文件路径正确（database/目录下）
- ✅ 确认导入数量正确

---

## 🧪 功能测试指南

### 测试前准备

1. **启动后端服务**
```bash
cd backend
..\venv\Scripts\python.exe -m uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

2. **启动前端服务**
```bash
cd frontend
npm run dev
```

3. **访问前端**：http://localhost:5173

---

### 测试用例1：完全重复判定

**目的**：验证"清洗后名称+规格+单位"完全匹配的判定

**步骤**：
1. 创建Excel文件，包含以下数据：
   ```
   物料名称        规格型号     单位
   六角螺栓        M8×20       个
   内六角螺栓      M8*20       个
   ```

2. 上传Excel进行查重

**预期结果**：
- 🔴 第一条：如果ERP中存在"六角螺栓 M8×20 个"，显示**完全重复**
- 🔴 第二条：如果ERP中存在"内六角螺栓 M8*20 个"，显示**完全重复**
- 📝 后端日志显示：`步骤5: 清洗规格 'M8×20' → 'm8_20'`

**验证点**：
- ✅ 不同分隔符（× vs *）被统一为下划线
- ✅ 大小写统一（M8 → m8）
- ✅ 清洗后的数据能正确对比

---

### 测试用例2：疑似重复判定（单位不同）

**目的**：验证名称+规格匹配但单位不同的判定

**步骤**：
1. 创建Excel文件：
   ```
   物料名称        规格型号     单位
   六角螺栓        M8×20       套
   ```

2. 上传Excel进行查重（假设ERP中存在"六角螺栓 M8×20 个"）

**预期结果**：
- 🟠 显示**疑似重复**
- 📝 描述：`部分匹配：名称和规格相同，但单位不同（编码：XXX，ERP单位：个，输入单位：套）`

**验证点**：
- ✅ 单位不同时不判定为完全重复
- ✅ 给出明确的单位差异提示

---

### 测试用例3：高度相似判定

**目的**：验证相似度≥90%的判定

**步骤**：
1. 创建Excel文件：
   ```
   物料名称              规格型号     单位
   304不锈钢六角螺栓     M8×20       个
   ```

2. 上传Excel进行查重（假设ERP中存在"六角螺栓 M8×20 个"）

**预期结果**：
- 🟠 显示**疑似重复**（如果相似度≥90%）
- 📝 描述：`高度相似：相似度92.3%（编码：XXX）`

**验证点**：
- ✅ 名称权重提升到50%
- ✅ 分类权重降为0%
- ✅ 相似度计算准确

---

### 测试用例4：不重复判定

**目的**：验证完全不同物料的判定

**步骤**：
1. 创建Excel文件：
   ```
   物料名称        规格型号     单位
   密封圈         Φ100×200    个
   ```

2. 上传Excel进行查重

**预期结果**：
- 🟢 显示**不重复**
- 📝 描述：`最高相似度35.2%，未达到重复标准`

---

### 测试用例5：希腊字母标准化

**目的**：验证希腊字母的清洗规则

**步骤**：
1. 创建Excel文件：
   ```
   物料名称        规格型号     单位
   密封圈         φ100        个
   密封圈         Φ100        个
   密封圈         PHI100      个
   ```

2. 上传Excel进行查重

**预期结果**：
- 📝 后端日志显示：
  ```
  步骤5: 清洗规格 'φ100' → 'phi100'
  步骤5: 清洗规格 'Φ100' → 'phi100'
  步骤5: 清洗规格 'PHI100' → 'phi100'
  ```
- ✅ 三种写法清洗后完全相同

---

## 🔍 验证检查清单

### 后端验证

- [ ] 日志中显示 `cleaned_name`、`cleaned_spec`、`cleaned_unit`
- [ ] 清洗规则应用正确（13条规则）
- [ ] `ParsedQuery` 包含清洗后的字段
- [ ] 相似度计算使用新权重（名称50%）

### 前端验证

- [ ] 重复判定显示正确的标签（重复/疑似重复/不重复）
- [ ] 颜色标记正确（红色/橙色/绿色）
- [ ] 描述信息准确详细
- [ ] 单位差异提示清晰

### 知识库验证

- [ ] 知识库基于PostgreSQL生成
- [ ] 提取规则匹配清洗后格式
- [ ] 分类关键词基于清洗后数据
- [ ] 导入数据库成功且一致

---

## 📊 性能验证

### ETL性能
- **目标**：≥25,000条/分钟
- **验证命令**：查看ETL日志中的处理速度

### 知识库生成性能
- **目标**：221,029条全部数据 ≤ 10秒
- **验证**：查看生成日志的耗时

### 在线查询性能
- **目标**：单次查询 ≤ 2秒
- **验证**：前端观察响应时间

---

## 🐛 常见问题排查

### 问题1：前端显示"未找到结果"

**可能原因**：
- 数据库为空或ETL未同步
- 相似度阈值太高

**排查步骤**：
1. 检查数据库：`SELECT COUNT(*) FROM materials_master;`
2. 检查后端日志：是否有SQL错误
3. 降低阈值测试：修改 `min_similarity` 参数

### 问题2：重复判定不准确

**可能原因**：
- 清洗规则未生效
- 前端使用了原始数据对比

**排查步骤**：
1. 检查后端日志中的 `processing_steps`
2. 确认 `cleaned_spec` 字段有值
3. 检查前端 `getDuplicateConclusion` 函数

### 问题3：知识库导入失败

**可能原因**：
- JSON文件路径错误
- 数据库连接失败

**排查步骤**：
1. 确认JSON文件存在：`ls database/standardized_*.json`
2. 检查数据库连接：`python backend/scripts/test_db_connection.py`
3. 查看导入日志：`logs/knowledge_base_import_*.log`

---

## 📝 验证报告模板

```markdown
# 对称处理优化验证报告

**验证日期**：YYYY-MM-DD  
**验证人员**：[姓名]  
**版本**：v3.0

## 1. ETL同步验证
- [ ] 执行成功
- [ ] 处理速度：_____ 条/分钟
- [ ] 数据总数：_____ 条
- [ ] 清洗规则应用：✅/❌

## 2. 知识库生成验证
- [ ] 生成成功
- [ ] 分类关键词：_____ 个
- [ ] 提取规则：_____ 条
- [ ] 同义词：_____ 组

## 3. 知识库导入验证
- [ ] 导入成功
- [ ] 数据一致性：✅/❌
- [ ] 验证通过：✅/❌

## 4. 功能测试验证
- [ ] 完全重复判定：✅/❌
- [ ] 疑似重复判定（单位不同）：✅/❌
- [ ] 高度相似判定：✅/❌
- [ ] 不重复判定：✅/❌
- [ ] 希腊字母标准化：✅/❌

## 5. 性能验证
- [ ] ETL性能达标：✅/❌
- [ ] 知识库生成性能：✅/❌
- [ ] 在线查询性能：✅/❌

## 6. 问题记录
[记录发现的问题和解决方案]

## 7. 总体评价
- [ ] 通过验收
- [ ] 需要改进
```

---

## 🎯 下一步工作

验证完成后：

1. **生成实施日志**
   ```bash
   # 记录本次优化的完整过程
   # 保存到 .gemini_logs/YYYY-MM-DD/
   ```

2. **更新文档**
   - 更新 `developer_onboarding_guide.md`
   - 更新 `tasks.md` 状态

3. **部署上线**
   - 备份当前数据库
   - 执行生产环境ETL
   - 生成生产环境知识库
   - 重启服务

---

## 📞 支持联系

如有问题，请查看：
- 📁 实施日志：`.gemini_logs/YYYY-MM-DD/`
- 📁 系统日志：`logs/`
- 📄 设计文档：`specs/main/design.md`
- 📄 需求文档：`specs/main/requirements.md`

