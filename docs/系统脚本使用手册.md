# MatMatch 系统脚本使用手册

**版本**: 2.0  
**更新日期**: 2025-10-07

---

## 📁 脚本文件清单

### 🚀 日常使用脚本

| 脚本名称 | 路径 | 用途 | 使用频率 |
|---------|------|------|---------|
| **智能启动.bat** | 根目录 | 启动前后端服务（自动检查端口） | 每次开机/需要时 |
| **定时数据同步.bat** | 根目录 | Oracle数据同步 + 知识库更新 | 定时任务（每天凌晨） |

### 🔧 后端管理脚本

| 脚本名称 | 路径 | 用途 |
|---------|------|------|
| **run_etl_full_sync.py** | `backend/scripts/` | Oracle数据全量同步 |
| **truncate_and_full_sync.py** | `backend/scripts/` | 清空+全量同步（重置用） |
| **generate_test_excel.py** | `backend/scripts/` | 生成测试用Excel文件 |

### 📊 数据库工具脚本

| 脚本名称 | 路径 | 用途 |
|---------|------|------|
| **material_knowledge_generator.py** | `database/` | 生成知识库（规则、同义词、分类） |
| **check_oracle_tables.py** | `database/` | 检查Oracle表结构 |
| **test_oracle_connection.py** | `database/` | 测试Oracle连接 |
| **test_postgresql_connection.py** | `database/` | 测试PostgreSQL连接 |

### 🔍 检查和验证脚本

| 脚本名称 | 路径 | 用途 |
|---------|------|------|
| **check_materials_data.bat** | 根目录 | 快速查看物料数据量 |
| **check_table_counts.bat** | 根目录 | 查看所有表的记录数 |

---

## 🎯 常见使用场景

### 场景1：首次启动系统

```batch
# 步骤1: 启动PostgreSQL服务（确保已安装并配置）
# 步骤2: 双击运行
智能启动.bat
```

**说明**：
- 自动检查端口占用
- 自动导入知识库（如果未导入）
- 启动后端API (http://localhost:8000)
- 启动前端界面 (http://localhost:3000)

---

### 场景2：每日数据同步（推荐配置定时任务）

```batch
# 手动执行
定时数据同步.bat

# 或配置Windows定时任务（每天凌晨2:00自动执行）
```

**执行内容**：
1. 从Oracle同步最新物料数据
2. 重新生成知识库
3. 导入知识库到PostgreSQL

**配置方法**：参见 [定时任务配置指南.md](定时任务配置指南.md)

---

### 场景3：重置系统数据

```powershell
# 清空物料数据并重新同步
cd backend
..\venv\Scripts\python.exe scripts\truncate_and_full_sync.py
```

**警告**：此操作会删除所有物料数据，请谨慎使用！

---

### 场景4：测试批量查重功能

```powershell
# 生成测试Excel文件
cd backend
..\venv\Scripts\python.exe scripts\generate_test_excel.py

# 测试文件位置：backend/test_materials.xlsx
# 在前端界面上传此文件进行测试
```

---

### 场景5：检查系统状态

```batch
# 快速检查各表数据量
check_table_counts.bat

# 或查看物料数据统计
check_materials_data.bat
```

---

## 📖 核心脚本详解

### 1. 智能启动.bat

**功能**：系统启动的一站式解决方案

**工作流程**：
```
1. 检查端口8000和3000是否被占用
   └─ 如已占用 → 提示用户，退出
   
2. 检查知识库是否完整
   ├─ 完整 → 跳过导入
   └─ 不完整 → 自动导入
   
3. 启动后端API服务
   └─ http://localhost:8000
   
4. 启动前端开发服务
   └─ http://localhost:3000
   
5. 显示后端日志（前端在独立窗口）
```

**特点**：
- ✅ 智能检查，避免重复启动
- ✅ 自动初始化知识库
- ✅ 一键启动全部服务
- ✅ 实时显示运行日志

---

### 2. 定时数据同步.bat

**功能**：定时同步Oracle数据并更新知识库

**工作流程**：
```
1. 执行ETL全量同步
   └─ backend/scripts/run_etl_full_sync.py
   
2. 重新生成知识库
   └─ database/material_knowledge_generator.py
   
3. 导入知识库到PostgreSQL
   └─ start_all.py 中的导入功能
   
4. 记录执行日志
   └─ logs/sync_task.log
```

**推荐定时**：每天凌晨2:00执行

**执行时长**：约10-30分钟（取决于数据量）

---

### 3. start_all.py

**功能**：Python版的智能启动脚本（被智能启动.bat调用）

**核心功能模块**：

#### 3.1 知识库检查
```python
async def check_knowledge_base(self):
    """检查提取规则、同义词、分类是否完整"""
```

#### 3.2 知识库导入
```python
async def import_knowledge_base(self):
    """从JSON文件导入知识库到PostgreSQL"""
```

#### 3.3 服务启动
```python
def start_backend(self):  # 启动FastAPI
def start_frontend(self): # 启动Vite
```

---

## 🔧 高级用法

### 自定义配置

**后端配置** (`backend/.env`)：
```env
DATABASE_URL=postgresql+asyncpg://postgres:password@localhost:5432/matmatch
ORACLE_HOST=your_host
ORACLE_PORT=1521
ORACLE_SERVICE_NAME=your_service
ORACLE_USERNAME=your_username
ORACLE_PASSWORD=your_password
```

**ETL配置**：
```powershell
# 修改批处理大小（默认1000）
.\venv\Scripts\python.exe backend\scripts\run_etl_full_sync.py --batch-size 2000
```

---

## 📊 监控和日志

### 日志文件位置

```
MatMatch/
├── logs/
│   ├── sync_task.log              # 定时同步日志
│   ├── etl_full_sync_*.log        # ETL执行日志
│   └── app.log                    # 应用运行日志
├── database/logs/
│   └── material_knowledge_*.log   # 知识库生成日志
```

### 查看实时日志

```powershell
# 查看最新同步日志
Get-Content logs\sync_task.log -Tail 50

# 查看ETL日志
Get-Content logs\etl_full_sync_*.log -Wait

# 查看后端日志（运行中）
# 在智能启动.bat窗口中直接显示
```

---

## ⚠️ 常见问题

### Q1: 启动时提示端口被占用？
**A**: 使用以下命令查找并关闭占用进程：
```powershell
# 查找占用端口8000的进程
netstat -ano | findstr :8000

# 关闭进程（替换PID）
taskkill /PID <进程ID> /F
```

### Q2: 知识库导入失败？
**A**: 检查以下内容：
1. PostgreSQL服务是否运行
2. 数据库连接配置是否正确
3. JSON文件是否存在且完整
4. 数据库表结构是否正确

### Q3: ETL同步速度慢？
**A**: 优化方法：
1. 增加批处理大小 (`--batch-size 2000`)
2. 检查Oracle网络连接
3. 检查PostgreSQL性能
4. 查看系统资源使用情况

### Q4: 前端无法连接后端？
**A**: 检查：
1. 后端服务是否启动（访问 http://localhost:8000/health）
2. CORS配置是否正确
3. Vite代理配置是否正确（`frontend/vite.config.ts`）

---

## 🚨 紧急操作

### 完全重置系统

```powershell
# ⚠️ 警告：此操作会删除所有数据！

# 1. 停止所有服务（Ctrl+C）

# 2. 清空数据库
psql -h localhost -U postgres -d matmatch -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"

# 3. 重新初始化
cd backend
..\venv\Scripts\python.exe scripts\truncate_and_full_sync.py

# 4. 重新启动
cd ..
智能启动.bat
```

### 备份关键数据

```powershell
# 备份知识库JSON文件
xcopy database\standardized_*.json backup\ /Y

# 备份PostgreSQL数据库
pg_dump -h localhost -U postgres matmatch > backup\matmatch_backup.sql

# 恢复数据库
psql -h localhost -U postgres matmatch < backup\matmatch_backup.sql
```

---

## 📚 相关文档

- [定时任务配置指南.md](定时任务配置指南.md) - 详细的定时任务配置方法
- [开发者入职指南.md](developer_onboarding_guide.md) - 开发环境设置和项目结构
- [配置指南.md](configuration_guide.md) - 详细的环境配置说明

---

## 🔄 更新日志

| 日期 | 版本 | 更新内容 |
|------|------|---------|
| 2025-10-07 | 2.0 | 重构脚本体系，合并重复功能，添加智能检查 |
| 2025-10-05 | 1.0 | 初始版本 |

---

**维护者**: 项目团队  
**联系方式**: 信息自动化部郑学恩

