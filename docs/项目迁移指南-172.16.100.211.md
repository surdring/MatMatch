# MatMatch 项目迁移指南

**目标主机**: 172.16.100.211  
**迁移日期**: 2025-10-09  
**操作系统**: Windows

---

## 📋 迁移前检查清单

### 1. 新主机环境准备

- [ ] Python 3.10+ 已安装
- [ ] Node.js 18+ 已安装
- [ ] PostgreSQL 12+ 已安装并启动
- [ ] Git 已安装
- [ ] 网络连接正常（能访问 Oracle: 192.168.80.90:1521）

### 2. 需要迁移的数据

- [ ] PostgreSQL 数据库 `matmatch`
- [ ] 项目代码和配置
- [ ] 虚拟环境依赖

---

## 🚀 迁移步骤

### Step 1: 导出当前数据库

**在旧主机上执行：**

```bash
# 导出 PostgreSQL 数据库
cd D:\develop\python\MatMatch

# 导出数据库结构和数据
pg_dump -h 127.0.0.1 -U postgres -d matmatch -F c -b -v -f matmatch_backup_20251009.dump

# 或导出为SQL文件（更通用）
pg_dump -h 127.0.0.1 -U postgres -d matmatch -F p -b -v -f matmatch_backup_20251009.sql
```

**导出的文件：**
- `matmatch_backup_20251009.dump` (二进制格式，速度快)
- `matmatch_backup_20251009.sql` (SQL格式，可读，更通用)

---

### Step 2: 打包项目代码

**在旧主机上执行：**

```bash
cd D:\develop\python

# 方法1: 使用 Git（推荐）
cd MatMatch
git add .
git commit -m "迁移前备份 - 2025-10-09"
git push  # 如果有远程仓库

# 方法2: 压缩打包
# 排除以下目录: venv, node_modules, __pycache__, .pytest_cache
tar -czf MatMatch_backup_20251009.tar.gz MatMatch --exclude=venv --exclude=node_modules --exclude=__pycache__ --exclude=.pytest_cache --exclude=frontend/dist

# Windows 可以使用 7-Zip 或 WinRAR 手动压缩
```

**需要复制到新主机的文件：**
1. 项目代码压缩包
2. 数据库备份文件
3. `backend/.env` 文件（如果有）

---

### Step 3: 在新主机上恢复项目

#### 3.1 创建项目目录

```bash
# 在新主机上创建目录
cd D:\develop\python
mkdir MatMatch
cd MatMatch

# 解压项目文件
# 使用 Git clone 或解压备份文件
```

#### 3.2 创建Python虚拟环境

```bash
cd D:\develop\python\MatMatch

# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
.\venv\Scripts\activate

# 安装后端依赖
pip install -r backend\requirements.txt

# 安装数据库工具依赖
pip install -r database\requirements.txt
```

#### 3.3 安装前端依赖

```bash
cd frontend
npm install
cd ..
```

---

### Step 4: 恢复PostgreSQL数据库

#### 4.1 创建数据库

```bash
# 使用 psql 创建数据库
psql -h 127.0.0.1 -U postgres

# 在 psql 中执行
CREATE DATABASE matmatch;
\q
```

#### 4.2 导入数据

```bash
# 方法1: 从 .dump 文件恢复（推荐，速度快）
pg_restore -h 127.0.0.1 -U postgres -d matmatch -v matmatch_backup_20251009.dump

# 方法2: 从 .sql 文件恢复
psql -h 127.0.0.1 -U postgres -d matmatch -f matmatch_backup_20251009.sql
```

#### 4.3 验证数据

```bash
psql -h 127.0.0.1 -U postgres -d matmatch

# 验证表和数据
\dt
SELECT COUNT(*) FROM materials_master;
SELECT COUNT(*) FROM synonyms;
SELECT COUNT(*) FROM extraction_rules;
\q
```

---

### Step 5: 修改配置文件（IP地址）

#### 5.1 后端配置

**文件1: `backend/core/config.py`**

```python
# 修改第71行（如需外网访问）
cors_origins: list = Field(
    default=[
        "http://localhost:3000", 
        "http://127.0.0.1:3000",
        "http://172.16.100.211:3000",  # ✅ 添加新主机IP
    ], 
    description="CORS允许的源"
)
```

**文件2: `backend/api/middleware.py`**

```python
# 修改第173-176行
allowed_origins = [
    "http://localhost:3000",
    "http://localhost:8080",
    "http://127.0.0.1:3000",
    "http://127.0.0.1:8080",
    "http://172.16.100.211:3000",  # ✅ 添加新主机IP
    "http://172.16.100.211:8080",  # ✅ 添加新主机IP（备用端口）
]
```

**文件3: `backend/api/dependencies_auth.py` (如启用IP白名单)**

```python
# 修改第45-47行
IP_WHITELIST = [
    "127.0.0.1",
    "172.16.100.211",  # ✅ 添加新主机IP
    "192.168.1.0/24",  # 如需允许整个局域网
]
```

**文件4: `backend/scripts/启动后端.bat`**

```batch
# 修改第91行（可选，仅本机访问用127.0.0.1，局域网访问用0.0.0.0）
..\venv\Scripts\python.exe -m uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload
```

#### 5.2 前端配置

**文件5: `frontend/vite.config.ts`**

```typescript
// 修改第34行（可选，通常不需要修改）
export default defineConfig({
  server: {
    host: '0.0.0.0',  // ✅ 允许局域网访问
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://172.16.100.211:8000',  // ✅ 如后端在不同机器
        changeOrigin: true
      }
    }
  }
})
```

**文件6: `scripts/启动前端.bat`**

```batch
# 修改第61-62行（提示信息）
echo 📦 本机地址: http://localhost:3000
echo 📦 局域网地址: http://172.16.100.211:3000
```

---

### Step 6: 更新文档

**文件7: `docs/项目配置-当前环境.md`**

```markdown
# 更新第4行
**项目路径**: `D:\develop\python\MatMatch`  （新主机路径）
**主机IP**: `172.16.100.211`

# 更新第60-65行（如有.env文件）
DB_HOST=127.0.0.1  （本机数据库）
# 或
DB_HOST=172.16.100.211  （如数据库在其他机器）
```

---

### Step 7: 启动和验证

#### 7.1 启动后端

```bash
cd D:\develop\python\MatMatch

# 方法1: 使用启动脚本
.\智能启动.bat

# 方法2: 手动启动
cd backend
..\venv\Scripts\python.exe -m uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload
```

**验证后端：**
- 本机访问: http://localhost:8000/docs
- 局域网访问: http://172.16.100.211:8000/docs

#### 7.2 启动前端

```bash
cd frontend
npm run dev
```

**验证前端：**
- 本机访问: http://localhost:3000
- 局域网访问: http://172.16.100.211:3000

#### 7.3 功能测试

```bash
# 1. 健康检查
curl http://172.16.100.211:8000/health

# 2. 测试查询接口
curl -X POST http://172.16.100.211:8000/api/v1/materials/search \
  -H "Content-Type: application/json" \
  -d '{"query": "M16×1.5 螺栓", "limit": 10}'

# 3. 运行单元测试
pytest backend/tests/ -v

# 4. 测试管理后台
# 访问 http://172.16.100.211:3000/admin
# 密码: admin123
```

---

## 🔧 常见问题处理

### 问题1: 端口被占用

```bash
# 检查端口占用
netstat -ano | findstr :8000
netstat -ano | findstr :3000

# 停止占用进程
.\停止服务.bat
```

### 问题2: 数据库连接失败

```bash
# 检查 PostgreSQL 服务
services.msc

# 测试连接
psql -h 127.0.0.1 -U postgres -d matmatch
```

### 问题3: 前端无法访问后端API

**检查CORS配置：**
1. 确认 `backend/core/config.py` 中包含前端地址
2. 确认 `backend/api/middleware.py` 中允许前端源
3. 重启后端服务

### 问题4: 虚拟环境路径问题

```bash
# 如果虚拟环境路径不对，重新创建
cd D:\develop\python\MatMatch
rmdir /s venv
python -m venv venv
.\venv\Scripts\activate
pip install -r backend\requirements.txt
pip install -r database\requirements.txt
```

### 问题5: Oracle连接失败（ETL同步）

```bash
# 测试Oracle连接
python database\test_oracle_connection.py

# 如果网络不通，检查：
ping 192.168.80.90
telnet 192.168.80.90 1521
```

---

## 📊 迁移后验证清单

- [ ] PostgreSQL 数据库已恢复
- [ ] 后端API正常启动 (http://172.16.100.211:8000/docs)
- [ ] 前端界面正常访问 (http://172.16.100.211:3000)
- [ ] 管理后台登录成功
- [ ] 查询功能正常
- [ ] 批量查重功能正常
- [ ] ETL同步功能正常（如需要）
- [ ] 单元测试全部通过

---

## 🔐 安全建议

### 1. 防火墙配置

```bash
# Windows 防火墙规则
# 允许 8000 端口（后端API）
netsh advfirewall firewall add rule name="MatMatch Backend" dir=in action=allow protocol=TCP localport=8000

# 允许 3000 端口（前端）
netsh advfirewall firewall add rule name="MatMatch Frontend" dir=in action=allow protocol=TCP localport=3000

# 允许 5432 端口（PostgreSQL，如需远程访问）
netsh advfirewall firewall add rule name="PostgreSQL" dir=in action=allow protocol=TCP localport=5432
```

### 2. PostgreSQL远程访问配置（可选）

**如果需要远程访问PostgreSQL：**

编辑 `postgresql.conf`:
```conf
listen_addresses = '*'  # 或 '172.16.100.211'
```

编辑 `pg_hba.conf`:
```conf
host    matmatch        postgres        172.16.100.0/24         md5
```

### 3. 生产环境建议

```bash
# 1. 修改数据库密码
ALTER USER postgres WITH PASSWORD 'new_strong_password';

# 2. 更新 backend/.env
DB_PASSWORD=new_strong_password

# 3. 修改管理后台Token
# backend/api/dependencies_auth.py
ADMIN_DEV_TOKEN = "your_production_token_here"

# 4. 关闭调试模式
# backend/api/main.py
# 移除 --reload 参数
```

---

## 📝 迁移检查表

### 数据迁移

- [ ] PostgreSQL 数据库已备份
- [ ] 数据库已成功恢复到新主机
- [ ] 数据完整性验证通过

### 代码迁移

- [ ] 项目代码已复制到新主机
- [ ] Python虚拟环境已创建
- [ ] 所有依赖已安装（backend + database + frontend）

### 配置修改

- [ ] `backend/core/config.py` - CORS origins
- [ ] `backend/api/middleware.py` - allowed_origins
- [ ] `backend/api/dependencies_auth.py` - IP白名单（可选）
- [ ] `backend/启动后端.bat` - host参数
- [ ] `frontend/vite.config.ts` - server.host（可选）
- [ ] `scripts/启动前端.bat` - 提示信息
- [ ] `docs/项目配置-当前环境.md` - 路径和IP

### 功能验证

- [ ] 后端API文档可访问
- [ ] 前端页面正常显示
- [ ] 查询功能测试通过
- [ ] 批量查重功能测试通过
- [ ] 管理后台功能正常
- [ ] ETL同步功能正常（如需要）

---

## 🎯 快速迁移命令汇总

```bash
# ============ 旧主机 ============
# 1. 导出数据库
pg_dump -h 127.0.0.1 -U postgres -d matmatch -F c -b -v -f matmatch_backup.dump

# 2. 打包代码（排除大文件）
# 使用压缩工具打包，排除: venv, node_modules, __pycache__

# ============ 新主机 ============
# 3. 解压代码
# 手动解压到 D:\develop\python\MatMatch

# 4. 创建虚拟环境并安装依赖
cd D:\develop\python\MatMatch
python -m venv venv
.\venv\Scripts\activate
pip install -r backend\requirements.txt
pip install -r database\requirements.txt

# 5. 安装前端依赖
cd frontend
npm install
cd ..

# 6. 恢复数据库
psql -h 127.0.0.1 -U postgres -c "CREATE DATABASE matmatch;"
pg_restore -h 127.0.0.1 -U postgres -d matmatch -v matmatch_backup.dump

# 7. 修改配置文件（参考上文"Step 5"）

# 8. 启动服务
.\智能启动.bat

# 9. 验证功能
# 访问 http://172.16.100.211:8000/docs
# 访问 http://172.16.100.211:3000
```

---

## 📞 支持

如遇到问题，请检查：
1. `.gemini_logs/` 目录下的日志文件
2. `backend/logs/` 目录下的应用日志
3. PostgreSQL 日志

---

**迁移完成时间**: _______  
**验证人**: _______  
**备注**: _______

