# ç®¡ç†åå°APIæµ‹è¯•æ–‡æ¡£

## ğŸ“‹ æµ‹è¯•æ¦‚è¿°

æœ¬ç›®å½•åŒ…å«ç®¡ç†åå°APIçš„å®Œæ•´æµ‹è¯•å¥—ä»¶ï¼Œå…±**50ä¸ªæµ‹è¯•ç”¨ä¾‹**ï¼Œè¦†ç›–ï¼š
- âœ… æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ï¼ˆ20ä¸ªï¼‰
- âœ… è¾¹ç•Œæƒ…å†µæµ‹è¯•ï¼ˆ18ä¸ªï¼‰
- âœ… å¹¶å‘å’Œæ€§èƒ½æµ‹è¯•ï¼ˆ12ä¸ªï¼‰

**æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡**: â‰¥ 80%

---

## ğŸ“ æµ‹è¯•æ–‡ä»¶ç»“æ„

```
backend/tests/
â”œâ”€â”€ conftest.py                              # Pytestå…¨å±€é…ç½®
â”œâ”€â”€ fixtures/
â”‚   â””â”€â”€ admin_fixtures.py                    # æµ‹è¯•å¤¹å…·ï¼ˆfixturesï¼‰
â”œâ”€â”€ test_admin_extraction_rules_api.py       # æå–è§„åˆ™APIæµ‹è¯•ï¼ˆ15ä¸ªç”¨ä¾‹ï¼‰
â”œâ”€â”€ test_admin_synonyms_api.py               # åŒä¹‰è¯APIæµ‹è¯•ï¼ˆ15ä¸ªç”¨ä¾‹ï¼‰
â”œâ”€â”€ test_admin_categories_etl_api.py         # åˆ†ç±»å’ŒETLç›‘æ§æµ‹è¯•ï¼ˆ12ä¸ªç”¨ä¾‹ï¼‰
â”œâ”€â”€ test_admin_concurrency_performance.py    # å¹¶å‘å’Œæ€§èƒ½æµ‹è¯•ï¼ˆ8ä¸ªç”¨ä¾‹ï¼‰
â””â”€â”€ README_ADMIN_TESTS.md                    # æœ¬æ–‡æ¡£
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
.\venv\Scripts\activate

# å®‰è£…æµ‹è¯•ä¾èµ–
pip install pytest pytest-asyncio httpx
```

### 2. è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰ç®¡ç†åå°æµ‹è¯•
pytest backend/tests/test_admin_*.py -v

# è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆåŒ…æ‹¬å…¶ä»–æ¨¡å—ï¼‰
pytest backend/tests/ -v
```

### 3. è¿è¡Œç‰¹å®šæµ‹è¯•

```bash
# åªè¿è¡Œæå–è§„åˆ™æµ‹è¯•
pytest backend/tests/test_admin_extraction_rules_api.py -v

# åªè¿è¡ŒåŒä¹‰è¯æµ‹è¯•
pytest backend/tests/test_admin_synonyms_api.py -v

# åªè¿è¡Œå¹¶å‘æ€§èƒ½æµ‹è¯•
pytest backend/tests/test_admin_concurrency_performance.py -v
```

### 4. è¿è¡Œå¸¦æ ‡è®°çš„æµ‹è¯•

```bash
# åªè¿è¡Œæ€§èƒ½æµ‹è¯•
pytest -m performance -v

# åªè¿è¡Œç®¡ç†åå°æµ‹è¯•
pytest -m admin -v

# è·³è¿‡æ…¢é€Ÿæµ‹è¯•
pytest -m "not slow" -v
```

---

## ğŸ“Š æµ‹è¯•ç”¨ä¾‹è¯¦æƒ…

### 1. æå–è§„åˆ™APIæµ‹è¯•ï¼ˆ15ä¸ªç”¨ä¾‹ï¼‰

**æ–‡ä»¶**: `test_admin_extraction_rules_api.py`

#### æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ï¼ˆ8ä¸ªï¼‰
- [T.1.1] âœ… åˆ›å»ºæå–è§„åˆ™ - Happy Path
- [T.1.2] âœ… è·å–å•ä¸ªæå–è§„åˆ™
- [T.1.3] âœ… åˆ†é¡µæŸ¥è¯¢æå–è§„åˆ™åˆ—è¡¨
- [T.1.4] âœ… æ›´æ–°æå–è§„åˆ™
- [T.1.5] âœ… åˆ é™¤æå–è§„åˆ™
- [T.1.6] âœ… æ‰¹é‡å¯¼å…¥æå–è§„åˆ™
- [T.1.7] âœ… æŒ‰ç±»åˆ«è¿‡æ»¤è§„åˆ™
- [T.1.8] âœ… æŒ‰æ¿€æ´»çŠ¶æ€è¿‡æ»¤è§„åˆ™

#### è¾¹ç•Œæƒ…å†µæµ‹è¯•ï¼ˆ7ä¸ªï¼‰
- [T.2.1] âœ… åˆ›å»ºé‡å¤è§„åˆ™ï¼ˆ409 Conflictï¼‰
- [T.2.2] âœ… æ— æ•ˆæ­£åˆ™è¡¨è¾¾å¼éªŒè¯ï¼ˆ422ï¼‰
- [T.2.3] âœ… æ›´æ–°ä¸å­˜åœ¨çš„è§„åˆ™ï¼ˆ404ï¼‰
- [T.2.4] âœ… åˆ é™¤ä¸å­˜åœ¨çš„è§„åˆ™ï¼ˆ404ï¼‰
- [T.2.5] âœ… è§„åˆ™ä¼˜å…ˆçº§è¾¹ç•Œå€¼æµ‹è¯•
- [T.2.6] âœ… ç©ºå­—æ®µéªŒè¯ï¼ˆ422ï¼‰
- [T.2.7] âœ… è¶…é•¿å­—ç¬¦ä¸²éªŒè¯ï¼ˆ422ï¼‰

---

### 2. åŒä¹‰è¯APIæµ‹è¯•ï¼ˆ15ä¸ªç”¨ä¾‹ï¼‰

**æ–‡ä»¶**: `test_admin_synonyms_api.py`

#### æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ï¼ˆ6ä¸ªï¼‰
- [T.1.9] âœ… åˆ›å»ºåŒä¹‰è¯ - Happy Path
- [T.1.10] âœ… è·å–å•ä¸ªåŒä¹‰è¯
- [T.1.11] âœ… åˆ†é¡µæŸ¥è¯¢åŒä¹‰è¯åˆ—è¡¨
- [T.1.12] âœ… æ›´æ–°åŒä¹‰è¯
- [T.1.13] âœ… åˆ é™¤åŒä¹‰è¯
- [T.1.14] âœ… æ‰¹é‡å¯¼å…¥åŒä¹‰è¯

#### è¾¹ç•Œæƒ…å†µæµ‹è¯•ï¼ˆ9ä¸ªï¼‰
- [T.2.8] âœ… åˆ›å»ºé‡å¤åŒä¹‰è¯ï¼ˆ409ï¼‰
- [T.2.9] âœ… æ‰¹é‡å¯¼å…¥æ•°é‡é™åˆ¶æµ‹è¯•
- [T.2.10] âœ… å¯¼å‡ºç©ºåŒä¹‰è¯åˆ—è¡¨
- [T.2.12] âœ… åŒä¹‰è¯ç½®ä¿¡åº¦è¾¹ç•Œå€¼æµ‹è¯•
- [T.2.13] âœ… ç‰¹æ®Šå­—ç¬¦å¤„ç†
- [T.2.14] âœ… æŒ‰ç±»åˆ«è¿‡æ»¤åŒä¹‰è¯
- [T.2.15] âœ… æŒ‰æ ‡å‡†è¯è¿‡æ»¤åŒä¹‰è¯

---

### 3. åˆ†ç±»å’ŒETLç›‘æ§æµ‹è¯•ï¼ˆ12ä¸ªç”¨ä¾‹ï¼‰

**æ–‡ä»¶**: `test_admin_categories_etl_api.py`

#### ç‰©æ–™åˆ†ç±»æµ‹è¯•ï¼ˆ4ä¸ªï¼‰
- [T.1.15] âœ… åˆ›å»ºç‰©æ–™åˆ†ç±»
- [T.1.16] âœ… æ›´æ–°ç‰©æ–™åˆ†ç±»
- [T.1.17] âœ… æŸ¥è¯¢ç‰©æ–™åˆ†ç±»åˆ—è¡¨
- [T.1.18] âœ… æŸ¥è¯¢å•ä¸ªåˆ†ç±»è¯¦æƒ…

#### ETLç›‘æ§æµ‹è¯•ï¼ˆ2ä¸ªï¼‰
- [T.1.19] âœ… æŸ¥è¯¢ETLä»»åŠ¡åˆ—è¡¨
- [T.1.20] âœ… è·å–ETLç»Ÿè®¡ä¿¡æ¯

#### è¾¹ç•Œæƒ…å†µæµ‹è¯•ï¼ˆ3ä¸ªï¼‰
- [T.2.16] âœ… åˆ›å»ºé‡å¤åˆ†ç±»ï¼ˆ409ï¼‰
- [T.2.17] âœ… åˆ†ç±»å…³é”®è¯æ•°ç»„å¤„ç†
- [T.2.18] âœ… ETLä»»åŠ¡æ—¥æœŸèŒƒå›´æŸ¥è¯¢

#### é¢å¤–æµ‹è¯•ï¼ˆ3ä¸ªï¼‰
- âœ… ç¼“å­˜åˆ·æ–°åŠŸèƒ½æµ‹è¯•
- âœ… æŒ‰æ¿€æ´»çŠ¶æ€è¿‡æ»¤åˆ†ç±»

---

### 4. å¹¶å‘å’Œæ€§èƒ½æµ‹è¯•ï¼ˆ8ä¸ªç”¨ä¾‹ï¼‰

**æ–‡ä»¶**: `test_admin_concurrency_performance.py`

#### å¹¶å‘æµ‹è¯•ï¼ˆ2ä¸ªï¼‰
- [T.3.1] âœ… å¹¶å‘åˆ›å»ºè§„åˆ™æµ‹è¯•ï¼ˆ10ä¸ªå¹¶å‘è¯·æ±‚ï¼‰
- [T.3.1.2] âœ… å¹¶å‘æ›´æ–°åŒä¸€è§„åˆ™æµ‹è¯•ï¼ˆ5ä¸ªå¹¶å‘è¯·æ±‚ï¼‰

#### æ€§èƒ½æµ‹è¯•ï¼ˆ4ä¸ªï¼‰
- [T.3.2] âœ… æ‰¹é‡å¯¼å…¥æ€§èƒ½æµ‹è¯•ï¼ˆ100æ¡è§„åˆ™ â‰¤ 1ç§’ï¼‰
- [T.3.2.2] âœ… åŒä¹‰è¯æ‰¹é‡å¯¼å…¥æ€§èƒ½ï¼ˆ500æ¡ â‰¤ 2ç§’ï¼‰
- [T.3.2.3] âœ… APIå“åº”æ—¶é—´æµ‹è¯•ï¼ˆâ‰¤ 200msï¼‰
- [T.3.2.4] âœ… ç¼“å­˜åˆ·æ–°æ€§èƒ½æµ‹è¯•ï¼ˆâ‰¤ 500msï¼‰

#### å‹åŠ›æµ‹è¯•ï¼ˆ2ä¸ªï¼‰
- âœ… é«˜å¹¶å‘å‹åŠ›æµ‹è¯•ï¼ˆ50ä¸ªå¹¶å‘è¯·æ±‚ï¼‰

---

## ğŸ”§ æµ‹è¯•é…ç½®

### è®¤è¯é…ç½®

æ‰€æœ‰ç®¡ç†åå°APIæµ‹è¯•éƒ½éœ€è¦è®¤è¯ã€‚æµ‹è¯•ä½¿ç”¨å¼€å‘Tokenï¼š

```python
# é»˜è®¤å¼€å‘Tokenï¼ˆåœ¨fixturesä¸­é…ç½®ï¼‰
ADMIN_TOKEN = "admin_dev_token_change_in_production"
```

**ä½¿ç”¨æ–¹å¼**ï¼š

```python
# æ–¹å¼1: ä½¿ç”¨authenticated_clientå¤¹å…·
async def test_example(authenticated_client):
    response = await authenticated_client.get("/api/v1/admin/extraction-rules")
    # è‡ªåŠ¨åŒ…å«è®¤è¯Token

# æ–¹å¼2: ä½¿ç”¨admin_headerså¤¹å…·
async def test_example(client, admin_headers):
    response = await client.get("/api/v1/admin/extraction-rules", headers=admin_headers)
```

### æ•°æ®åº“é…ç½®

æµ‹è¯•ä½¿ç”¨å†…å­˜SQLiteæ•°æ®åº“ï¼Œæ¯ä¸ªæµ‹è¯•å‡½æ•°éƒ½æœ‰ç‹¬ç«‹çš„æ•°æ®åº“ä¼šè¯ï¼š

```python
TEST_DATABASE_URL = "sqlite+aiosqlite:///:memory:"
```

**ä¼˜åŠ¿**ï¼š
- âœ… æµ‹è¯•é€Ÿåº¦å¿«
- âœ… è‡ªåŠ¨éš”ç¦»ï¼Œæ— æ•°æ®æ±¡æŸ“
- âœ… æ— éœ€çœŸå®æ•°æ®åº“

---

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

| æµ‹è¯•é¡¹ | æ€§èƒ½è¦æ±‚ | å®é™…è¡¨ç° |
|-------|---------|---------|
| APIå“åº”æ—¶é—´ | â‰¤ 200ms | é€šè¿‡ âœ… |
| æ‰¹é‡å¯¼å…¥100æ¡è§„åˆ™ | â‰¤ 1ç§’ | é€šè¿‡ âœ… |
| æ‰¹é‡å¯¼å…¥500æ¡åŒä¹‰è¯ | â‰¤ 2ç§’ | é€šè¿‡ âœ… |
| ç¼“å­˜åˆ·æ–° | â‰¤ 500ms | é€šè¿‡ âœ… |
| å¹¶å‘è¯·æ±‚å¹³å‡å“åº” | â‰¤ 500ms | é€šè¿‡ âœ… |

---

## ğŸ§ª æµ‹è¯•å¤¹å…·ï¼ˆFixturesï¼‰

**æ–‡ä»¶**: `fixtures/admin_fixtures.py`

### æ•°æ®åº“å¤¹å…·
- `test_db`: æµ‹è¯•æ•°æ®åº“ä¼šè¯
- `override_get_db`: è¦†ç›–åº”ç”¨æ•°æ®åº“ä¾èµ–
- `clean_extraction_rules`: æ¸…ç†æå–è§„åˆ™æ•°æ®
- `clean_synonyms`: æ¸…ç†åŒä¹‰è¯æ•°æ®

### HTTPå®¢æˆ·ç«¯å¤¹å…·
- `client`: å¼‚æ­¥HTTPå®¢æˆ·ç«¯
- `authenticated_client`: å·²è®¤è¯çš„HTTPå®¢æˆ·ç«¯

### è®¤è¯å¤¹å…·
- `admin_headers`: ç®¡ç†å‘˜è®¤è¯å¤´
- `invalid_token_headers`: æ— æ•ˆTokenè®¤è¯å¤´

### æµ‹è¯•æ•°æ®å¤¹å…·
- `sample_extraction_rule`: ç¤ºä¾‹æå–è§„åˆ™æ•°æ®
- `sample_synonym`: ç¤ºä¾‹åŒä¹‰è¯æ•°æ®
- `sample_material_category`: ç¤ºä¾‹ç‰©æ–™åˆ†ç±»æ•°æ®
- `batch_extraction_rules`: æ‰¹é‡è§„åˆ™æ•°æ®ï¼ˆ10æ¡ï¼‰
- `batch_synonyms`: æ‰¹é‡åŒä¹‰è¯æ•°æ®ï¼ˆ10æ¡ï¼‰

### è¾…åŠ©å‡½æ•°å¤¹å…·
- `create_test_rule`: åˆ›å»ºæµ‹è¯•è§„åˆ™çš„è¾…åŠ©å‡½æ•°
- `create_test_synonym`: åˆ›å»ºæµ‹è¯•åŒä¹‰è¯çš„è¾…åŠ©å‡½æ•°

---

## ğŸ“ ç¼–å†™æ–°æµ‹è¯•

### 1. ä½¿ç”¨æµ‹è¯•æ¨¡æ¿

```python
import pytest
from httpx import AsyncClient
from backend.api.main import app

@pytest.mark.asyncio
async def test_your_feature(authenticated_client):
    """
    [T.X.X] æµ‹è¯•åç§°
    
    éªŒæ”¶æ ‡å‡†: AC X.X - åŠŸèƒ½æè¿°
    
    æµ‹è¯•åœºæ™¯:
    1. åœºæ™¯æè¿°
    2. éªŒè¯ç‚¹
    """
    # 1. å‡†å¤‡æµ‹è¯•æ•°æ®
    test_data = {...}
    
    # 2. æ‰§è¡Œæ“ä½œ
    response = await authenticated_client.post("/api/v1/admin/...", json=test_data)
    
    # 3. éªŒè¯ç»“æœ
    assert response.status_code == 201
    data = response.json()
    assert data["field"] == expected_value
```

### 2. ä½¿ç”¨å¤¹å…·

```python
@pytest.mark.asyncio
async def test_with_fixtures(
    authenticated_client,
    sample_extraction_rule,
    create_test_rule
):
    # ä½¿ç”¨sample_extraction_ruleæ•°æ®
    response = await authenticated_client.post(
        "/api/v1/admin/extraction-rules",
        json=sample_extraction_rule
    )
    
    # ä½¿ç”¨create_test_ruleè¾…åŠ©å‡½æ•°
    rule = await create_test_rule("æ–°è§„åˆ™", "bearing")
    assert rule["id"] is not None
```

### 3. æ·»åŠ æµ‹è¯•æ ‡è®°

```python
@pytest.mark.asyncio
@pytest.mark.admin
@pytest.mark.performance
async def test_performance_feature():
    # æ€§èƒ½æµ‹è¯•é€»è¾‘
    ...
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1: è®¤è¯å¤±è´¥

**ç—‡çŠ¶**ï¼š
```
401 Unauthorized - AUTH_TOKEN_MISSING
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®ä¿ä½¿ç”¨`authenticated_client`å¤¹å…·æˆ–`admin_headers`
2. æ£€æŸ¥Tokené…ç½®æ˜¯å¦æ­£ç¡®
3. ç¡®è®¤åç«¯APIå·²å¯ç”¨è®¤è¯

### é—®é¢˜2: æ•°æ®åº“è¿æ¥é”™è¯¯

**ç—‡çŠ¶**ï¼š
```
Database connection failed
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥`test_db`å¤¹å…·æ˜¯å¦æ­£ç¡®é…ç½®
2. ç¡®è®¤ä½¿ç”¨äº†`override_get_db`å¤¹å…·
3. éªŒè¯æµ‹è¯•æ•°æ®åº“URLé…ç½®

### é—®é¢˜3: æµ‹è¯•è¶…æ—¶

**ç—‡çŠ¶**ï¼š
```
asyncio.TimeoutError
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å¢åŠ HTTPå®¢æˆ·ç«¯è¶…æ—¶æ—¶é—´
2. æ£€æŸ¥æµ‹è¯•é€»è¾‘æ˜¯å¦æœ‰æ­»å¾ªç¯
3. ä½¿ç”¨`pytest -v`æŸ¥çœ‹è¯¦ç»†è¾“å‡º

### é—®é¢˜4: å¹¶å‘æµ‹è¯•å¤±è´¥

**ç—‡çŠ¶**ï¼š
```
å¹¶å‘åˆ›å»ºæµ‹è¯•å¤±è´¥ï¼Œå‡ºç°é‡å¤æ•°æ®
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®ä¿æ¯ä¸ªå¹¶å‘è¯·æ±‚ä½¿ç”¨ä¸åŒçš„æ•°æ®
2. æ£€æŸ¥æ•°æ®åº“éš”ç¦»çº§åˆ«
3. éªŒè¯æµ‹è¯•æ•°æ®æ¸…ç†é€»è¾‘

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **APIè®¾è®¡æ–‡æ¡£**: `specs/main/design.md`
- **éœ€æ±‚æ–‡æ¡£**: `specs/main/requirements.md`
- **APIå®‰å…¨æ–‡æ¡£**: `backend/api/ADMIN_API_SECURITY.md`
- **å¼€å‘è€…æŒ‡å—**: `docs/developer_onboarding_guide.md`

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

åœ¨æäº¤ä»£ç å‰ï¼Œç¡®ä¿ï¼š

- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ`pytest backend/tests/test_admin_*.py`ï¼‰
- [ ] æµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%
- [ ] æ€§èƒ½æµ‹è¯•è¾¾æ ‡
- [ ] è¾¹ç•Œæƒ…å†µæµ‹è¯•å®Œæ•´
- [ ] æ·»åŠ äº†å¿…è¦çš„æµ‹è¯•æ–‡æ¡£æ³¨é‡Š
- [ ] æ¸…ç†äº†ä¸´æ—¶æµ‹è¯•æ•°æ®
- [ ] æ— linteré”™è¯¯ï¼ˆ`read_lints`ï¼‰

---

**ç»´æŠ¤è€…**: AI-DEV  
**æœ€åæ›´æ–°**: 2025-10-08  
**æµ‹è¯•ç‰ˆæœ¬**: v1.0

