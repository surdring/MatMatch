
---

### **智能物料查重工具 - 技术架构设计文档**

版本: 3.0 (V2需求同步版)
日期: 2025年10月2日
架构师: 郑学恩 (信息自动化部)


#### **1. 文档概述**

**1.1. 项目目标**
本文档为“智能物料查重工具”项目提供一个全面的技术架构设计。该工具旨在通过标准化、结构化的数据处理和高效的模糊匹配算法，解决因物料描述不规范导致的重复编码和库存积压问题。它将提供一个用户友好的Web界面，供用户输入物料描述，并返回一个根据相似度排序的、已存在物料的列表。

**1.2. 核心技术选型**
*   **前端:** Vue.js (v3)
*   **后端:** FastAPI (Python)
*   **数据库:** PostgreSQL (v12+)

**1.3. 读者对象**
项目开发人员、技术经理、运维工程师。

---

#### **2. 设计原则与核心思想**

*   **前后端分离:** 采用现代Web架构，将用户界面（前端）与业务逻辑（后端）彻底解耦，提高开发效率和灵活性。
*   **职责分离:** 将耗时的数据清洗、标准化和结构化工作（ETL）置于离线后台管道中，将高并发的查询服务置于在线API中，确保用户体验的流畅性。
*   **对称处理 (Symmetrical Processing):** 这是实现高精度查重的设计核心。无论是后台ETL管道处理的源数据，还是在线API处理的用户输入，都必须经过**完全相同**的标准化和结构化算法处理，以保证比较基准的一致性。
*   **搜索与展示分离 (Search-Display Segregation):** 在数据库层面，同时存储专为高效搜索而设计的“处理后数据”（如标准化的名称和结构化的属性）和专为用户展示而设计的“原始数据”（如ERP中的原始描述）。查询时使用前者，返回给用户时使用后者。
*   **(新增) 规则与逻辑分离:** 系统的核心解析逻辑（代码）与业务规则（正则表达式、同义词）分离。规则作为数据存储在数据库中 ，使得业务专家可以通过管理界面动态调整，而无需修改和重新部署代码。

---

#### **3. 系统架构总览**

本系统采用经典的三层架构，并增加一个独立的后台数据管道。增加对“系统管理员”角色的支持，使其能通过Web界面管理系统规则。
```
       ┌────────────────────────┐         ┌────────────────────────┐
       │      用户浏览器         │          │   定时任务调度器          │
       │  (Vue.js Single Page   │         │(Cron / Task Scheduler) │
       │      Application)      │         └───────────┬────────────┘
       └─┬───────────────────┬──┘                     │
         │                   │                        │
         │(批量查重)           │(规则管理)               │  ┌──────────────────┐
         │                   │                        │  │      ERP / MES   │
       ┌─▼───────────────────▼─┐         ┌───────────▼──────────┐ │      (数据源)      │
       │                       │         │                      │ │ (DB / Files)     │
       │  后端 API 服务          │         │   数据同步管道          │ │                  │
       │     (FastAPI)          ├─────────┤     (Python Script)      ├─►└──────────────────┘
       │                        │         │                        │
       └────────────┬───────────┘         └────────────────────────┘
                    │
                    │ SQL (via SQLAlchemy)
                    │
       ┌────────────▼───────────┐
       │                        │
       │     数据库              │
       │    (PostgreSQL)        │
       │  + pg_trgm Extension   │
       └────────────────────────┘


```
---

#### **4. 核心处理模块 (Core Processing Module)**

这是实现“对称处理”原则的关键，是一个被后台管道和在线API共同调用的可复用Python模块。此模块的规则和词典从数据库中实时获取。

*   **位置:** `app/processing/transformer.py`
*   **核心函数:** `process_description(raw_description: str, synonym_dict: dict) -> tuple[str, dict]`
*   **功能:** 接收任意物料描述字符串，返回一个标准化的核心名称（用于模糊搜索）和一个结构化的属性字典（用于精确过滤）。
    1.  **获取规则:** 在函数执行开始时，通过db_session从extraction_rules和synonyms表中加载最新的规则和同义词。
    2.  **标准化:** 利用同义词典进行词语替换和归一化。
    3.  **结构化:** 利用正则表达式提取关键属性并存入字典。
    4.  **名称提炼:** 移除已提取的属性部分，生成核心名称。

---

#### **5. 数据层架构 (Database - PostgreSQL)**

数据层是系统的持久化基础，其设计完美支持“搜索与展示分离”原则。

*   **数据库:** **PostgreSQL (v12 或更高版本)**
*   **关键扩展:** **pg_trgm** (必须启用)
*   **核心表设计:**
    ```sql
    -- 存储物料主数据，同时包含展示字段和搜索字段
    CREATE TABLE materials_master (
        id SERIAL PRIMARY KEY,
        erp_code VARCHAR(100) UNIQUE NOT NULL, -- (用于展示) 物料编码
        original_description TEXT,             -- (用于展示) ERP中的原始描述
        normalized_name TEXT,                  -- (用于搜索) 标准化、提炼后的核心名称
        attributes JSONB,                      -- (用于搜索) 存储解析出的结构化属性
        created_at TIMESTAMPTZ DEFAULT NOW(),
        updated_at TIMESTAMPTZ DEFAULT NOW()
    );
    
    -- (新增) 存储属性提取规则
      CREATE TABLE extraction_rules (
          id SERIAL PRIMARY KEY,
          category VARCHAR(50) NOT NULL, -- 适用的物料类别，如 'bolts', 'bearings'
          attribute_name VARCHAR(50) NOT NULL, -- 属性英文名，如 'spec'
          regex_pattern TEXT NOT NULL, -- 用于提取的正则表达式
          is_active BOOLEAN DEFAULT TRUE,
          created_at TIMESTAMPTZ DEFAULT NOW()
      );


      -- (新增) 存储同义词
      CREATE TABLE synonyms (
          id SERIAL PRIMARY KEY,
          term VARCHAR(100) UNIQUE NOT NULL, -- 待替换的词
          standard_term VARCHAR(100) NOT NULL, -- 标准词
          is_active BOOLEAN DEFAULT TRUE,
          created_at TIMESTAMPTZ DEFAULT NOW()
      );

    ```
*   **索引策略 (性能关键):**
    *   **模糊搜索索引:** `CREATE INDEX idx_materials_name_gin ON materials_master USING gin (normalized_name gin_trgm_ops);`
    *   **属性查询索引:** `CREATE INDEX idx_materials_attributes_gin ON materials_master USING gin (attributes);`
    *   为新表的查询字段（如extraction_rules.category）添加标准索引。
---

#### **6. 数据管道 (Data Pipeline - 离线ETL)**

这是一个独立的、后台定时运行的进程，负责将原始数据从源系统（如ERP）处理后，安全、可靠地加载到数据层。

*   **技术:** 纯 **Python** 脚本，由 **Cron** 或 **Windows 任务计划程序** 调度。
*   **核心流程:**
    1.  **Extract:** 从ERP系统安全地抽取物料数据。
    2.  **Transform:**
        *   从PostgreSQL的extraction_rules和synonyms表中加载当前所有激活的规则和同义词。
        *   对每一条抽取的原始数据，**调用核心处理模块 `process_description()`**，并传入数据库会话。。
    3.  **Load:** 将`erp_code`, `original_description`, `normalized_name`, `attributes` 等所有字段一同以事务方式写入PostgreSQL的 `materials_master` 表。

**6.1. 安全与稳定性保障 (Security & Stability Assurance)**

为从根本上杜绝数据管道对核心生产系统（ERP/MES）造成任何风险，本设计采用多层防御体系，确保数据流的绝对单向性和操作的安全性。

*   **第一层防御 - 权限锁定 (The Hard Lock):**
    *   **原则:** 数据管道连接源系统的数据库账户，**必须**配置为**只读（Read-only）权限**。
    *   **实施:** 该账户仅被授予对所需表的 `SELECT` 权限，严禁授予 `UPDATE`, `INSERT`, `DELETE` 等任何写权限。
    *   **效果:** 这是最根本的物理保障。任何意外或恶意的写操作尝试，都将被源数据库直接拒绝，从而彻底杜绝“反向操作”的风险。

*   **第二层防御 - 代码逻辑单向性 (The Logic Barrier):**
    *   **原则:** 代码层面严格分离读写操作。
    *   **实施:** 脚本中将明确区分“源连接”（只读）和“目标连接”（读写）。所有代码逻辑遵循“从源读取，向目标写入”的单向流程，不存在任何向源系统写回的逻辑。

*   **第三层防御 - 目标数据库事务保护 (The Safety Net):**
    *   **原则:** 对目标PostgreSQL数据库的所有写入操作都必须是事务性的。
    *   **实施:** 数据加载将以批次（Batch）的形式在事务中执行。只有当一个完整批次的所有数据都成功处理并准备好写入时，才会提交（Commit）事务。任何中途失败都会导致整个事务回滚（Rollback）。
    *   **效果:** 保证了目标数据库的数据一致性，杜绝了因处理中断而产生“半成品”或脏数据的可能。
---

#### **7. 后端架构 (Backend - FastAPI)**

后端负责提供RESTful API，是连接前端和数据层的桥梁。

##### 7.1 批量查重API
*   **框架:** **FastAPI** + **SQLAlchemy (异步)**
*   **API Endpoint:** `POST /api/v1/materials/batch_search_from_file`
*   **核心处理流程:**
    1.  **接收请求:** 接收并用pandas解析上传的Excel文件。
    2.  **对称处理:** 对文件中的每一行，调用核心处理模块 `process_description()`（该模块会自行从数据库获取规则），得到query_name和query_attributes。
    3.  **构造查询:** 基于处理后的 `query_name` 和 `query_attributes` 构造一个混合型SQL查询。
    4.  **执行并返回:** 执行查询，并将包含**原始描述** (`original_description`) 和物料编码 (`erp_code`) 的结果集返回给前端。

##### 7.2 (新增) 规则与词典管理API
 模块:* app/api/v1/rules.py, app/api/v1/synonyms.py
 API Endpoints:*
  *   GET /api/v1/rules: 获取所有提取规则。
  *   POST /api/v1/rules: 新增一条提取规则。
  *   PUT /api/v1/rules/{rule_id}: 更新一条指定的规则。
  *   DELETE /api/v1/rules/{rule_id}: 删除一条指定的规则。
  *   GET /api/v1/synonyms: 获取所有同义词条目。
  *   POST /api/v1/synonyms: 新增一个同义词条目。
  *   PUT /api/v1/synonyms/{synonym_id}: 更新一个指定的条目。
  *   DELETE /api/v1/synonyms/{synonym_id}: 删除一个指定的条目。
---

#### **8. 前端架构 (Frontend - Vue.js)**

前端是一个单页面应用 (SPA)，负责所有用户交互和视图渲染。

*   **框架:** **Vue 3** + **Vite**
*   **UI组件库:** **Element Plus**
*   **HTTP客户端:** **Axios**
##### 8.1 批量查重模块
 核心交互流程:*
  1.  用户在MaterialUpload组件中上传Excel文件。
  2.  materialStore的action被调用，向后端的/api/v1/materials/batch_search_from_file接口发 送POST请求。
  3.  ResultsDisplay组件渲染返回的批量结果。

##### 8.2 (新增) 规则管理模块
 路由与视图:*
  *   新增路由 /management，指向 RuleManagementView.vue。 
 核心组件:*
     `RuleManagementView.vue`:*页面容器，包含两个主要的管理表格。
     `RulesTable.vue`:*使用el-table展示extraction_rules列表，并包含“新增”、“编辑”、“删除”按钮。
     `SynonymsTable.vue`:*使用el-table展示synonyms列表，并包含“新增”、“编辑”、“删除”按钮。
     `RuleEditModal.vue`:* 一个基于el-dialog和el-form的弹窗组件，用于新增或编辑一条规则。
 状态管理 (Pinia):*
  *   创建一个新的ruleStore，包含rules和synonyms两个state，以及对应的CRUD actions（如fetchRules, createRule等）。

---

#### **9. 部署方案 (Deployment)**

*   **容器化:** 使用 **Docker** 将前端 (Nginx)、后端 (FastAPI) 和数据库 (PostgreSQL) 分别打包成镜像。
*   **本地部署:** 使用 **Docker Compose** 编写 `docker-compose.yml` 文件，实现一键编排和启动所有服务。
*   **反向代理:** 在 Docker Compose 中配置 Nginx，作为前端静态文件的服务器和后端 API 的反向代理，解决跨域问题并统一访问入口。