# 通用物料同义词词典构建操作指南

## 概述
本文档详细说明如何使用Python脚本构建和优化通用物料同义词词典，支持全品类物料的同义词识别和标准化处理。系统支持基于示例数据和真实数据库数据的两种构建模式，可处理包括但不限于轴承、螺栓、阀门、管件、电气元件等各类工业物料。

## 文件说明

### 核心脚本文件
- `build_synonym_dictionary.py` - 完整版构建器（支持数据库连接）
- `simple_synonym_builder.py` - 简化版构建器（仅使用标准库）
- `synonym_builder.py` - 同义词构建模块

### 配置文件
- `oracle_config.py` - Oracle数据库连接配置
- `requirements.txt` - Python依赖包列表

### 输出文件
- `synonym_dictionary_YYYYMMDD_HHMMSS.json` - JSON格式词典
- `synonym_dictionary_YYYYMMDD_HHMMSS.txt` - 文本格式词典

## 环境准备

### 1. 检查Python环境
```bash
python --version
```

### 2. 安装依赖（可选）
如果网络连接正常，安装完整依赖：
```bash
pip install -r requirements.txt
```

依赖包包括：
- `cx_Oracle==8.3.0` - Oracle数据库连接
- `pandas>=1.5.0` - 数据处理
- `numpy>=1.21.0` - 数值计算
- `python-dotenv>=0.19.0` - 环境配置

## 操作流程

### 模式1：使用示例数据构建（网络受限时）

#### 步骤1：运行简化版构建器
```bash
python simple_synonym_builder.py
```

#### 步骤2：查看构建结果
```bash
# 查看生成的词典文件
dir synonym_dictionary_*.json

# 查看词典内容
type synonym_dictionary_YYYYMMDD_HHMMSS.json
```

#### 步骤3：验证词典功能
脚本会自动进行功能测试，包括：
- 同义词查询测试
- 文本标准化测试
- 统计信息显示

### 模式2：使用真实数据库数据构建

#### 步骤1：配置数据库连接
编辑 `oracle_config.py` 文件，设置正确的连接信息：
```python
ORACLE_CONFIG = {
    'user': 'your_username',
    'password': 'your_password', 
    'dsn': 'your_dsn',
    'min': 1,
    'max': 5,
    'increment': 1
}
```

#### 步骤2：运行完整版构建器
```bash
python build_synonym_dictionary.py
```

#### 步骤3：数据质量检查
构建器会自动进行：
- 数据库连接测试
- 数据抽取验证
- 同义词模式分析
- 词典质量统计

## 词典结构说明

### JSON格式词典
```json
{
  "SKF深沟球轴承": [
    "斯凯孚深沟球轴承",
    "SKF深沟球", 
    "SKF深沟球軸承"
  ],
  "6201ZZ": [
    "6201-2RS",
    "6201-ZZZ"
  ],
  "不锈钢球阀": [
    "SS球阀",
    "304球阀",
    "不鏽鋼球閥"
  ],
  "M10x30内六角螺栓": [
    "M10*30内六角螺钉",
    "M10×30杯头螺栓",
    "10*30内六角"
  ],
  "西门子接触器": [
    "SIEMENS接触器",
    "西门子交流接触器",
    "Siemens接触器"
  ]
}
```

### 词典内容分类
1. **品牌同义词**：
   - 轴承类：SKF ↔ 斯凯孚，NSK ↔ 恩斯克，FAG ↔ 舍弗勒
   - 电气类：Siemens ↔ 西门子，ABB ↔ 阿西布朗
   - 阀门类：Swagelok ↔ 世伟洛克，Parker ↔ 派克
2. **型号变体**：
   - 轴承：6201ZZ ↔ 6201-2RS ↔ 6201-ZZZ
   - 螺栓：M10x30 ↔ M10*30 ↔ M10×30
   - 阀门：DN50 ↔ Φ50 ↔ 50mm
3. **规格表示**：
   - 尺寸：M10x30 ↔ M10*30 ↔ M10×30
   - 管径：DN50 ↔ Φ50 ↔ 50A
   - 压力：1.6MPa ↔ 16bar ↔ 16公斤
4. **材质同义词**：
   - 不锈钢 ↔ SS ↔ 304 ↔ 316L
   - 碳钢 ↔ CS ↔ A105 ↔ 20#
   - 铜 ↔ Cu ↔ 黄铜 ↔ 青铜
5. **简繁转换**：轴承 ↔ 軸承，阀门 ↔ 閥門，螺栓 ↔ 螺栓
6. **单位同义词**：个 ↔ 只 ↔ 件 ↔ 套

## 高级功能

### 1. 自定义同义词规则
编辑 `synonym_builder.py` 中的识别模式，支持多物料类别：
```python
# 通用物料同义词识别模式
patterns = [
    # 尺寸规格变体
    (r'(\w+)-(\w+)', r'\1\2'),           # 连字符变体: M10-30 → M1030
    (r'(\w+)\*(\w+)', r'\1x\2'),         # 乘号变体: M10*30 → M10x30
    (r'(\w+)×(\w+)', r'\1x\2'),          # 乘号变体: M10×30 → M10x30
    
    # 管径规格变体
    (r'DN(\d+)', r'Φ\1'),               # DN50 → Φ50
    (r'(\d+)A', r'DN\1'),               # 50A → DN50
    (r'(\d+)mm', r'\1'),                # 50mm → 50
    
    # 压力规格变体
    (r'(\d+\.?\d*)MPa', r'\1兆帕'),      # 1.6MPa → 1.6兆帕
    (r'(\d+)bar', r'\1巴'),             # 16bar → 16巴
    (r'(\d+)公斤', r'\1kg'),            # 16公斤 → 16kg
    
    # 材质标准化
    (r'不锈钢|SS|stainless', '304'),     # 不锈钢标准化
    (r'碳钢|CS|carbon', 'A105'),        # 碳钢标准化
    (r'铜|Cu|copper', '黄铜'),          # 铜材标准化
    
    # 品牌标准化
    (r'斯凯孚|SKF', 'SKF'),             # SKF品牌统一
    (r'西门子|SIEMENS|Siemens', '西门子'), # 西门子品牌统一
    (r'施耐德|Schneider', '施耐德'),      # 施耐德品牌统一
]
```

### 2. 分类别词典构建
支持按物料类别分别构建和维护词典：
```python
from synonym_builder import SynonymBuilder

# 分类别构建词典
categories = {
    'bearing': ['深沟球轴承', '圆锥滚子轴承', '推力球轴承'],
    'bolt': ['内六角螺栓', '外六角螺栓', '平头螺钉'],
    'valve': ['球阀', '闸阀', '截止阀', '蝶阀'],
    'pipe': ['无缝钢管', '焊接钢管', '不锈钢管'],
    'electrical': ['接触器', '继电器', '断路器', '变频器']
}

builder = SynonymBuilder()
for category, materials in categories.items():
    # 为每个类别构建专门的词典
    category_dict = builder.build_category_dictionary(materials, category)
    builder.save_dictionary(f'synonym_dict_{category}.json')

# 合并所有类别词典
builder.merge_dictionaries(['synonym_dict_bearing.json', 
                           'synonym_dict_bolt.json',
                           'synonym_dict_valve.json',
                           'synonym_dict_pipe.json',
                           'synonym_dict_electrical.json'])
builder.save_dictionary('universal_synonym_dictionary.json')
```

### 3. 词典合并与更新
```python
from synonym_builder import SynonymBuilder

# 加载现有词典
builder = SynonymBuilder()
builder.load_dictionary('existing_dictionary.json')

# 基于新数据更新词典
new_data = [
    "西门子3TF接触器",
    "ABB变频器ACS550", 
    "Parker球阀",
    "Swagelok卡套接头"
]
builder.build_from_data(new_data)

# 保存更新后的词典
builder.save_dictionary('updated_dictionary.json')
```

### 4. 批量处理与性能优化
```python
# 批量标准化文本（支持多类别物料）
def batch_standardize(texts, category_filter=None):
    builder = SynonymBuilder()
    builder.load_dictionary('universal_synonym_dictionary.json')
    
    standardized = []
    for text in texts:
        # 可选择性地应用类别特定的规则
        if category_filter:
            result = builder.standardize_text(text, category=category_filter)
        else:
            result = builder.standardize_text(text)
        standardized.append(result)
    
    return standardized

# 多线程批量处理（适用于大数据量）
import concurrent.futures
from typing import List, Dict

def parallel_standardize(texts: List[str], max_workers: int = 4) -> List[Dict]:
    """
    并行处理大批量物料描述标准化
    
    Args:
        texts: 待处理的物料描述列表
        max_workers: 最大工作线程数
        
    Returns:
        标准化结果列表
    """
    builder = SynonymBuilder()
    builder.load_dictionary('universal_synonym_dictionary.json')
    
    def process_chunk(chunk):
        return [builder.standardize_text(text) for text in chunk]
    
    # 分块处理
    chunk_size = len(texts) // max_workers
    chunks = [texts[i:i+chunk_size] for i in range(0, len(texts), chunk_size)]
    
    results = []
    with concurrent.futures.ThreadPoolExecutor(max_workers=max_workers) as executor:
        future_to_chunk = {executor.submit(process_chunk, chunk): chunk for chunk in chunks}
        for future in concurrent.futures.as_completed(future_to_chunk):
            results.extend(future.result())
    
    return results
```

## 故障排除

### 常见问题1：数据库连接失败
**症状**：`cx_Oracle.DatabaseError: ORA-12154`
**解决方案**：
1. 检查 `oracle_config.py` 中的DSN配置
2. 验证网络连接和防火墙设置
3. 确认Oracle客户端安装正确

### 常见问题2：依赖安装失败  
**症状**：`ModuleNotFoundError: No module named 'pandas'`
**解决方案**：
1. 使用简化版构建器：`python simple_synonym_builder.py`
2. 或手动安装核心依赖：`pip install pandas numpy`

### 常见问题3：内存不足
**症状**：处理大量数据时出现内存错误
**解决方案**：
1. 分批处理数据
2. 使用生成器而非列表
3. 增加系统内存或使用64位Python

## 最佳实践

### 1. 定期更新词典
- 每月基于新数据重新构建词典
- 保留历史版本便于回滚
- 记录每次更新的变更内容

### 2. 质量监控
- 设置同义词映射的质量阈值
- 监控标准化后的文本质量
- 定期人工审核关键同义词

### 3. 性能优化
- 对大型词典使用缓存机制
- 预编译正则表达式
- 使用多线程处理批量数据

## 集成到查重系统

### 1. 通用物料转换器
```python
from synonym_builder import SynonymBuilder
from typing import Dict, List, Optional

class UniversalMaterialTransformer:
    """通用物料描述转换器 - 支持全品类物料"""
    
    def __init__(self, dictionary_path: str = 'universal_synonym_dictionary.json'):
        self.builder = SynonymBuilder()
        self.builder.load_dictionary(dictionary_path)
        
        # 物料类别识别关键词
        self.category_keywords = {
            'bearing': ['轴承', '軸承', 'bearing'],
            'bolt': ['螺栓', '螺钉', '螺丝', 'bolt', 'screw'],
            'valve': ['阀', '阀门', '閥門', 'valve'],
            'pipe': ['管', '管道', '管件', 'pipe', 'tube'],
            'electrical': ['接触器', '继电器', '断路器', '变频器', 'contactor', 'relay'],
            'pump': ['泵', '水泵', '油泵', 'pump'],
            'motor': ['电机', '马达', '电动机', 'motor'],
            'sensor': ['传感器', '感应器', 'sensor'],
            'cable': ['电缆', '线缆', 'cable', 'wire'],
            'filter': ['过滤器', '滤芯', 'filter']
        }
    
    def detect_category(self, description: str) -> Optional[str]:
        """自动检测物料类别"""
        description_lower = description.lower()
        for category, keywords in self.category_keywords.items():
            if any(keyword in description_lower for keyword in keywords):
                return category
        return 'general'  # 通用类别
    
    def standardize_material(self, description: str, category: Optional[str] = None) -> Dict:
        """
        标准化物料描述
        
        Args:
            description: 原始物料描述
            category: 物料类别（可选，自动检测）
            
        Returns:
            包含标准化结果和元数据的字典
        """
        if not category:
            category = self.detect_category(description)
        
        standardized_text = self.builder.standardize_text(description, category=category)
        
        return {
            'original': description,
            'standardized': standardized_text,
            'detected_category': category,
            'confidence': self._calculate_confidence(description, category)
        }
    
    def _calculate_confidence(self, description: str, category: str) -> float:
        """计算类别检测置信度"""
        keywords = self.category_keywords.get(category, [])
        matches = sum(1 for keyword in keywords if keyword in description.lower())
        return min(matches / len(keywords) if keywords else 0.1, 1.0)
```

### 2. 智能文本预处理
在查重前对所有物料描述进行智能标准化：
```python
def intelligent_preprocess_materials(materials: List[Dict]) -> List[Dict]:
    """
    智能预处理物料数据 - 支持全品类物料
    
    Args:
        materials: 包含物料描述的字典列表
        
    Returns:
        预处理后的物料数据
    """
    transformer = UniversalMaterialTransformer('universal_synonym_dictionary.json')
    
    processed = []
    for material in materials:
        result = transformer.standardize_material(material['description'])
        
        processed.append({
            'erp_code': material.get('erp_code', ''),
            'original_description': result['original'],
            'standardized_description': result['standardized'],
            'detected_category': result['detected_category'],
            'confidence': result['confidence'],
            'processing_timestamp': datetime.now().isoformat()
        })
    
    return processed

# 按类别分组处理
def process_by_category(materials: List[Dict]) -> Dict[str, List[Dict]]:
    """按物料类别分组处理"""
    transformer = UniversalMaterialTransformer()
    categorized = {}
    
    for material in materials:
        result = transformer.standardize_material(material['description'])
        category = result['detected_category']
        
        if category not in categorized:
            categorized[category] = []
        
        categorized[category].append({
            'original': material,
            'processed': result
        })
    
    return categorized
```

## 物料类别扩展指南

### 新增物料类别步骤
1. **关键词定义**: 在`category_keywords`中添加新类别的识别关键词
2. **规则扩展**: 为新类别定义特有的属性提取规则
3. **词典更新**: 添加新类别的同义词和变体
4. **测试验证**: 使用新类别样本数据验证处理效果

### 支持的物料类别清单
| 类别代码 | 中文名称 | 英文名称 | 主要属性 | 示例 |
|---------|---------|---------|---------|------|
| bearing | 轴承 | Bearing | 内径、外径、厚度、类型 | SKF 6201ZZ深沟球轴承 |
| bolt | 螺栓螺钉 | Bolt/Screw | 规格、长度、材质、头型 | M10x30内六角螺栓304 |
| valve | 阀门 | Valve | 口径、压力、材质、类型 | DN50不锈钢球阀1.6MPa |
| pipe | 管道管件 | Pipe/Fitting | 管径、壁厚、材质、标准 | Φ50无缝钢管20# |
| electrical | 电气元件 | Electrical | 型号、规格、品牌、功率 | 西门子3TF接触器220V |
| pump | 泵类 | Pump | 流量、扬程、功率、介质 | 离心泵50m³/h 32m |
| motor | 电机 | Motor | 功率、转速、电压、防护 | 三相异步电机7.5kW |
| sensor | 传感器 | Sensor | 类型、量程、输出、精度 | 压力传感器0-10bar |
| cable | 电缆线缆 | Cable | 规格、芯数、电压、材质 | YJV 3x25+1x16 0.6/1kV |
| filter | 过滤器 | Filter | 精度、流量、压力、介质 | 液压滤芯10μm |

### 类别特定处理示例
```python
# 为新的物料类别添加特定处理逻辑
def add_new_category_support(category_name: str, keywords: List[str], 
                           extraction_rules: Dict[str, str]):
    """
    添加新物料类别支持
    
    Args:
        category_name: 类别名称
        keywords: 识别关键词列表
        extraction_rules: 属性提取规则字典
    """
    builder = SynonymBuilder()
    
    # 1. 添加类别关键词
    builder.add_category_keywords(category_name, keywords)
    
    # 2. 添加提取规则
    for attr_name, regex_pattern in extraction_rules.items():
        builder.add_extraction_rule(category_name, attr_name, regex_pattern)
    
    # 3. 保存更新后的配置
    builder.save_configuration()
    
    print(f"成功添加物料类别: {category_name}")

# 使用示例：添加"仪表"类别
add_new_category_support(
    category_name='instrument',
    keywords=['仪表', '表头', '显示器', 'instrument', 'gauge'],
    extraction_rules={
        'type': r'(压力表|温度表|流量表|液位表)',
        'range': r'(\d+(?:\.\d+)?[-~]\d+(?:\.\d+)?)\s*(MPa|bar|℃|°C|m³/h)',
        'accuracy': r'精度\s*([±]?\d+(?:\.\d+)?%?)',
        'connection': r'(螺纹|法兰|卡箍)\s*([MG]\d+(?:\.\d+)?|DN\d+)'
    }
)
```

## 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| 2.0 | 2025-10-02 | 扩展为通用物料支持，增加多类别处理能力 |
| 1.0 | 2025-10-02 | 初始版本，专注轴承和螺栓 |

## 联系方式
如有问题请联系系统管理员或查看项目文档。技术支持请参考项目GEMINI.md文档中的开发规范。