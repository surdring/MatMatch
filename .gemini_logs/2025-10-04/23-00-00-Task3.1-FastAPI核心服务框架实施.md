# Task 3.1: FastAPIæ ¸å¿ƒæœåŠ¡æ¡†æ¶å®æ–½æ—¥å¿—

**ä»»åŠ¡ç¼–å·**: Task 3.1  
**ä»»åŠ¡åç§°**: FastAPIæ ¸å¿ƒæœåŠ¡æ¡†æ¶  
**å¼€å§‹æ—¶é—´**: 2025-10-04 23:00:00  
**è´Ÿè´£äºº**: AIå¼€å‘åŠ©æ‰‹  
**ä¼˜å…ˆçº§**: P0 (å…³é”®è·¯å¾„)

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

### ä»»åŠ¡ç›®æ ‡
æ­å»ºMatMatché¡¹ç›®çš„FastAPIæ ¸å¿ƒæœåŠ¡æ¡†æ¶ï¼Œä¸ºPhase 3çš„APIå¼€å‘æä¾›åŸºç¡€æ¶æ„ã€‚

### ä¾èµ–å…³ç³»
- âœ… Task 1.1: PostgreSQLæ•°æ®åº“è®¾è®¡ä¸å®ç°
- âœ… Task 2.1: UniversalMaterialProcessor
- âœ… Task 2.2: SimilarityCalculator

### éªŒæ”¶æ ‡å‡†
- [ ] APIæœåŠ¡å¯åŠ¨æ­£å¸¸
- [ ] ä¸­é—´ä»¶åŠŸèƒ½æ­£ç¡®
- [ ] å¼‚å¸¸å¤„ç†è¦†ç›–ç‡ â‰¥ 95%
- [ ] APIæ–‡æ¡£å®Œæ•´å‡†ç¡®

---

## ğŸ¯ S.T.I.R. å¼€å‘å¾ªç¯

### Phase 1: Spec (è§„æ ¼å®šä¹‰)

#### 1.1 æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚

**ä¸»è¦åŠŸèƒ½**:
1. FastAPIåº”ç”¨åˆå§‹åŒ–å’Œé…ç½®
2. æ•°æ®åº“è¿æ¥ä¾èµ–æ³¨å…¥
3. CORSè·¨åŸŸé…ç½®
4. å…¨å±€å¼‚å¸¸å¤„ç†
5. è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
6. å¥åº·æ£€æŸ¥ç«¯ç‚¹
7. APIæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆï¼ˆSwagger/ReDocï¼‰

**æŠ€æœ¯æ¶æ„**:
```
backend/api/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ main.py              # FastAPIåº”ç”¨ä¸»å…¥å£
â”œâ”€â”€ dependencies.py      # ä¾èµ–æ³¨å…¥ï¼ˆæ•°æ®åº“ä¼šè¯ã€å¤„ç†å™¨ç­‰ï¼‰
â”œâ”€â”€ middleware.py        # ä¸­é—´ä»¶ï¼ˆæ—¥å¿—ã€CORSã€é”™è¯¯å¤„ç†ï¼‰
â”œâ”€â”€ exceptions.py        # è‡ªå®šä¹‰å¼‚å¸¸ç±»
â”œâ”€â”€ exception_handlers.py # å…¨å±€å¼‚å¸¸å¤„ç†å™¨
â””â”€â”€ routers/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ health.py        # å¥åº·æ£€æŸ¥è·¯ç”±
    â””â”€â”€ materials.py     # ç‰©æ–™æŸ¥é‡è·¯ç”±ï¼ˆTask 3.2å®ç°ï¼‰
```

#### 1.2 APIç«¯ç‚¹è®¾è®¡

**å¥åº·æ£€æŸ¥ç«¯ç‚¹**:
```python
GET /health
Response: {
    "status": "healthy",
    "timestamp": "2025-10-04T23:00:00Z",
    "version": "1.0.0",
    "database": "connected",
    "knowledge_base": "loaded"
}

GET /health/readiness
Response: {
    "ready": true,
    "checks": {
        "database": "ok",
        "knowledge_base": "ok",
        "processors": "ok"
    }
}
```

**æ ¹è·¯å¾„**:
```python
GET /
Response: {
    "message": "MatMatch API",
    "version": "1.0.0",
    "docs": "/docs",
    "redoc": "/redoc"
}
```

#### 1.3 ä¾èµ–æ³¨å…¥è®¾è®¡

**æ•°æ®åº“ä¼šè¯ä¾èµ–**:
```python
async def get_db() -> AsyncGenerator[AsyncSession, None]:
    """è·å–æ•°æ®åº“ä¼šè¯"""
    async with get_session() as session:
        yield session
```

**ç‰©æ–™å¤„ç†å™¨ä¾èµ–**:
```python
async def get_material_processor(
    db: AsyncSession = Depends(get_db)
) -> UniversalMaterialProcessor:
    """è·å–ç‰©æ–™å¤„ç†å™¨å®ä¾‹ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰"""
    return await get_processor_instance(db)
```

**ç›¸ä¼¼åº¦è®¡ç®—å™¨ä¾èµ–**:
```python
async def get_similarity_calculator(
    db: AsyncSession = Depends(get_db)
) -> SimilarityCalculator:
    """è·å–ç›¸ä¼¼åº¦è®¡ç®—å™¨å®ä¾‹"""
    return SimilarityCalculator(db)
```

#### 1.4 ä¸­é—´ä»¶è®¾è®¡

**è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶**:
- è®°å½•æ¯ä¸ªè¯·æ±‚çš„æ–¹æ³•ã€è·¯å¾„ã€è€—æ—¶
- è®°å½•å“åº”çŠ¶æ€ç 
- æ”¯æŒè¯·æ±‚IDè¿½è¸ª

**CORSä¸­é—´ä»¶**:
- å…è®¸çš„æºï¼š`http://localhost:3000`ï¼ˆå‰ç«¯å¼€å‘åœ°å€ï¼‰
- å…è®¸çš„æ–¹æ³•ï¼šGET, POST, PUT, DELETE
- å…è®¸çš„å¤´ï¼šContent-Type, Authorization

**é”™è¯¯å¤„ç†ä¸­é—´ä»¶**:
- æ•è·æœªå¤„ç†çš„å¼‚å¸¸
- è¿”å›ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼

#### 1.5 å¼‚å¸¸å¤„ç†è®¾è®¡

**è‡ªå®šä¹‰å¼‚å¸¸ç±»**:
```python
class APIException(Exception):
    """APIåŸºç¡€å¼‚å¸¸"""
    def __init__(self, status_code: int, detail: str):
        self.status_code = status_code
        self.detail = detail

class NotFoundException(APIException):
    """èµ„æºæœªæ‰¾åˆ°å¼‚å¸¸"""
    def __init__(self, detail: str):
        super().__init__(404, detail)

class ValidationException(APIException):
    """æ•°æ®éªŒè¯å¼‚å¸¸"""
    def __init__(self, detail: str):
        super().__init__(422, detail)

class DatabaseException(APIException):
    """æ•°æ®åº“å¼‚å¸¸"""
    def __init__(self, detail: str):
        super().__init__(500, detail)
```

**ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼**:
```python
{
    "error": {
        "code": "ERROR_CODE",
        "message": "é”™è¯¯æè¿°",
        "details": "è¯¦ç»†ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰",
        "timestamp": "2025-10-04T23:00:00Z",
        "path": "/api/v1/materials/search",
        "request_id": "uuid"
    }
}
```

#### 1.6 é…ç½®ç®¡ç†

**åº”ç”¨é…ç½®**:
```python
class APIConfig(BaseModel):
    """APIé…ç½®"""
    app_name: str = "MatMatch API"
    version: str = "1.0.0"
    debug: bool = False
    
    # CORSé…ç½®
    cors_origins: List[str] = ["http://localhost:3000"]
    cors_methods: List[str] = ["GET", "POST", "PUT", "DELETE"]
    
    # æ—¥å¿—é…ç½®
    log_level: str = "INFO"
    log_format: str = "json"
    
    # é™æµé…ç½®
    rate_limit_enabled: bool = True
    rate_limit_per_minute: int = 60
```

---

### Phase 2: Test (æµ‹è¯•ç”¨ä¾‹ç¼–å†™)

#### 2.1 å•å…ƒæµ‹è¯•è®¾è®¡

**æµ‹è¯•æ–‡ä»¶**: `backend/tests/test_api_framework.py`

**æµ‹è¯•ç”¨ä¾‹æ¸…å•**:

1. **åº”ç”¨å¯åŠ¨æµ‹è¯•**
   - [ ] test_app_creation
   - [ ] test_app_startup_event
   - [ ] test_app_shutdown_event

2. **è·¯ç”±æµ‹è¯•**
   - [ ] test_root_endpoint
   - [ ] test_health_check_endpoint
   - [ ] test_readiness_check_endpoint

3. **ä¾èµ–æ³¨å…¥æµ‹è¯•**
   - [ ] test_get_db_dependency
   - [ ] test_get_material_processor_dependency
   - [ ] test_get_similarity_calculator_dependency

4. **ä¸­é—´ä»¶æµ‹è¯•**
   - [ ] test_request_logging_middleware
   - [ ] test_cors_middleware
   - [ ] test_error_handling_middleware

5. **å¼‚å¸¸å¤„ç†æµ‹è¯•**
   - [ ] test_api_exception_handler
   - [ ] test_not_found_exception_handler
   - [ ] test_validation_exception_handler
   - [ ] test_database_exception_handler
   - [ ] test_generic_exception_handler

6. **APIæ–‡æ¡£æµ‹è¯•**
   - [ ] test_swagger_docs_available
   - [ ] test_redoc_docs_available

#### 2.2 é›†æˆæµ‹è¯•è®¾è®¡

**æµ‹è¯•æ–‡ä»¶**: `backend/tests/integration/test_api_integration.py`

**æµ‹è¯•ç”¨ä¾‹**:
1. **ç«¯åˆ°ç«¯å¥åº·æ£€æŸ¥**
   - [ ] test_health_check_with_db_connection
   - [ ] test_readiness_check_with_dependencies

2. **é”™è¯¯åœºæ™¯æµ‹è¯•**
   - [ ] test_404_not_found_response
   - [ ] test_500_internal_error_response
   - [ ] test_422_validation_error_response

---

### Phase 3: Implement (ä»£ç å®ç°)

#### å®æ–½è®¡åˆ’

**Step 1**: åˆ›å»ºåŸºç¡€ç›®å½•ç»“æ„ âœ…
**Step 2**: å®ç°è‡ªå®šä¹‰å¼‚å¸¸ç±» â³
**Step 3**: å®ç°å¼‚å¸¸å¤„ç†å™¨ â³
**Step 4**: å®ç°ä¾èµ–æ³¨å…¥ â³
**Step 5**: å®ç°ä¸­é—´ä»¶ â³
**Step 6**: å®ç°FastAPIä¸»åº”ç”¨ â³
**Step 7**: å®ç°å¥åº·æ£€æŸ¥è·¯ç”± â³
**Step 8**: ç¼–å†™æµ‹è¯•ç”¨ä¾‹ â³
**Step 9**: è¿è¡Œæµ‹è¯•éªŒè¯ â³

---

### Phase 4: Review (ä»£ç å®¡æŸ¥å’ŒéªŒæ”¶)

#### å®¡æŸ¥æ¸…å•
- [ ] ä»£ç è´¨é‡
  - [ ] éµå¾ªPython PEP 8è§„èŒƒ
  - [ ] ç±»å‹æ³¨è§£å®Œæ•´
  - [ ] Docstringæ–‡æ¡£å®Œæ•´
- [ ] åŠŸèƒ½å®Œæ•´æ€§
  - [ ] æ‰€æœ‰SpecåŠŸèƒ½å®ç°
  - [ ] æ‰€æœ‰ä¾èµ–æ­£ç¡®æ³¨å…¥
- [ ] æµ‹è¯•è¦†ç›–ç‡
  - [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 95%
  - [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æŒ‡æ ‡
  - [ ] APIå“åº”æ—¶é—´ < 100msï¼ˆå¥åº·æ£€æŸ¥ï¼‰
  - [ ] å¯åŠ¨æ—¶é—´ < 5ç§’
- [ ] æ–‡æ¡£è´¨é‡
  - [ ] APIæ–‡æ¡£æ¸…æ™°å®Œæ•´
  - [ ] é”™è¯¯å“åº”æ–‡æ¡£åŒ–

---

## ğŸ“ å®æ–½è¿›åº¦

### å½“å‰çŠ¶æ€
- **é˜¶æ®µ**: Phase 3 - Implement
- **è¿›åº¦**: 0%
- **çŠ¶æ€**: è¿›è¡Œä¸­

### ä¸‹ä¸€æ­¥
å¼€å§‹å®æ–½ Step 1: åˆ›å»ºåŸºç¡€ç›®å½•ç»“æ„

---

## ğŸ“Š å†³ç­–è®°å½•

### å†³ç­–1: ä½¿ç”¨FastAPIä¾èµ–æ³¨å…¥è€Œéå•ä¾‹æ¨¡å¼
**åŸå› **: 
- FastAPIçš„ä¾èµ–æ³¨å…¥ç³»ç»Ÿæ›´çµæ´»
- ä¾¿äºæµ‹è¯•ï¼ˆå¯ä»¥è½»æ¾mockä¾èµ–ï¼‰
- ç¬¦åˆFastAPIæœ€ä½³å®è·µ

### å†³ç­–2: é‡‡ç”¨åˆ†å±‚å¼‚å¸¸å¤„ç†
**åŸå› **:
- ä¸šåŠ¡é€»è¾‘å±‚æŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸
- APIå±‚ç»Ÿä¸€å¤„ç†å’Œè½¬æ¢
- æä¾›ä¸€è‡´çš„é”™è¯¯å“åº”æ ¼å¼

### å†³ç­–3: ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
**åŸå› **:
- ä¾¿äºæ—¥å¿—åˆ†æå’Œç›‘æ§
- æ”¯æŒè¯·æ±‚è¿½è¸ª
- ç”Ÿäº§ç¯å¢ƒå‹å¥½

---

## ğŸ”— ç›¸å…³æ–‡æ¡£
- `specs/main/design.md` - ç¬¬2.1èŠ‚ APIæ¥å£å®šä¹‰
- `specs/main/requirements.md` - éåŠŸèƒ½æ€§éœ€æ±‚
- `docs/developer_onboarding_guide.md` - å¼€å‘è§„èŒƒ

---

**å¼€å§‹æ—¶é—´**: 2025-10-04 23:00:00  
**é¢„è®¡å®Œæˆ**: 2025-10-05 01:00:00  
**å®é™…å®Œæˆ**: å¾…å®Œæˆ

