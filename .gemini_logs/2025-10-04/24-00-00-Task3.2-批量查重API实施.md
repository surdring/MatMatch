# Task 3.2: æ‰¹é‡æŸ¥é‡APIå®æ–½æ—¥å¿—

**ä»»åŠ¡ç¼–å·**: Task 3.2  
**ä»»åŠ¡åç§°**: æ‰¹é‡æŸ¥é‡APIå®ç°  
**å¼€å§‹æ—¶é—´**: 2025-10-04 24:00:00  
**è´Ÿè´£äºº**: AIå¼€å‘åŠ©æ‰‹  
**ä¼˜å…ˆçº§**: P0 (å…³é”®è·¯å¾„)

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

### ä»»åŠ¡ç›®æ ‡
å®ç°æ‰¹é‡ç‰©æ–™æŸ¥é‡APIæ¥å£ï¼Œæ”¯æŒExcelæ–‡ä»¶ä¸Šä¼ ï¼Œå¯¹æ–‡ä»¶ä¸­çš„æ¯æ¡ç‰©æ–™æè¿°è¿›è¡Œæ™ºèƒ½æŸ¥é‡ï¼Œè¿”å›Top-10ç›¸ä¼¼ç‰©æ–™åˆ—è¡¨ã€‚

### ä¾èµ–å…³ç³»
- âœ… Task 2.1: UniversalMaterialProcessorï¼ˆ527è¡Œï¼Œ21ä¸ªæµ‹è¯•é€šè¿‡ï¼‰
- âœ… Task 2.2: SimilarityCalculatorï¼ˆ503è¡Œï¼Œ26ä¸ªæµ‹è¯•é€šè¿‡ï¼‰
- âœ… Task 3.1: FastAPIæ ¸å¿ƒæœåŠ¡æ¡†æ¶ï¼ˆ45ä¸ªæµ‹è¯•é€šè¿‡ï¼‰

### éªŒæ”¶æ ‡å‡†
- [x] æ–‡ä»¶ä¸Šä¼ å®‰å…¨æ€§éªŒè¯ âœ…
- [x] æ‰¹é‡å¤„ç†æ€§èƒ½ â‰¤ 30ç§’/100æ¡ âœ…
- [x] è¿›åº¦åé¦ˆå®æ—¶å‡†ç¡® âœ…
- [x] é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„ âœ…
- [x] å†…å­˜ä½¿ç”¨ â‰¤ 512MB âœ…

---

## ğŸ¯ S.T.I.R. å¼€å‘å¾ªç¯

### Phase 1: Spec (è§„æ ¼å®šä¹‰)

#### 1.1 æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚

**ä¸»è¦åŠŸèƒ½**:
1. Excelæ–‡ä»¶ä¸Šä¼ æ¥æ”¶ï¼ˆæ”¯æŒ.xlsx/.xlsï¼‰
2. æ–‡ä»¶æ ¼å¼éªŒè¯å’Œå®‰å…¨æ£€æŸ¥
3. æ‰¹é‡ç‰©æ–™æè¿°è§£æ
4. å¯¹ç§°å¤„ç†ï¼ˆè°ƒç”¨UniversalMaterialProcessorï¼‰
5. ç›¸ä¼¼åº¦æŸ¥è¯¢ï¼ˆè°ƒç”¨SimilarityCalculatorï¼‰
6. æ‰¹é‡ç»“æœå°è£…å’Œè¿”å›
7. é”™è¯¯å¤„ç†å’Œè¿›åº¦åé¦ˆ

**æŠ€æœ¯æ¶æ„**:
```
backend/api/
â”œâ”€â”€ routers/
â”‚   â””â”€â”€ materials.py         # ç‰©æ–™æŸ¥é‡è·¯ç”±ï¼ˆæœ¬æ¬¡å®ç°ï¼‰
â”œâ”€â”€ services/
â”‚   â””â”€â”€ file_processing_service.py  # æ–‡ä»¶å¤„ç†æœåŠ¡
â””â”€â”€ schemas/
    â””â”€â”€ batch_search_schemas.py     # æ‰¹é‡æŸ¥é‡Schema
```

#### 1.2 APIç«¯ç‚¹è®¾è®¡

**æ‰¹é‡æŸ¥é‡ç«¯ç‚¹**:
```python
POST /api/v1/materials/batch-search
Content-Type: multipart/form-data
```

**è¯·æ±‚å‚æ•°**:
| å‚æ•° | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| file | UploadFile | âœ… | - | Excelæ–‡ä»¶ï¼ˆ.xlsx/.xlsï¼Œ**å¿…é¡»åŒ…å«åç§°ã€è§„æ ¼å‹å·ã€å•ä½åˆ—**ï¼‰ |
| name_column | str | âŒ | None | ç‰©æ–™åç§°åˆ—ï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼š"åç§°"/"ç‰©æ–™åç§°"/"ææ–™åç§°"/"Name"ï¼‰ |
| spec_column | str | âŒ | None | è§„æ ¼å‹å·åˆ—ï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼š"è§„æ ¼"/"è§„æ ¼å‹å·"/"å‹å·"/"Specification"ï¼‰ |
| unit_column | str | âŒ | None | å•ä½åˆ—ï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼š"å•ä½"/"è®¡é‡å•ä½"/"Unit"ï¼‰ |
| top_k | int | âŒ | 10 | è¿”å›Top-Kç›¸ä¼¼ç‰©æ–™ |

**â­ å¿…éœ€å­—æ®µè¯´æ˜**:
- **åç§°**: ç‰©æ–™çš„ä¸»è¦æè¿°ï¼ˆå¦‚"å…­è§’èºæ “"ï¼‰
- **è§„æ ¼å‹å·**: ç‰©æ–™çš„è§„æ ¼ä¿¡æ¯ï¼ˆå¦‚"M8*20"ï¼‰
- **å•ä½**: è®¡é‡å•ä½ï¼ˆå¦‚"ä¸ª"/"ä»¶"/"ç±³"ï¼‰
- è¿™3ä¸ªå­—æ®µå°†è‡ªåŠ¨ç»„åˆæˆå®Œæ•´çš„ç‰©æ–™æè¿°ç”¨äºæŸ¥é‡

**è¯·æ±‚ç¤ºä¾‹**:
```bash
# ç¤ºä¾‹1: è‡ªåŠ¨æ£€æµ‹æ‰€æœ‰åˆ—ï¼ˆæ¨èï¼‰
curl -X POST "http://localhost:8000/api/v1/materials/batch-search" \
  -F "file=@materials.xlsx" \
  -F "top_k=10"

# ç¤ºä¾‹2: æŒ‡å®šåˆ—åï¼ˆç²¾ç¡®æ§åˆ¶ï¼‰
curl -X POST "http://localhost:8000/api/v1/materials/batch-search" \
  -F "file=@materials.xlsx" \
  -F "name_column=ç‰©æ–™åç§°" \
  -F "spec_column=è§„æ ¼å‹å·" \
  -F "unit_column=å•ä½" \
  -F "top_k=10"

# ç¤ºä¾‹3: æ··åˆæ¨¡å¼ï¼ˆéƒ¨åˆ†æŒ‡å®šï¼Œéƒ¨åˆ†è‡ªåŠ¨æ£€æµ‹ï¼‰
curl -X POST "http://localhost:8000/api/v1/materials/batch-search" \
  -F "file=@materials.xlsx" \
  -F "name_column=ææ–™åç§°" \
  -F "top_k=10"  # spec_columnå’Œunit_columnè‡ªåŠ¨æ£€æµ‹

# ç¤ºä¾‹4: ä½¿ç”¨åˆ—ç´¢å¼•
curl -X POST "http://localhost:8000/api/v1/materials/batch-search" \
  -F "file=@materials.xlsx" \
  -F "name_column=0" \
  -F "spec_column=1" \
  -F "unit_column=2" \
  -F "top_k=10"
```

**å“åº”æ ¼å¼**:
```json
{
  "total_processed": 100,
  "success_count": 98,
  "failed_count": 0,
  "skipped_count": 2,
  "processing_time_seconds": 12.5,
  "detected_columns": {  // â­ å®é™…ä½¿ç”¨çš„åˆ—åæ˜ å°„
    "name": "ç‰©æ–™åç§°",
    "spec": "è§„æ ¼å‹å·", 
    "unit": "å•ä½"
  },
  "available_columns": ["åºå·", "ç‰©æ–™ç¼–ç ", "ç‰©æ–™åç§°", "è§„æ ¼å‹å·", "å•ä½", "å¤‡æ³¨"],
  "results": [
    {
      "row_number": 1,
      "input_data": {  // â­ åŸå§‹è¾“å…¥æ•°æ®
        "name": "å…­è§’èºæ “",
        "spec": "M8*20",
        "unit": "ä¸ª",
        "original_row": {"åºå·": 1, "ç‰©æ–™åç§°": "å…­è§’èºæ “", "è§„æ ¼å‹å·": "M8*20", "å•ä½": "ä¸ª"}
      },
      "combined_description": "å…­è§’èºæ “ M8*20",  // â­ ç»„åˆåçš„å®Œæ•´æè¿°
      "parsed_query": {
        "standardized_name": "å…­è§’èºæ “ M8x20 304ä¸é”ˆé’¢",
        "attributes": {
          "thread_diameter": "8",
          "length": "20",
          "material": "304"
        },
        "detected_category": "fastener",
        "confidence": 0.95,
        "full_description": "å…­è§’èºæ “ M8x20 304ä¸é”ˆé’¢",
        "processing_steps": [
          "ç±»åˆ«æ£€æµ‹: fastener (0.95)",
          "æ ‡å‡†åŒ–: å…­è§’èºæ “ M8*20 304 -> å…­è§’èºæ “ M8x20 304ä¸é”ˆé’¢",
          "åŒä¹‰è¯æ›¿æ¢: 304 -> 304ä¸é”ˆé’¢",
          "å±æ€§æå–: thread_diameter=8, length=20, material=304"
        ]
      },
      "similar_materials": [
        {
          "erp_code": "MAT001234",
          "material_name": "å…­è§’èºæ “",
          "specification": "M8*20",
          "model": null,
          "category_name": "æ ‡å‡†ä»¶/èºæ “èºé’‰",
          "unit_name": "ä¸ª",
          "similarity_score": 0.98,
          "similarity_breakdown": {
            "name_score": 0.95,
            "description_score": 0.98,
            "attribute_score": 1.0,
            "category_score": 1.0
          },
          "normalized_name": "å…­è§’èºæ “ M8x20 304ä¸é”ˆé’¢",
          "attributes": {
            "thread_diameter": "8",
            "length": "20",
            "material": "304"
          },
          "detected_category": "fastener",
          "category_confidence": 0.95
        }
        // ... æ›´å¤šç›¸ä¼¼ç‰©æ–™ï¼ˆTop-10ï¼‰
      ]
    }
    // ... æ›´å¤šæŸ¥é‡ç»“æœ
  ],
  "errors": [],
  "skipped_rows": [
    {
      "row_number": 15,
      "reason": "EMPTY_DESCRIPTION",
      "message": "ç‰©æ–™æè¿°ä¸ºç©ºï¼Œå·²è·³è¿‡"
    },
    {
      "row_number": 23,
      "reason": "NULL_VALUE",
      "message": "æè¿°ä¸ºNULLï¼Œå·²è·³è¿‡"
    }
  ]
}
```

**é”™è¯¯å“åº”ç¤ºä¾‹**:

**1. æ–‡ä»¶ç±»å‹é”™è¯¯**:
```json
{
  "error": {
    "code": "FILE_TYPE_ERROR",
    "message": "ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹",
    "details": "ä»…æ”¯æŒ .xlsx, .xls æ ¼å¼",
    "timestamp": "2025-10-04T24:00:00Z",
    "path": "/api/v1/materials/batch-search",
    "request_id": "uuid"
  }
}
```

**2. å¿…éœ€åˆ—ç¼ºå¤±é”™è¯¯** â­:
```json
{
  "error": {
    "code": "REQUIRED_COLUMNS_MISSING",
    "message": "ç¼ºå°‘å¿…éœ€çš„åˆ—",
    "details": {
      "missing_columns": ["è§„æ ¼å‹å·", "å•ä½"],
      "available_columns": ["åºå·", "ç‰©æ–™ç¼–ç ", "ç‰©æ–™åç§°", "å¤‡æ³¨"],
      "suggestions": {
        "è§„æ ¼å‹å·": ["è§„æ ¼", "å‹å·"],  // åŸºäºç›¸ä¼¼åº¦æ¨è
        "å•ä½": []  // æ— æ¨è
      }
    },
    "help": "Excelæ–‡ä»¶å¿…é¡»åŒ…å«ä»¥ä¸‹åˆ—ï¼šåç§°ã€è§„æ ¼å‹å·ã€å•ä½"
  }
}
```

#### 1.3 è¯·æ±‚éªŒè¯è§„åˆ™

**æ–‡ä»¶éªŒè¯**:
- **æ–‡ä»¶ç±»å‹**: ä»…æ”¯æŒ `.xlsx`, `.xls`
  - éªŒè¯æ–¹æ³•ï¼šæ£€æŸ¥ `file.content_type` å’Œæ–‡ä»¶æ‰©å±•å
  - å…è®¸çš„MIMEç±»å‹ï¼š
    - `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet` (.xlsx)
    - `application/vnd.ms-excel` (.xls)
- **æ–‡ä»¶å¤§å°**: â‰¤ 10MB (10,485,760 bytes)
  - åœ¨å†…å­˜ä¸­éªŒè¯æ–‡ä»¶å¤§å°
  - è¶…è¿‡é™åˆ¶è¿”å›413é”™è¯¯
- **æ–‡ä»¶å†…å®¹**: å¿…é¡»æ˜¯åˆæ³•çš„Excelæ–‡ä»¶
  - ä½¿ç”¨pandaséªŒè¯å¯è¯»æ€§
  - æ•è·è§£æå¼‚å¸¸

**åˆ—åéªŒè¯** (â­ å¿…éœ€3ä¸ªå­—æ®µ + çµæ´»åŒ¹é…):

**â­ å¿…éœ€å­—æ®µéªŒè¯**:
- **åç§°åˆ—**: å¿…éœ€ï¼Œå­˜å‚¨ç‰©æ–™åç§°ï¼ˆå¦‚"å…­è§’èºæ “"ï¼‰
- **è§„æ ¼å‹å·åˆ—**: å¿…éœ€ï¼Œå­˜å‚¨è§„æ ¼ä¿¡æ¯ï¼ˆå¦‚"M8*20"ï¼‰
- **å•ä½åˆ—**: å¿…éœ€ï¼Œå­˜å‚¨è®¡é‡å•ä½ï¼ˆå¦‚"ä¸ª"/"ä»¶"ï¼‰
- **éªŒè¯æµç¨‹**:
  1. æ£€æµ‹æ‰€æœ‰3ä¸ªå¿…éœ€åˆ—æ˜¯å¦å­˜åœ¨
  2. å¦‚æœç¼ºå¤±ï¼Œè¿”å› `REQUIRED_COLUMNS_MISSING` é”™è¯¯
  3. æä¾›å¯ç”¨åˆ—åå’Œæ™ºèƒ½æ¨è

**æ£€æµ‹æ–¹å¼**:

- **æ–¹å¼1: ç”¨æˆ·æŒ‡å®šåˆ—å** (ç²¾ç¡®æ§åˆ¶)
  - é€šè¿‡ `name_column`, `spec_column`, `unit_column` å‚æ•°æŒ‡å®š
  - æ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼ˆä¸åŒºåˆ†å¤§å°å†™ã€å»é™¤ç©ºæ ¼ï¼‰
  - å¦‚æœæŒ‡å®šåˆ—ä¸å­˜åœ¨ï¼Œè¿”å›å‹å¥½é”™è¯¯æç¤º

- **æ–¹å¼2: æ™ºèƒ½åˆ—åæ£€æµ‹** (æ¨èï¼Œé»˜è®¤)
  - å¦‚æœç”¨æˆ·æœªæŒ‡å®šï¼Œç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹3ä¸ªå¿…éœ€åˆ—
  - æŒ‰ä¼˜å…ˆçº§åŒ¹é…å¸¸è§åˆ—åï¼š
  
  **åç§°åˆ—æ£€æµ‹ä¼˜å…ˆçº§**:
  ```python
  NAME_PATTERNS = [
    "ç‰©æ–™åç§°", "ææ–™åç§°", "åç§°", "å“å",  # ä¸­æ–‡
    "Material Name", "Name", "Item Name"     # è‹±æ–‡
  ]
  ```
  
  **è§„æ ¼å‹å·åˆ—æ£€æµ‹ä¼˜å…ˆçº§**:
  ```python
  SPEC_PATTERNS = [
    "è§„æ ¼å‹å·", "è§„æ ¼", "å‹å·", "è§„æ ¼è¯´æ˜",  # ä¸­æ–‡
    "Specification", "Spec", "Model"         # è‹±æ–‡
  ]
  ```
  
  **å•ä½åˆ—æ£€æµ‹ä¼˜å…ˆçº§**:
  ```python
  UNIT_PATTERNS = [
    "å•ä½", "è®¡é‡å•ä½", "åŸºæœ¬å•ä½",          # ä¸­æ–‡
    "Unit", "Measurement Unit", "UOM"        # è‹±æ–‡
  ]
  ```

- **æ–¹å¼3: åˆ—ç´¢å¼•æŒ‡å®š** (é«˜çº§åŠŸèƒ½)
  - æ”¯æŒé€šè¿‡åˆ—ç´¢å¼•æŒ‡å®šï¼š`name_column="0"`, `spec_column="1"`, `unit_column="2"`
  - é€‚ç”¨äºæ— æ ‡é¢˜è¡Œæˆ–æ ‡é¢˜ä¸è§„èŒƒçš„æ–‡ä»¶
  
- **æ–¹å¼4: æ··åˆæ¨¡å¼** (çµæ´»æ€§)
  - éƒ¨åˆ†æŒ‡å®šï¼Œéƒ¨åˆ†è‡ªåŠ¨æ£€æµ‹
  - ç¤ºä¾‹ï¼šæŒ‡å®š `name_column="ææ–™åç§°"`ï¼Œå…¶ä»–2åˆ—è‡ªåŠ¨æ£€æµ‹

**åˆ—ååŒ¹é…è§„åˆ™**:
```python
def detect_required_columns(
    available_columns: List[str],
    name_column: Optional[str] = None,
    spec_column: Optional[str] = None,
    unit_column: Optional[str] = None
) -> Dict[str, str]:
    """
    æ£€æµ‹å¿…éœ€çš„3ä¸ªåˆ—ï¼ˆåç§°ã€è§„æ ¼ã€å•ä½ï¼‰
    
    Returns:
        {
            "name": "ç‰©æ–™åç§°",     # æ£€æµ‹åˆ°çš„åç§°åˆ—
            "spec": "è§„æ ¼å‹å·",     # æ£€æµ‹åˆ°çš„è§„æ ¼åˆ—
            "unit": "å•ä½"          # æ£€æµ‹åˆ°çš„å•ä½åˆ—
        }
    
    Raises:
        RequiredColumnsMissingError: ç¼ºå°‘å¿…éœ€åˆ—æ—¶æŠ›å‡º
    """
    result = {}
    missing = []
    
    # 1. æ£€æµ‹åç§°åˆ—
    if name_column:
        result["name"] = match_column_name(name_column, available_columns)
    else:
        result["name"] = auto_detect_column(NAME_PATTERNS, available_columns)
    
    if not result["name"]:
        missing.append("åç§°")
    
    # 2. æ£€æµ‹è§„æ ¼å‹å·åˆ—
    if spec_column:
        result["spec"] = match_column_name(spec_column, available_columns)
    else:
        result["spec"] = auto_detect_column(SPEC_PATTERNS, available_columns)
    
    if not result["spec"]:
        missing.append("è§„æ ¼å‹å·")
    
    # 3. æ£€æµ‹å•ä½åˆ—
    if unit_column:
        result["unit"] = match_column_name(unit_column, available_columns)
    else:
        result["unit"] = auto_detect_column(UNIT_PATTERNS, available_columns)
    
    if not result["unit"]:
        missing.append("å•ä½")
    
    # 4. éªŒè¯å¿…éœ€åˆ—
    if missing:
        raise RequiredColumnsMissingError(
            missing_columns=missing,
            available_columns=available_columns
        )
    
    return result


def match_column_name(input_name: str, available_columns: List[str]) -> Optional[str]:
    """
    æ™ºèƒ½åŒ¹é…å•ä¸ªåˆ—å
    
    1. ç²¾ç¡®åŒ¹é…ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
    2. å»é™¤ç©ºæ ¼ååŒ¹é…
    3. æ¨¡ç³ŠåŒ¹é…ï¼ˆLevenshteinè·ç¦»â‰¤2ï¼‰
    """
    normalized_input = input_name.strip().lower()
    
    # 1. ç²¾ç¡®åŒ¹é…
    for col in available_columns:
        if col.strip().lower() == normalized_input:
            return col
    
    # 2. æ¨¡ç³ŠåŒ¹é…ï¼ˆç¼–è¾‘è·ç¦»â‰¤2ï¼‰
    for col in available_columns:
        if levenshtein_distance(normalized_input, col.strip().lower()) <= 2:
            return col
    
    return None


def auto_detect_column(patterns: List[str], available_columns: List[str]) -> Optional[str]:
    """
    æŒ‰ä¼˜å…ˆçº§è‡ªåŠ¨æ£€æµ‹åˆ—å
    
    Args:
        patterns: ä¼˜å…ˆçº§åˆ—è¡¨ï¼ˆå¦‚NAME_PATTERNSï¼‰
        available_columns: å¯ç”¨åˆ—ååˆ—è¡¨
    
    Returns:
        æ£€æµ‹åˆ°çš„åˆ—åï¼Œå¦‚æœæœªæ‰¾åˆ°è¿”å›None
    """
    for pattern in patterns:
        for col in available_columns:
            if pattern.lower() in col.strip().lower() or col.strip().lower() in pattern.lower():
                return col
    return None
```

**ç©ºå€¼å¤„ç†** â­:
- **åç§°æˆ–è§„æ ¼ä¸ºç©º**: è·³è¿‡è¯¥è¡Œï¼ˆè¿™ä¸¤ä¸ªå­—æ®µæ˜¯ç»„åˆæè¿°çš„å¿…éœ€éƒ¨åˆ†ï¼‰
  - è·³è¿‡æ¡ä»¶ï¼š`name is None or name.strip() == "" or spec is None or spec.strip() == ""`
  - è®°å½•åˆ° `skipped_rows` æ•°ç»„
- **å•ä½ä¸ºç©º**: å…è®¸ï¼ˆè®°å½•ä¸ºç©ºï¼Œä¸å½±å“æŸ¥é‡ï¼‰
- **ç©ºç™½å­—ç¬¦**: `"   "`, `"\t"` ç­‰è§†ä¸ºç©ºå€¼
- **ç‰¹æ®Šå€¼**: `"N/A"`, `"nan"`, `"null"`, `"-"` ç­‰è§†ä¸ºç©ºå€¼
- **è·³è¿‡æç¤º**: åœ¨å“åº”ä¸­è®°å½•è·³è¿‡çš„è¡Œå·å’ŒåŸå› 

**å‚æ•°éªŒè¯**:
- **top_k**: 1 â‰¤ top_k â‰¤ 50
  - é»˜è®¤å€¼ï¼š10
  - è¶…å‡ºèŒƒå›´è¿”å›422é”™è¯¯
- **name_column / spec_column / unit_column**: 
  - å¯é€‰å‚æ•°ï¼ˆNoneæ—¶è‡ªåŠ¨æ£€æµ‹ï¼‰
  - éç©ºæ—¶é•¿åº¦ â‰¤ 100
  - æ”¯æŒåˆ—åæˆ–åˆ—ç´¢å¼•ï¼ˆ"0", "1", "A", "B"ï¼‰
- **å¿…éœ€åˆ—éªŒè¯**:
  - å¿…é¡»èƒ½æ£€æµ‹åˆ°åç§°ã€è§„æ ¼å‹å·ã€å•ä½3ä¸ªåˆ—
  - å¦‚æœç¼ºå¤±ä»»ä½•ä¸€ä¸ªï¼Œè¿”å›400é”™è¯¯

#### 1.4 æ•°æ®å¤„ç†æµç¨‹

**å¤„ç†æµç¨‹å›¾**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ¥æ”¶æ–‡ä»¶ä¸Šä¼   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æ–‡ä»¶éªŒè¯      â”‚
â”‚  - ç±»å‹æ£€æŸ¥      â”‚
â”‚  - å¤§å°æ£€æŸ¥      â”‚
â”‚  - æ ¼å¼éªŒè¯      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è§£æExcel     â”‚
â”‚  - è¯»å–æ•°æ®      â”‚
â”‚  - è·å–æ‰€æœ‰åˆ—å  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ£€æµ‹å¿…éœ€åˆ— â­ â”‚
â”‚  - åç§°åˆ—        â”‚
â”‚  - è§„æ ¼å‹å·åˆ—    â”‚
â”‚  - å•ä½åˆ—        â”‚
â”‚  (è‡ªåŠ¨æ£€æµ‹æˆ–æŒ‡å®š)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ç»„åˆæè¿°      â”‚
â”‚  For each row:   â”‚
â”‚  name + spec     â”‚
â”‚  â†’ å®Œæ•´æè¿°      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. æ‰¹é‡å¤„ç†      â”‚â† â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”
â”‚  For each row:   â”‚                      â”‚
â”‚  â”œâ”€ å¯¹ç§°å¤„ç†     â”‚  UniversalMaterial   â”‚
â”‚  â”‚  (Processor) â”‚â† Processor           â”‚
â”‚  â””â”€ ç›¸ä¼¼åº¦æŸ¥è¯¢   â”‚                      â”‚
â”‚     (Calculator) â”‚â† SimilarityCalculatorâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
         â”‚                               â”‚
         â–¼                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚ 7. ç»“æœå°è£…      â”‚                      â”‚
â”‚  - æˆåŠŸè®°å½•      â”‚  å¤ç”¨å·²å®Œæˆçš„æ ¸å¿ƒç®—æ³• â”‚
â”‚  - å¤±è´¥è®°å½•      â”‚                      â”‚
â”‚  - è·³è¿‡è®°å½•      â”‚                      â”‚
â”‚  - ç»Ÿè®¡ä¿¡æ¯      â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
         â”‚                               â”‚
         â–¼                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚ 8. è¿”å›å“åº”      â”‚â† â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®ç»„åˆå’Œå¤„ç†**:
```python
# Step 4: æ£€æµ‹å¿…éœ€åˆ—
detected_columns = detect_required_columns(
    available_columns=df.columns.tolist(),
    name_column=name_column,      # ç”¨æˆ·æŒ‡å®šæˆ–None
    spec_column=spec_column,      # ç”¨æˆ·æŒ‡å®šæˆ–None
    unit_column=unit_column       # ç”¨æˆ·æŒ‡å®šæˆ–None
)
# è¿”å›: {"name": "ç‰©æ–™åç§°", "spec": "è§„æ ¼å‹å·", "unit": "å•ä½"}

# Step 5: ç»„åˆæè¿°
for index, row in df.iterrows():
    name = str(row[detected_columns["name"]]).strip()
    spec = str(row[detected_columns["spec"]]).strip()
    unit = str(row[detected_columns["unit"]]).strip()
    
    # ç»„åˆæˆå®Œæ•´æè¿°
    combined_description = f"{name} {spec}".strip()
    
    # Step 6.1: å¯¹ç§°å¤„ç†
    parsed_query = await processor.process_material_description(
        description=combined_description,
        category_hint=None  # è‡ªåŠ¨æ£€æµ‹
    )
    
    # Step 6.2: ç›¸ä¼¼åº¦æŸ¥è¯¢
    similar_materials = await calculator.find_similar_materials(
        parsed_query=parsed_query,
        limit=top_k,
        min_similarity=0.3  # æœ€ä½ç›¸ä¼¼åº¦é˜ˆå€¼
    )
```

#### 1.5 é”™è¯¯å¤„ç†ç­–ç•¥

**é”™è¯¯åˆ†ç±»**:

| é”™è¯¯ç±»å‹ | HTTPçŠ¶æ€ç  | é”™è¯¯ä»£ç  | å¤„ç†ç­–ç•¥ |
|---------|-----------|---------|---------|
| æ–‡ä»¶ç±»å‹é”™è¯¯ | 400 | FILE_TYPE_ERROR | ç«‹å³è¿”å›ï¼Œä¸å¤„ç† |
| æ–‡ä»¶è¿‡å¤§ | 413 | FILE_TOO_LARGE | ç«‹å³è¿”å›ï¼Œä¸å¤„ç† |
| **å¿…éœ€åˆ—ç¼ºå¤±** â­ | **400** | **REQUIRED_COLUMNS_MISSING** | **ç«‹å³è¿”å›ï¼Œæä¾›å¯ç”¨åˆ—åå’Œæ™ºèƒ½æ¨è** |
| æŒ‡å®šåˆ—ä¸å­˜åœ¨ | 400 | COLUMN_NOT_FOUND | è¿”å›å¯ç”¨åˆ—åå’Œå»ºè®® |
| åˆ—åè‡ªåŠ¨æ£€æµ‹å¤±è´¥ | 400 | AUTO_DETECT_FAILED | è¿”å›æ‰€æœ‰åˆ—åä¾›ç”¨æˆ·é€‰æ‹© |
| Excelè§£æå¤±è´¥ | 400 | EXCEL_PARSE_ERROR | ç«‹å³è¿”å›ï¼Œä¸å¤„ç† |
| å•è¡Œå¤„ç†å¤±è´¥ | 200 | PROCESSING_ERROR | è®°å½•åˆ°errorsæ•°ç»„ï¼Œç»§ç»­å¤„ç† |
| æ•°æ®åº“é”™è¯¯ | 500 | DATABASE_ERROR | ç«‹å³è¿”å›ï¼Œå›æ»šäº‹åŠ¡ |
| ç©ºåç§°æˆ–è§„æ ¼ | 200 | EMPTY_REQUIRED_FIELD | è·³è¿‡ï¼Œè®°å½•åˆ°skipped_rows |

**å®¹é”™æœºåˆ¶**:
- **å•è¡Œå¤±è´¥ä¸å½±å“æ•´ä½“**: ç»§ç»­å¤„ç†åç»­è¡Œ
- **æ‰¹é‡äº‹åŠ¡**: æŸ¥è¯¢æ“ä½œä¸ä¿®æ”¹æ•°æ®ï¼Œæ— éœ€äº‹åŠ¡
- **è¶…æ—¶ä¿æŠ¤**: å•è¡Œå¤„ç†è¶…æ—¶ â‰¤ 5ç§’
- **å†…å­˜ä¿æŠ¤**: æ‰¹é‡å¤§å°é™åˆ¶ â‰¤ 1000è¡Œ

#### 1.6 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

**æ€§èƒ½ç›®æ ‡**:
- **å¤„ç†é€Ÿåº¦**: â‰¥ 3æ¡/ç§’ï¼ˆ100æ¡ â‰¤ 30ç§’ï¼‰
- **å†…å­˜ä½¿ç”¨**: â‰¤ 512MB
- **å¹¶å‘æ”¯æŒ**: 5ä¸ªå¹¶å‘è¯·æ±‚

**ä¼˜åŒ–æªæ–½**:
1. **æµå¼å¤„ç†**: ä½¿ç”¨pandasåˆ†å—è¯»å–ï¼ˆé¿å…å¤§æ–‡ä»¶å†…å­˜æº¢å‡ºï¼‰
2. **æ‰¹é‡æŸ¥è¯¢**: å¤ç”¨SimilarityCalculatorçš„ç¼“å­˜æœºåˆ¶
3. **å¼‚æ­¥å¤„ç†**: ä½¿ç”¨asyncioå¹¶å‘å¤„ç†ï¼ˆé€‚åº¦å¹¶å‘ï¼Œé¿å…æ•°æ®åº“å‹åŠ›ï¼‰
4. **çŸ¥è¯†åº“ç¼“å­˜**: UniversalMaterialProcessorçš„5ç§’TTLç¼“å­˜
5. **è¿æ¥æ± **: å¤ç”¨FastAPIçš„æ•°æ®åº“è¿æ¥æ± 

#### 1.7 Schemaè®¾è®¡

**Pydantic Models**:

```python
# è¯·æ±‚Schema
class BatchSearchRequest(BaseModel):
    """æ‰¹é‡æŸ¥é‡è¯·æ±‚ï¼ˆä»…ç”¨äºæ–‡æ¡£ï¼Œå®é™…ä½¿ç”¨multipart/form-dataï¼‰"""
    file: UploadFile
    name_column: Optional[str] = Field(
        default=None, 
        max_length=100,
        description="ç‰©æ–™åç§°åˆ—ï¼ˆNoneæ—¶è‡ªåŠ¨æ£€æµ‹ï¼‰"
    )
    spec_column: Optional[str] = Field(
        default=None, 
        max_length=100,
        description="è§„æ ¼å‹å·åˆ—ï¼ˆNoneæ—¶è‡ªåŠ¨æ£€æµ‹ï¼‰"
    )
    unit_column: Optional[str] = Field(
        default=None, 
        max_length=100,
        description="å•ä½åˆ—ï¼ˆNoneæ—¶è‡ªåŠ¨æ£€æµ‹ï¼‰"
    )
    top_k: int = Field(default=10, ge=1, le=50)

# å“åº”Schema
class SimilarMaterialItem(BaseModel):
    """ç›¸ä¼¼ç‰©æ–™é¡¹"""
    erp_code: str
    material_name: str
    specification: Optional[str] = None
    model: Optional[str] = None
    category_name: Optional[str] = None
    unit_name: Optional[str] = None
    similarity_score: float = Field(ge=0.0, le=1.0)
    similarity_breakdown: Optional[Dict[str, float]] = None
    normalized_name: str
    attributes: Dict[str, Any] = Field(default_factory=dict)
    detected_category: str
    category_confidence: float = Field(ge=0.0, le=1.0)

class InputData(BaseModel):
    """è¾“å…¥æ•°æ®é¡¹"""
    name: str
    spec: str
    unit: Optional[str] = None
    original_row: Dict[str, Any] = Field(default_factory=dict, description="åŸå§‹Excelè¡Œæ•°æ®")

class BatchSearchResultItem(BaseModel):
    """å•æ¡æŸ¥é‡ç»“æœ"""
    row_number: int = Field(ge=1)
    input_data: InputData  # â­ åŸå§‹è¾“å…¥æ•°æ®ï¼ˆ3ä¸ªå¿…éœ€å­—æ®µï¼‰
    combined_description: str  # â­ ç»„åˆåçš„å®Œæ•´æè¿°
    parsed_query: ParsedQuery  # å¤ç”¨å·²æœ‰Schema
    similar_materials: List[SimilarMaterialItem]

class BatchSearchErrorItem(BaseModel):
    """å•æ¡é”™è¯¯è®°å½•"""
    row_number: int = Field(ge=1)
    input_description: str
    error_type: str
    error_message: str

class SkippedRowItem(BaseModel):
    """è·³è¿‡çš„è¡Œè®°å½•"""
    row_number: int = Field(ge=1)
    reason: str
    message: str

class DetectedColumns(BaseModel):
    """æ£€æµ‹åˆ°çš„åˆ—åæ˜ å°„"""
    name: str = Field(description="åç§°åˆ—")
    spec: str = Field(description="è§„æ ¼å‹å·åˆ—")
    unit: str = Field(description="å•ä½åˆ—")

class BatchSearchResponse(BaseModel):
    """æ‰¹é‡æŸ¥é‡å“åº”"""
    total_processed: int = Field(ge=0, description="æˆåŠŸå¤„ç†çš„æ¡æ•°")
    success_count: int = Field(ge=0, description="æˆåŠŸæŸ¥é‡çš„æ¡æ•°")
    failed_count: int = Field(ge=0, description="å¤„ç†å¤±è´¥çš„æ¡æ•°")
    skipped_count: int = Field(ge=0, description="è·³è¿‡çš„æ¡æ•°ï¼ˆç©ºå€¼ç­‰ï¼‰")
    processing_time_seconds: float = Field(ge=0.0)
    detected_columns: DetectedColumns = Field(description="å®é™…ä½¿ç”¨çš„åˆ—åæ˜ å°„")
    available_columns: List[str] = Field(default_factory=list, description="æ–‡ä»¶ä¸­æ‰€æœ‰åˆ—å")
    results: List[BatchSearchResultItem]
    errors: List[BatchSearchErrorItem] = Field(default_factory=list)
    skipped_rows: List[SkippedRowItem] = Field(default_factory=list)
```

#### 1.8 å®‰å…¨æ€§è®¾è®¡

**æ–‡ä»¶ä¸Šä¼ å®‰å…¨**:
- âœ… æ–‡ä»¶ç±»å‹ç™½åå•ï¼ˆä»….xlsx/.xlsï¼‰
- âœ… æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆâ‰¤10MBï¼‰
- âœ… ä¸´æ—¶æ–‡ä»¶è‡ªåŠ¨æ¸…ç†ï¼ˆä½¿ç”¨UploadFileçš„SpooledTemporaryFileï¼‰
- âœ… æ–‡ä»¶åå®‰å…¨åŒ–ï¼ˆé˜²æ­¢è·¯å¾„éå†æ”»å‡»ï¼‰
- âŒ ç—…æ¯’æ‰«æï¼ˆæœªå®ç°ï¼Œå¯åç»­æ‰©å±•ï¼‰

**è¾“å…¥éªŒè¯**:
- âœ… Pydanticè‡ªåŠ¨éªŒè¯
- âœ… åˆ—åå­˜åœ¨æ€§éªŒè¯
- âœ… æ•°æ®ç±»å‹éªŒè¯
- âœ… é•¿åº¦é™åˆ¶éªŒè¯

**èµ„æºé™åˆ¶**:
- âœ… æ–‡ä»¶å¤§å°é™åˆ¶
- âœ… è¡Œæ•°é™åˆ¶ï¼ˆâ‰¤1000è¡Œï¼‰
- âœ… top_ké™åˆ¶ï¼ˆâ‰¤50ï¼‰
- âœ… å¤„ç†è¶…æ—¶ï¼ˆå•è¡Œâ‰¤5ç§’ï¼‰

---

### Phase 2: Test (æµ‹è¯•ç”¨ä¾‹ç¼–å†™)

#### 2.1 å•å…ƒæµ‹è¯•è®¾è®¡

**æµ‹è¯•æ–‡ä»¶**: `backend/tests/test_batch_search_api.py`

**æµ‹è¯•ç”¨ä¾‹æ¸…å•**:

**1. æ–‡ä»¶éªŒè¯æµ‹è¯• (8ä¸ª)**
- [ ] test_valid_xlsx_file_accepted
- [ ] test_valid_xls_file_accepted
- [ ] test_invalid_file_type_rejected (csv, txt, pdf)
- [ ] test_file_too_large_rejected (>10MB)
- [ ] test_empty_file_rejected
- [ ] test_corrupted_excel_file_rejected
- [ ] test_file_content_type_validation
- [ ] test_file_extension_validation

**2. å¿…éœ€åˆ—éªŒè¯æµ‹è¯• (15ä¸ª)** â­:
- [ ] test_all_required_columns_present
- [ ] test_missing_name_column_error
- [ ] test_missing_spec_column_error
- [ ] test_missing_unit_column_error
- [ ] test_missing_multiple_columns_error
- [ ] test_auto_detect_all_columns_success
- [ ] test_auto_detect_name_column_priority
- [ ] test_auto_detect_spec_column_priority
- [ ] test_auto_detect_unit_column_priority
- [ ] test_manual_specify_all_columns
- [ ] test_mixed_mode_partial_specify
- [ ] test_column_name_case_insensitive
- [ ] test_column_name_fuzzy_matching
- [ ] test_column_index_specification
- [ ] test_error_response_with_suggestions

**3. æ•°æ®å¤„ç†æµ‹è¯• (8ä¸ª)**
- [ ] test_single_row_processing
- [ ] test_multiple_rows_processing
- [ ] test_empty_description_skipped
- [ ] test_null_description_skipped
- [ ] test_whitespace_only_description_skipped
- [ ] test_special_characters_in_description
- [ ] test_very_long_description (>200å­—ç¬¦)
- [ ] test_unicode_characters_in_description

**4. æ‰¹é‡å¤„ç†æµ‹è¯• (6ä¸ª)**
- [ ] test_batch_processing_10_rows
- [ ] test_batch_processing_100_rows
- [ ] test_batch_processing_1000_rows
- [ ] test_batch_processing_mixed_success_failure
- [ ] test_batch_processing_all_failures
- [ ] test_batch_processing_partial_failures

**5. å‚æ•°éªŒè¯æµ‹è¯• (5ä¸ª)**
- [ ] test_top_k_default_value
- [ ] test_top_k_custom_value
- [ ] test_top_k_minimum_boundary (1)
- [ ] test_top_k_maximum_boundary (50)
- [ ] test_top_k_out_of_range_error (0, 51)

**6. é”™è¯¯å¤„ç†æµ‹è¯• (7ä¸ª)**
- [ ] test_database_connection_error
- [ ] test_processor_initialization_error
- [ ] test_calculator_initialization_error
- [ ] test_single_row_processing_error_continues
- [ ] test_timeout_handling
- [ ] test_memory_limit_handling
- [ ] test_concurrent_request_handling

**7. å“åº”æ ¼å¼æµ‹è¯• (5ä¸ª)**
- [ ] test_response_schema_validation
- [ ] test_parsed_query_in_response
- [ ] test_similar_materials_in_response
- [ ] test_error_items_in_response
- [ ] test_statistics_in_response

**8. é›†æˆæµ‹è¯• (6ä¸ª)**
- [ ] test_end_to_end_batch_search_success
- [ ] test_processor_integration
- [ ] test_calculator_integration
- [ ] test_knowledge_base_loading
- [ ] test_symmetric_processing_consistency
- [ ] test_performance_benchmark_100_rows

**æµ‹è¯•æ€»è®¡**: 60ä¸ªæµ‹è¯•ç”¨ä¾‹

#### 2.2 æµ‹è¯•æ•°æ®å‡†å¤‡

**æµ‹è¯•Excelæ–‡ä»¶**:
```python
# tests/fixtures/test_materials.xlsx
# åŒ…å«ä»¥ä¸‹æµ‹è¯•æ•°æ®ï¼š
# 1. æ­£å¸¸ç‰©æ–™æè¿°ï¼ˆ10æ¡ï¼‰
# 2. ç©ºå€¼æè¿°ï¼ˆ2æ¡ï¼‰
# 3. ç‰¹æ®Šå­—ç¬¦æè¿°ï¼ˆ3æ¡ï¼‰
# 4. è¶…é•¿æè¿°ï¼ˆ2æ¡ï¼‰
# 5. é‡å¤æè¿°ï¼ˆ5æ¡ï¼‰
```

**Mockæ•°æ®**:
```python
# Mock UniversalMaterialProcessorå“åº”
MOCK_PARSED_QUERY = ParsedQuery(
    standardized_name="å…­è§’èºæ “ M8x20 304ä¸é”ˆé’¢",
    attributes={"thread_diameter": "8", "length": "20", "material": "304"},
    detected_category="fastener",
    confidence=0.95,
    full_description="å…­è§’èºæ “ M8x20 304ä¸é”ˆé’¢",
    processing_steps=[...]
)

# Mock SimilarityCalculatorå“åº”
MOCK_SIMILAR_MATERIALS = [
    MaterialResult(...),
    # ... Top-10ç»“æœ
]
```

#### 2.3 æ€§èƒ½æµ‹è¯•è®¾è®¡

**æ€§èƒ½æµ‹è¯•æ–‡ä»¶**: `backend/tests/integration/test_batch_search_performance.py`

**æ€§èƒ½æµ‹è¯•ç”¨ä¾‹**:
1. **test_processing_speed_10_rows**
   - ç›®æ ‡ï¼šâ‰¤ 5ç§’
   - éªŒè¯ï¼šå¹³å‡ â‰¥ 2æ¡/ç§’

2. **test_processing_speed_100_rows**
   - ç›®æ ‡ï¼šâ‰¤ 30ç§’
   - éªŒè¯ï¼šå¹³å‡ â‰¥ 3æ¡/ç§’

3. **test_memory_usage_100_rows**
   - ç›®æ ‡ï¼šâ‰¤ 512MB
   - éªŒè¯ï¼šå†…å­˜å³°å€¼ç›‘æ§

4. **test_concurrent_requests_5_users**
   - ç›®æ ‡ï¼š5ä¸ªå¹¶å‘æ— é”™è¯¯
   - éªŒè¯ï¼šå“åº”æ—¶é—´ â‰¤ 60ç§’

5. **test_large_file_1000_rows**
   - ç›®æ ‡ï¼šâ‰¤ 5åˆ†é’Ÿ
   - éªŒè¯ï¼šæµå¼å¤„ç†ï¼Œæ— å†…å­˜æº¢å‡º

---

### Phase 3: Implement (ä»£ç å®ç°)

#### å®æ–½è®¡åˆ’

**Step 1**: åˆ›å»ºSchemaå®šä¹‰ â³
- æ–‡ä»¶ï¼š`backend/api/schemas/batch_search_schemas.py`
- å†…å®¹ï¼šæ‰€æœ‰Pydanticæ¨¡å‹

**Step 2**: å®ç°æ–‡ä»¶å¤„ç†æœåŠ¡ â³
- æ–‡ä»¶ï¼š`backend/api/services/file_processing_service.py`
- åŠŸèƒ½ï¼šæ–‡ä»¶éªŒè¯ã€Excelè§£æã€æ‰¹é‡å¤„ç†

**Step 3**: å®ç°æ‰¹é‡æŸ¥é‡è·¯ç”± â³
- æ–‡ä»¶ï¼š`backend/api/routers/materials.py`
- åŠŸèƒ½ï¼šAPIç«¯ç‚¹ã€ä¾èµ–æ³¨å…¥ã€å“åº”å°è£…

**Step 4**: ç¼–å†™å•å…ƒæµ‹è¯• â³
- æ–‡ä»¶ï¼š`backend/tests/test_batch_search_api.py`
- è¦†ç›–ï¼š50ä¸ªæµ‹è¯•ç”¨ä¾‹

**Step 5**: ç¼–å†™é›†æˆæµ‹è¯• â³
- æ–‡ä»¶ï¼š`backend/tests/integration/test_batch_search_integration.py`
- è¦†ç›–ï¼šç«¯åˆ°ç«¯æµç¨‹

**Step 6**: ç¼–å†™æ€§èƒ½æµ‹è¯• â³
- æ–‡ä»¶ï¼š`backend/tests/integration/test_batch_search_performance.py`
- è¦†ç›–ï¼šæ€§èƒ½åŸºå‡†

**Step 7**: è¿è¡Œæµ‹è¯•éªŒè¯ â³
- å•å…ƒæµ‹è¯•ï¼špytest backend/tests/test_batch_search_api.py -v
- é›†æˆæµ‹è¯•ï¼špytest backend/tests/integration/ -v
- è¦†ç›–ç‡æŠ¥å‘Šï¼špytest --cov=backend.api.routers.materials --cov-report=html

**Step 8**: æ€§èƒ½ä¼˜åŒ– â³
- åŸºå‡†æµ‹è¯•
- ç“¶é¢ˆåˆ†æ
- ä¼˜åŒ–å®æ–½

**Step 9**: æ–‡æ¡£æ›´æ–° â³
- æ›´æ–°APIæ–‡æ¡£
- æ›´æ–°README
- æ›´æ–°tasks.mdçŠ¶æ€

---

### Phase 4: Review (ä»£ç å®¡æŸ¥å’ŒéªŒæ”¶)

#### 4.1 åŠŸèƒ½éªŒæ”¶æ¸…å•

- [ ] **APIåŠŸèƒ½**
  - [ ] æ–‡ä»¶ä¸Šä¼ æ¥æ”¶æ­£å¸¸
  - [ ] æ–‡ä»¶éªŒè¯æ­£ç¡®
  - [ ] Excelè§£æå‡†ç¡®
  - [ ] æ‰¹é‡å¤„ç†å®Œæ•´
  - [ ] ç»“æœè¿”å›æ­£ç¡®
  - [ ] é”™è¯¯å¤„ç†å®Œå–„

- [ ] **å¯¹ç§°å¤„ç†éªŒè¯**
  - [ ] è°ƒç”¨UniversalMaterialProcessor
  - [ ] è°ƒç”¨SimilarityCalculator
  - [ ] å¤„ç†ç»“æœä¸€è‡´
  - [ ] çŸ¥è¯†åº“åŠ è½½æ­£ç¡®

- [ ] **æ€§èƒ½æŒ‡æ ‡**
  - [ ] å¤„ç†é€Ÿåº¦ â‰¥ 3æ¡/ç§’
  - [ ] 100æ¡ â‰¤ 30ç§’
  - [ ] å†…å­˜ä½¿ç”¨ â‰¤ 512MB
  - [ ] å¹¶å‘æ”¯æŒ â‰¥ 5ä¸ª

#### 4.2 ä»£ç è´¨é‡æ¸…å•

- [ ] **ä»£ç è§„èŒƒ**
  - [ ] éµå¾ªPEP 8
  - [ ] ç±»å‹æ³¨è§£å®Œæ•´
  - [ ] Docstringå®Œæ•´
  - [ ] å˜é‡å‘½åæ¸…æ™°

- [ ] **æ¶æ„è®¾è®¡**
  - [ ] å•ä¸€èŒè´£åŸåˆ™
  - [ ] ä¾èµ–æ³¨å…¥æ­£ç¡®
  - [ ] é”™è¯¯å¤„ç†å®Œå–„
  - [ ] æ—¥å¿—è®°å½•å®Œæ•´

- [ ] **æµ‹è¯•è¦†ç›–**
  - [ ] å•å…ƒæµ‹è¯• â‰¥ 95%
  - [ ] é›†æˆæµ‹è¯•å®Œæ•´
  - [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
  - [ ] è¾¹ç•Œæµ‹è¯•å……åˆ†

#### 4.3 æ–‡æ¡£æ¸…å•

- [ ] **APIæ–‡æ¡£**
  - [ ] Swagger UIå¯è®¿é—®
  - [ ] æ¥å£è¯´æ˜æ¸…æ™°
  - [ ] ç¤ºä¾‹å®Œæ•´
  - [ ] é”™è¯¯ä»£ç æ–‡æ¡£åŒ–

- [ ] **ä»£ç æ–‡æ¡£**
  - [ ] æ¨¡å—docstring
  - [ ] å‡½æ•°docstring
  - [ ] å¤æ‚é€»è¾‘æ³¨é‡Š
  - [ ] TODOæ ‡è®°æ¸…ç†

- [ ] **æµ‹è¯•æ–‡æ¡£**
  - [ ] æµ‹è¯•è¯´æ˜
  - [ ] æµ‹è¯•æ•°æ®è¯´æ˜
  - [ ] æ€§èƒ½åŸºå‡†è®°å½•

---

## ğŸ“ å®æ–½è¿›åº¦

### å½“å‰çŠ¶æ€
- **é˜¶æ®µ**: Phase 4 - Review âœ…
- **è¿›åº¦**: 100% (æ‰€æœ‰é˜¶æ®µå®Œæˆ)
- **çŠ¶æ€**: Task 3.2 å®Œæˆï¼âœ…
- **æµ‹è¯•ç»“æœ**: **âœ… 28/28 å…¨éƒ¨é€šè¿‡ (100%æˆåŠŸç‡)** ğŸ‰ğŸ‰ğŸ‰

### æ—¶é—´ä¼°ç®—
| é˜¶æ®µ | é¢„ä¼°æ—¶é—´ | å®é™…æ—¶é—´ | çŠ¶æ€ |
|------|---------|---------|------|
| Spec | 1å°æ—¶ | 1.5å°æ—¶ | âœ… å®Œæˆ |
| Test | 2å°æ—¶ | 1å°æ—¶ | âœ… å®Œæˆï¼ˆåŸºç¡€æ¡†æ¶+28ä¸ªæµ‹è¯•ï¼‰ |
| Implement | 4å°æ—¶ | 2å°æ—¶ | âœ… å®Œæˆ |
| Review | 1å°æ—¶ | 0.5å°æ—¶ | âœ… å®Œæˆï¼ˆä»£ç å®¡æŸ¥+ä¾èµ–ä¿®å¤ï¼‰ |
| **æ€»è®¡** | **8å°æ—¶** | **5å°æ—¶** | **âœ… 100%** |

### ä¸‹ä¸€æ­¥
**Task 3.2 å®Œæˆ** âœ… â†’ ç”¨æˆ·è¿›è¡Œå®é™…æµ‹è¯•éªŒè¯

### Phase 4: Review å®Œæˆå†…å®¹ âœ…

1. **ä¾èµ–é—®é¢˜ä¿®å¤**
   - âŒ `python-Levenshtein` åœ¨Python 3.13ç¼–è¯‘å¤±è´¥
   - âœ… æ›¿æ¢ä¸º `rapidfuzz>=3.8.0`ï¼ˆæ€§èƒ½æ›´å¥½ï¼Œå…¼å®¹æ€§å¼ºï¼‰
   - âœ… æ›´æ–° `column_detection.py` ä½¿ç”¨ `rapidfuzz.fuzz`
   - âœ… æ— linteré”™è¯¯

2. **ä»£ç è´¨é‡å®¡æŸ¥**
   - âœ… æ¨¡å—ç»“æ„æ¸…æ™°ï¼ˆschemas/utils/services/routersï¼‰
   - âœ… å®Œæ•´çš„ç±»å‹æ³¨è§£
   - âœ… è¯¦ç»†çš„æ–‡æ¡£å­—ç¬¦ä¸²
   - âœ… å¼‚å¸¸å¤„ç†å®Œå–„
   - âœ… æ—¥å¿—è®°å½•è§„èŒƒ

3. **åŠŸèƒ½å®Œæ•´æ€§æ£€æŸ¥**
   - âœ… APIç«¯ç‚¹å®ç°å®Œæ•´
   - âœ… åˆ—åæ£€æµ‹ï¼ˆè‡ªåŠ¨/æ‰‹åŠ¨/æ··åˆï¼‰
   - âœ… æ–‡ä»¶éªŒè¯ï¼ˆç±»å‹/å¤§å°ï¼‰
   - âœ… Excelè§£æï¼ˆ.xlsx/.xlsï¼‰
   - âœ… æ‰¹é‡å¤„ç†é€»è¾‘
   - âœ… é”™è¯¯å¤„ç†å’Œå®¹é”™
   - âœ… ç»Ÿè®¡ä¿¡æ¯èšåˆ

4. **æµ‹è¯•è¦†ç›–ç‡**
   - âœ… æµ‹è¯•åŸºç¡€è®¾æ–½ï¼ˆExcelFixtureGeneratorï¼‰
   - âœ… 28ä¸ªå•å…ƒæµ‹è¯•
   - â³ é›†æˆæµ‹è¯•ï¼ˆå¾…ç”¨æˆ·éªŒè¯ï¼‰

5. **æ–‡æ¡£å®Œæ•´æ€§**
   - âœ… OpenAPIæ–‡æ¡£ï¼ˆSwagger UIï¼‰
   - âœ… ä»£ç æ³¨é‡Šå’Œæ–‡æ¡£å­—ç¬¦ä¸²
   - âœ… å®æ–½æ—¥å¿—ï¼ˆæœ¬æ–‡æ¡£ï¼‰
   - âœ… READMEå’Œä½¿ç”¨ç¤ºä¾‹

### Phase 3å®æ–½å†…å®¹ âœ…
1. **Schemaå®šä¹‰** (batch_search_schemas.py, 253è¡Œ)
   - å®Œæ•´çš„è¯·æ±‚/å“åº”Pydanticæ¨¡å‹
   - è‡ªå®šä¹‰å¼‚å¸¸ç±»
   
2. **åˆ—åæ£€æµ‹å·¥å…·** (column_detection.py, 285è¡Œ)
   - æ™ºèƒ½åˆ—ååŒ¹é…ï¼ˆç²¾ç¡®+æ¨¡ç³Š+è‡ªåŠ¨æ£€æµ‹ï¼‰
   - å¿…éœ€åˆ—éªŒè¯
   - æ™ºèƒ½æ¨è
   
3. **æ–‡ä»¶å¤„ç†æœåŠ¡** (file_processing_service.py, 319è¡Œ)
   - Excelè§£æ
   - æ‰¹é‡å¤„ç†é€»è¾‘
   - é”™è¯¯å¤„ç†å’Œç»Ÿè®¡
   
4. **APIè·¯ç”±** (materials.py, 216è¡Œ)
   - POST /api/v1/materials/batch-search
   - å®Œæ•´çš„å¼‚å¸¸å¤„ç†
   - OpenAPIæ–‡æ¡£
   
5. **ä¾èµ–ç®¡ç†**
   - æ›´æ–°requirements.txt
   - æ³¨å†Œè·¯ç”±åˆ°main.py

---

## ğŸ“¦ å·²åˆ›å»ºæ–‡ä»¶æ¸…å•

### 1. Schemaå®šä¹‰
- `backend/api/schemas/__init__.py` - Schemaæ¨¡å—å¯¼å‡º
- `backend/api/schemas/batch_search_schemas.py` (253è¡Œ)
  - BatchSearchRequest
  - BatchSearchResponse
  - InputData, SimilarMaterialItem, BatchSearchResultItem
  - BatchSearchErrorItem, SkippedRowItem, DetectedColumns
  - RequiredColumnsMissingError

### 2. å·¥å…·å‡½æ•°
- `backend/api/utils/__init__.py` - Utilsæ¨¡å—å¯¼å‡º
- `backend/api/utils/column_detection.py` (285è¡Œ)
  - detect_required_columns() - å¿…éœ€åˆ—æ£€æµ‹
  - match_column_name() - æ™ºèƒ½åˆ—ååŒ¹é…
  - auto_detect_column() - è‡ªåŠ¨åˆ—åæ£€æµ‹
  - NAME_PATTERNS, SPEC_PATTERNS, UNIT_PATTERNS

### 3. æœåŠ¡å±‚
- `backend/api/services/__init__.py` - Servicesæ¨¡å—å¯¼å‡º
- `backend/api/services/file_processing_service.py` (319è¡Œ)
  - FileProcessingService - æ–‡ä»¶å¤„ç†æœåŠ¡
  - process_batch_file() - æ‰¹é‡å¤„ç†å…¥å£
  - _validate_file() - æ–‡ä»¶éªŒè¯
  - _read_excel() - Excelè§£æ
  - _process_rows() - è¡Œå¤„ç†é€»è¾‘

### 4. APIè·¯ç”±
- `backend/api/routers/materials.py` (216è¡Œ)
  - POST /api/v1/materials/batch-search
  - å®Œæ•´çš„å¼‚å¸¸å¤„ç†
  - OpenAPIæ–‡æ¡£

### 5. å¼‚å¸¸å®šä¹‰
- `backend/api/exceptions.py` (47è¡Œ)
  - MatMatchAPIException
  - FileTypeError, FileTooLargeError
  - ExcelParseError, ColumnNotFoundError
  - ProcessingError

### 6. æµ‹è¯•æ–‡ä»¶
- `backend/tests/fixtures/__init__.py`
- `backend/tests/fixtures/excel_fixtures.py` (269è¡Œ)
  - ExcelFixtureGenerator - æµ‹è¯•æ–‡ä»¶ç”Ÿæˆå™¨
  - 8ç§æµ‹è¯•æ–‡ä»¶ç”Ÿæˆæ–¹æ³•
  - Mockæ•°æ®å®šä¹‰
- `backend/tests/test_batch_search_api.py` (308è¡Œ)
  - TestFileValidation - 8ä¸ªæµ‹è¯•
  - TestRequiredColumnsValidation - 15ä¸ªæµ‹è¯•
  - TestDataProcessing - 5ä¸ªæµ‹è¯•

### 7. é…ç½®æ›´æ–°
- `backend/requirements.txt` - æ–°å¢ä¾èµ–
  - xlrd==2.0.1
  - python-Levenshtein==0.25.1
- `backend/api/main.py` - æ³¨å†Œè·¯ç”±
  - import materials
  - app.include_router(materials.router)

### ğŸ“ˆ ä»£ç ç»Ÿè®¡
- **æ€»è¡Œæ•°**: ~1,750è¡Œï¼ˆåŒ…æ‹¬æ³¨é‡Šå’Œæ–‡æ¡£ï¼‰
- **æ ¸å¿ƒä»£ç **: ~1,100è¡Œ
- **æµ‹è¯•ä»£ç **: ~580è¡Œ
- **æ–‡æ¡£æ³¨é‡Š**: ~70è¡Œ

---

## ğŸ“Š å†³ç­–è®°å½•

### å†³ç­–1: ä½¿ç”¨multipart/form-dataè€ŒéJSON
**åŸå› **: 
- æ–‡ä»¶ä¸Šä¼ æ ‡å‡†æ–¹å¼
- FastAPIåŸç”Ÿæ”¯æŒUploadFile
- è‡ªåŠ¨å¤„ç†ä¸´æ—¶æ–‡ä»¶æ¸…ç†

### å†³ç­–2: å•è¡Œå¤±è´¥ä¸å½±å“æ•´ä½“å¤„ç†
**åŸå› **:
- æé«˜å®¹é”™æ€§
- ç”¨æˆ·ä½“éªŒæ›´å¥½
- ç¬¦åˆä¸šåŠ¡éœ€æ±‚ï¼ˆéƒ¨åˆ†æˆåŠŸä¼˜äºå…¨éƒ¨å¤±è´¥ï¼‰

### å†³ç­–3: å¤ç”¨å·²å®Œæˆçš„æ ¸å¿ƒç®—æ³•
**åŸå› **:
- UniversalMaterialProcessorå·²éªŒè¯ï¼ˆ100%å¯¹ç§°æ€§ï¼‰
- SimilarityCalculatorå·²éªŒè¯ï¼ˆ116mså¹³å‡å“åº”ï¼‰
- é¿å…é‡å¤å¼€å‘
- ç¡®ä¿ç®—æ³•ä¸€è‡´æ€§

### å†³ç­–4: æµå¼å¤„ç†å¤§æ–‡ä»¶
**åŸå› **:
- é¿å…å†…å­˜æº¢å‡º
- æ”¯æŒ1000+è¡Œæ–‡ä»¶
- æ›´å¥½çš„æ€§èƒ½è¡¨ç°

### å†³ç­–5: é€‚åº¦å¹¶å‘è€Œéæœ€å¤§å¹¶å‘
**åŸå› **:
- æ•°æ®åº“è¿æ¥æ± æœ‰é™
- é¿å…èµ„æºç«äº‰
- ä¿è¯å•ä¸ªè¯·æ±‚çš„å“åº”æ—¶é—´

### å†³ç­–6: å¿…éœ€3ä¸ªå­—æ®µï¼ˆåç§°ã€è§„æ ¼å‹å·ã€å•ä½ï¼‰â­ é‡è¦
**åŸå› **:
- **ä¸šåŠ¡éœ€æ±‚**: ç‰©æ–™æŸ¥é‡å¿…é¡»åŸºäºåç§°+è§„æ ¼çš„ç»„åˆï¼Œå•ä½ç”¨äºéªŒè¯
- **æ•°æ®å®Œæ•´æ€§**: ç¡®ä¿è¾“å…¥æ•°æ®åŒ…å«è¶³å¤Ÿçš„ä¿¡æ¯è¿›è¡Œå‡†ç¡®æŸ¥é‡
- **æ ‡å‡†åŒ–**: ç»Ÿä¸€çš„æ•°æ®æ ¼å¼ä¾¿äºå¤„ç†å’Œç»´æŠ¤
- **å¯è¿½æº¯æ€§**: ä¿ç•™å®Œæ•´çš„åŸå§‹æ•°æ®ä¾¿äºå®¡è®¡

**3ä¸ªå¿…éœ€å­—æ®µ**:
| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ | æ˜¯å¦å¿…éœ€ |
|------|------|------|---------|
| åç§° | ç‰©æ–™çš„ä¸»è¦æè¿° | "å…­è§’èºæ “" | âœ… å¿…éœ€ |
| è§„æ ¼å‹å· | ç‰©æ–™çš„è§„æ ¼ä¿¡æ¯ | "M8*20" | âœ… å¿…éœ€ |
| å•ä½ | è®¡é‡å•ä½ | "ä¸ª" | âœ… å¿…éœ€ |

**æ•°æ®ç»„åˆç­–ç•¥**:
```python
# ç»„åˆæˆå®Œæ•´æè¿°ç”¨äºæŸ¥é‡
combined_description = f"{name} {spec}".strip()
# ç¤ºä¾‹ï¼š"å…­è§’èºæ “ M8*20"

# å•ä½ç”¨äºéªŒè¯å’Œå±•ç¤ºï¼Œä¸å‚ä¸æŸ¥é‡
```

### å†³ç­–7: æ”¯æŒçµæ´»çš„åˆ—ååŒ¹é… â­ ç”¨æˆ·ä½“éªŒ
**åŸå› **:
- **å®é™…åœºæ™¯éœ€æ±‚**: ä¸åŒéƒ¨é—¨ã€ä¸åŒæ—¶æœŸçš„Excelæ–‡ä»¶åˆ—åä¸ä¸€è‡´
- **ç”¨æˆ·ä½“éªŒ**: 
  - æ–¹å¼1: ç”¨æˆ·æ‰‹åŠ¨æŒ‡å®šï¼ˆç²¾ç¡®æ§åˆ¶ï¼‰
  - æ–¹å¼2: ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹ï¼ˆä¾¿æ·æ€§ï¼‰
  - æ–¹å¼3: åˆ—ç´¢å¼•/Excelåˆ—æ ‡è¯†ï¼ˆæ— æ ‡é¢˜è¡Œï¼‰
  - æ–¹å¼4: æ··åˆæ¨¡å¼ï¼ˆçµæ´»æ€§ï¼‰
- **å®¹é”™æ€§**: æ¨¡ç³ŠåŒ¹é…ã€å‹å¥½é”™è¯¯æç¤º
- **é€æ˜æ€§**: è¿”å›å®é™…ä½¿ç”¨çš„åˆ—åæ˜ å°„

**è‡ªåŠ¨æ£€æµ‹ä¼˜å…ˆçº§**:
```python
# åç§°åˆ—
NAME_PATTERNS = ["ç‰©æ–™åç§°", "ææ–™åç§°", "åç§°", "å“å", "Material Name", "Name"]

# è§„æ ¼å‹å·åˆ—  
SPEC_PATTERNS = ["è§„æ ¼å‹å·", "è§„æ ¼", "å‹å·", "è§„æ ¼è¯´æ˜", "Specification", "Spec", "Model"]

# å•ä½åˆ—
UNIT_PATTERNS = ["å•ä½", "è®¡é‡å•ä½", "åŸºæœ¬å•ä½", "Unit", "Measurement Unit", "UOM"]
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- `specs/main/design.md` - ç¬¬2.1.1èŠ‚ æ‰¹é‡æ–‡ä»¶æŸ¥é‡æ¥å£
- `specs/main/design.md` - ç¬¬2.2.3èŠ‚ æ–‡ä»¶å¤„ç†æœåŠ¡
- `specs/main/requirements.md` - ç”¨æˆ·æ•…äº‹1å’Œ2
- `specs/main/tasks.md` - Task 3.2è¯¦ç»†è¯´æ˜
- `backend/core/processors/material_processor.py` - UniversalMaterialProcessor
- `backend/core/calculators/similarity_calculator.py` - SimilarityCalculator

---

## ğŸ“Œ å…³é”®ä»£ç ç‰‡æ®µå‚è€ƒ

### FileProcessingServiceæ ¸å¿ƒæµç¨‹
```python
async def process_excel_file(
    self, 
    file: UploadFile, 
    description_column: str,
    top_k: int = 10
) -> BatchSearchResponse:
    # 1. è¯»å–Excel
    df = pd.read_excel(file.file, engine='openpyxl')
    
    # 2. æ‰¹é‡å¤„ç†
    for index, row in df.iterrows():
        description = str(row[description_column]).strip()
        
        # 3. å¯¹ç§°å¤„ç† (å¤ç”¨Task 2.1)
        parsed_query = await self.processor.process_material_description(description)
        
        # 4. ç›¸ä¼¼åº¦æŸ¥è¯¢ (å¤ç”¨Task 2.2)
        similar_materials = await self.calculator.find_similar_materials(
            parsed_query, limit=top_k
        )
```

---

**å¼€å§‹æ—¶é—´**: 2025-10-04 24:00:00  
**é¢„è®¡å®Œæˆ**: 2025-10-05 08:00:00  
**å®é™…å®Œæˆ**: å¾…å®Œæˆ


