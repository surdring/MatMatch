# 导出功能增强 - 选择保存路径

**优化时间**: 2025-10-07  
**优化目标**: 导出Excel时允许用户选择保存路径

---

## ✅ 完成的功能

### 1️⃣ 列名配置增加分类字段

**修改文件**: `frontend/src/components/MaterialSearch/ColumnConfig.vue`

#### 新增内容：
- ✅ 添加"分类列"配置项
- ✅ 更新`ColumnMapping`接口，增加`categoryName`字段
- ✅ 添加分类列的智能检测规则
- ✅ 配置预览中显示分类映射
- ✅ `autoDetect()`方法自动识别分类列

#### 检测关键词：
```typescript
categoryName: [
  '分类', '物料分类', '类别', '类型', 'category', 
  'category_name', '品类', '大类', '物料类别'
]
```

---

### 2️⃣ 导出功能支持选择保存路径

**修改文件**: `frontend/src/views/MaterialSearch.vue`

#### 核心技术：
使用**File System Access API** (`showSaveFilePicker`)

#### 实现方案：

##### 方案A：现代浏览器（Chrome 86+, Edge 86+）
```typescript
// 弹出文件保存对话框
if ('showSaveFilePicker' in window) {
  const fileHandle = await showSaveFilePicker({
    suggestedName: '物料查重结果_2025-10-07.xlsx',
    types: [{
      description: 'Excel文件',
      accept: { 
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'] 
      }
    }]
  })
  
  // 写入文件
  const writable = await fileHandle.createWritable()
  const buffer = XLSX.write(wb, { type: 'buffer', bookType: 'xlsx' })
  await writable.write(buffer)
  await writable.close()
}
```

**用户体验**:
1. 点击"导出结果"按钮
2. 弹出Windows/macOS原生文件保存对话框
3. 用户选择保存位置和文件名
4. 文件保存到指定位置
5. 提示"✅ 导出成功！文件已保存"

##### 方案B：旧版浏览器（降级方案）
```typescript
else {
  // 直接下载到浏览器默认下载目录
  XLSX.writeFile(wb, defaultFileName)
  
  ElMessage.success({
    message: `✅ 导出成功！文件已保存到下载文件夹：${defaultFileName}`
  })
}
```

---

## 📊 浏览器兼容性

| 浏览器 | 版本 | 支持情况 | 用户体验 |
|--------|------|---------|---------|
| **Chrome** | 86+ | ✅ 完全支持 | 弹出文件选择器 |
| **Edge** | 86+ | ✅ 完全支持 | 弹出文件选择器 |
| **Firefox** | - | ❌ 不支持 | 降级：下载文件夹 |
| **Safari** | - | ❌ 不支持 | 降级：下载文件夹 |

**注意**: 
- Firefox和Safari会自动降级到传统下载方式
- 用户体验仍然流畅，只是无法选择保存位置
- 文件会保存到浏览器默认下载文件夹

---

## 🎯 修改的导出功能

### 1. 批量导出 (`handleExport`)
```typescript
// 文件名格式
物料查重结果_2025-10-07-14-30-25.xlsx

// 导出内容
- 行号
- 输入-物料名称、规格型号、单位、分类
- AI推荐分类、分类置信度
- 查重结论
- [如果重复] 匹配数量、最高相似度、推荐ERP物料信息
- [如果不重复] 留空或"-"
```

### 2. 单条导出 (`handleExportSingleResult`)
```typescript
// 文件名格式
物料查重详情_[物料名称]_2025-10-07-14-30-25.xlsx

// 重复物料导出内容：
- 排名（1-5）
- 物料信息（名称、规格、单位、分类）
- AI推荐分类、置信度
- 查重结论
- ERP相似物料信息（编码、名称、规格、单位、相似度）

// 不重复物料导出内容：
- 物料信息
- AI推荐分类、置信度
- 查重结论
- 备注：未找到相似物料，建议创建新物料
```

---

## 💡 用户操作流程

### 现代浏览器（Chrome/Edge）

```
1. 点击"导出结果"按钮
   ↓
2. 弹出文件保存对话框
   ┌─────────────────────────────────┐
   │  保存为                          │
   │  ┌─────────────────────────────┐│
   │  │ 文档/Downloads/桌面...       ││  ← 可选择位置
   │  └─────────────────────────────┘│
   │                                  │
   │  文件名:                         │
   │  ┌─────────────────────────────┐│
   │  │ 物料查重结果_2025-10-07... ││  ← 可修改名称
   │  └─────────────────────────────┘│
   │                                  │
   │  文件类型: Excel文件 (.xlsx)    │
   │                                  │
   │     [取消]         [保存]       │
   └─────────────────────────────────┘
   ↓
3. 选择保存位置，修改文件名（可选）
   ↓
4. 点击"保存"
   ↓
5. 提示"✅ 导出成功！文件已保存"
```

### 旧版浏览器（Firefox/Safari）

```
1. 点击"导出结果"按钮
   ↓
2. 文件自动下载到"下载"文件夹
   ↓
3. 浏览器底部显示下载进度
   ↓
4. 提示"✅ 导出成功！文件已保存到下载文件夹：物料查重结果_xxx.xlsx"
```

---

## 🔧 技术实现细节

### File System Access API 权限

**首次使用时**:
- 浏览器会请求文件系统访问权限
- 用户选择保存位置即授予权限
- 后续导出不需要重复授权（同一会话内）

**权限范围**:
- 仅限用户主动选择的文件和目录
- 不能访问系统敏感目录
- 用户完全控制访问权限

### 错误处理

```typescript
.catch((err: any) => {
  if (err.name !== 'AbortError') {
    // AbortError = 用户点击取消，不提示错误
    console.error('Save file error:', err)
    ElMessage.warning({
      message: '⚠️ 取消保存或保存失败，请重试',
      duration: 3000
    })
  }
})
```

**错误类型**:
- `AbortError`: 用户取消（不提示）
- `SecurityError`: 权限拒绝
- `NotAllowedError`: 用户未授权
- 其他错误: 文件写入失败

---

## 📝 代码示例

### 完整的导出函数

```typescript
const handleExport = () => {
  // 1. 数据验证
  if (currentResults.value.length === 0) {
    ElMessage.warning('⚠️ 暂无数据可导出')
    return
  }

  try {
    // 2. 准备导出数据
    const exportData = currentResults.value.map(item => {
      // ... 数据处理逻辑
    })

    // 3. 创建Excel工作簿
    const ws = XLSX.utils.json_to_sheet(exportData)
    const wb = XLSX.utils.book_new()
    XLSX.utils.book_append_sheet(wb, ws, '查重结果')

    // 4. 生成文件名
    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-')
    const defaultFileName = `物料查重结果_${timestamp}.xlsx`

    // 5. 选择保存位置（现代浏览器）
    if ('showSaveFilePicker' in window) {
      ;(window as any).showSaveFilePicker({
        suggestedName: defaultFileName,
        types: [{
          description: 'Excel文件',
          accept: { 
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'] 
          }
        }]
      }).then(async (fileHandle: any) => {
        // 6. 写入文件
        const writable = await fileHandle.createWritable()
        const buffer = XLSX.write(wb, { type: 'buffer', bookType: 'xlsx' })
        await writable.write(buffer)
        await writable.close()
        
        // 7. 成功提示
        ElMessage.success({ message: `✅ 导出成功！文件已保存` })
      }).catch((err: any) => {
        // 8. 错误处理
        if (err.name !== 'AbortError') {
          ElMessage.warning({ message: '⚠️ 取消保存或保存失败' })
        }
      })
    } else {
      // 降级方案：直接下载
      XLSX.writeFile(wb, defaultFileName)
      ElMessage.success({ 
        message: `✅ 导出成功！文件已保存到下载文件夹：${defaultFileName}` 
      })
    }
  } catch (error: any) {
    console.error('Export error:', error)
    ElMessage.error({ message: `❌ 导出失败：${error.message}` })
  }
}
```

---

## 🎯 用户体验改进

### 改进前
```
点击"导出" → 文件自动下载到"下载"文件夹 → 用户需要手动移动文件
```
**痛点**:
- ❌ 无法选择保存位置
- ❌ 文件混在其他下载中
- ❌ 需要手动整理文件

### 改进后
```
点击"导出" → 弹出文件选择器 → 用户选择保存位置 → 文件保存到指定位置
```
**优势**:
- ✅ 自由选择保存位置
- ✅ 可立即保存到目标文件夹（如桌面、项目文件夹）
- ✅ 可修改文件名
- ✅ 避免文件混乱

---

## 🌐 浏览器支持检测

### 检测代码
```typescript
if ('showSaveFilePicker' in window) {
  // 支持File System Access API
} else {
  // 不支持，使用降级方案
}
```

### 运行时检测
```javascript
// 在浏览器控制台中测试
console.log('支持File System Access API:', 'showSaveFilePicker' in window)

// Chrome 86+, Edge 86+: true
// Firefox, Safari: false
```

---

## 📦 相关文件

### 修改文件
- ✅ `frontend/src/views/MaterialSearch.vue`
  - 修改`handleExport()`函数
  - 修改`handleExportSingleResult()`函数
- ✅ `frontend/src/components/MaterialSearch/ColumnConfig.vue`
  - 添加分类字段配置
  - 更新接口定义和检测规则

---

## 🎉 总结

### 完成的功能
1. ✅ **列名配置增加分类字段**
   - 自动检测分类列
   - 配置预览显示分类
   - 支持手动选择或输入

2. ✅ **导出功能支持选择保存路径**
   - 现代浏览器：原生文件选择器
   - 旧版浏览器：自动降级
   - 用户体验显著提升

### 技术亮点
- 🎯 渐进式增强（Progressive Enhancement）
- 🔄 优雅降级（Graceful Degradation）
- 🌐 跨浏览器兼容
- 💡 原生体验

### 用户收益
- 💾 更灵活的文件管理
- 📂 更高效的工作流程
- ✨ 更好的使用体验

---

**优化完成！** 🎉

