# Task 3.3: å…¶ä»–APIç«¯ç‚¹å®ç° - S.T.I.R.å¼€å‘æ—¥å¿—

**ä»»åŠ¡ç¼–å·**: Task 3.3  
**å¼€å§‹æ—¶é—´**: 2025-10-05  
**è´Ÿè´£äºº**: AIåŠ©æ‰‹  
**é¢„ä¼°å·¥ä½œé‡**: 3å¤©  
**ä¼˜å…ˆçº§**: P1 (é‡è¦ä½†éå…³é”®)

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

### ä¾èµ–å…³ç³»
- âœ… Task 2.1: UniversalMaterialProcessor (å·²å®Œæˆ)
- âœ… Task 2.2: SimilarityCalculator (å·²å®Œæˆ)
- âœ… Task 3.1: FastAPIæ ¸å¿ƒæœåŠ¡æ¡†æ¶ (å·²å®Œæˆ)
- âœ… Task 3.2: æ‰¹é‡æŸ¥é‡API (å·²å®Œæˆ)

### ç›®æ ‡
å®ç°ä»¥ä¸‹APIç«¯ç‚¹ä»¥æ”¯æŒç‰©æ–™æŸ¥è¯¢å’Œç®¡ç†åŠŸèƒ½ï¼š

1. **GET /api/v1/materials/{erp_code}** - å•ä¸ªç‰©æ–™æŸ¥è¯¢
2. **GET /api/v1/materials/{erp_code}/details** - ç‰©æ–™è¯¦æƒ…
3. **GET /api/v1/materials/{erp_code}/similar** - ç›¸ä¼¼ç‰©æ–™æŸ¥è¯¢
4. **GET /api/v1/categories** - ç‰©æ–™åˆ†ç±»åˆ—è¡¨
5. **GET /api/v1/materials/search** - ç‰©æ–™æœç´¢æ¥å£

---

## ğŸ¯ Phase 1: Spec (è§„æ ¼è¯´æ˜)

### 1.1 APIç«¯ç‚¹è¯¦ç»†è®¾è®¡

#### ç«¯ç‚¹1: å•ä¸ªç‰©æ–™æŸ¥è¯¢
```python
@router.get("/{erp_code}", response_model=MaterialDetailResponse)
async def get_material_by_code(
    erp_code: str,
    db: AsyncSession = Depends(get_db)
) -> MaterialDetailResponse:
    """
    æ ¹æ®ERPç¼–ç æŸ¥è¯¢å•ä¸ªç‰©æ–™çš„åŸºæœ¬ä¿¡æ¯
    
    Args:
        erp_code: ERPç‰©æ–™ç¼–ç 
        db: æ•°æ®åº“ä¼šè¯
        
    Returns:
        MaterialDetailResponse: ç‰©æ–™è¯¦æƒ…
        
    Raises:
        MaterialNotFoundError: ç‰©æ–™ä¸å­˜åœ¨
    """
```

**è¾“å…¥**:
- `erp_code`: string, å¿…éœ€, ERPç‰©æ–™ç¼–ç 

**è¾“å‡º**:
```json
{
  "erp_code": "string",
  "material_name": "string",
  "specification": "string",
  "model": "string",
  "category_name": "string",
  "unit_name": "string",
  "normalized_name": "string",
  "attributes": {},
  "detected_category": "string",
  "category_confidence": 0.95,
  "enable_state": 2,
  "created_at": "2025-10-05T10:00:00",
  "updated_at": "2025-10-05T10:00:00"
}
```

**æ€§èƒ½è¦æ±‚**: 
- å“åº”æ—¶é—´ â‰¤ 200ms
- ä½¿ç”¨ç¼“å­˜ä¼˜åŒ–

---

#### ç«¯ç‚¹2: ç‰©æ–™è¯¦æƒ…ï¼ˆæ‰©å±•ä¿¡æ¯ï¼‰
```python
@router.get("/{erp_code}/details", response_model=MaterialFullDetailResponse)
async def get_material_details(
    erp_code: str,
    db: AsyncSession = Depends(get_db)
) -> MaterialFullDetailResponse:
    """
    è·å–ç‰©æ–™çš„å®Œæ•´è¯¦æƒ…ï¼ŒåŒ…æ‹¬åˆ†ç±»ä¿¡æ¯ã€å•ä½ä¿¡æ¯ã€OracleåŸå§‹å­—æ®µç­‰
    """
```

**è¾“å‡º**ï¼ˆæ¯”åŸºæœ¬æŸ¥è¯¢å¤šè¿”å›ï¼‰:
```json
{
  // ... åŸºæœ¬ä¿¡æ¯ ...
  "category_info": {
    "oracle_category_id": "string",
    "category_code": "string",
    "category_name": "string",
    "parent_category_id": "string"
  },
  "unit_info": {
    "oracle_unit_id": "string",
    "unit_code": "string",
    "unit_name": "string",
    "english_name": "string",
    "scale_factor": 1.0
  },
  "oracle_metadata": {
    "oracle_material_id": "string",
    "oracle_org_id": "string",
    "oracle_created_time": "2025-01-01T00:00:00",
    "oracle_modified_time": "2025-10-01T00:00:00"
  }
}
```

---

#### ç«¯ç‚¹3: ç›¸ä¼¼ç‰©æ–™æŸ¥è¯¢
```python
@router.get("/{erp_code}/similar", response_model=SimilarMaterialsResponse)
async def get_similar_materials(
    erp_code: str,
    limit: int = Query(default=10, ge=1, le=50),
    db: AsyncSession = Depends(get_db),
    processor: UniversalMaterialProcessor = Depends(get_material_processor),
    calculator: SimilarityCalculator = Depends(get_similarity_calculator)
) -> SimilarMaterialsResponse:
    """
    æŸ¥æ‰¾ä¸æŒ‡å®šç‰©æ–™ç›¸ä¼¼çš„å…¶ä»–ç‰©æ–™
    
    æµç¨‹:
    1. æ ¹æ®erp_codeæŸ¥è¯¢ç‰©æ–™
    2. ä½¿ç”¨è¯¥ç‰©æ–™çš„normalized_nameå’Œattributesä½œä¸ºæŸ¥è¯¢æ¡ä»¶
    3. è°ƒç”¨SimilarityCalculatoræŸ¥æ‰¾ç›¸ä¼¼ç‰©æ–™
    """
```

**è¾“å…¥**:
- `erp_code`: string, å¿…éœ€
- `limit`: int, å¯é€‰, é»˜è®¤10, èŒƒå›´1-50

**è¾“å‡º**:
```json
{
  "source_material": {
    "erp_code": "string",
    "material_name": "string",
    "normalized_name": "string"
  },
  "similar_materials": [
    {
      "erp_code": "string",
      "material_name": "string",
      "similarity_score": 0.95,
      "similarity_breakdown": {
        "name_similarity": 0.98,
        "description_similarity": 0.92,
        "attributes_similarity": 0.85,
        "category_match": 1.0
      }
    }
  ],
  "total_found": 10
}
```

---

#### ç«¯ç‚¹4: ç‰©æ–™åˆ†ç±»åˆ—è¡¨
```python
@router.get("/categories", response_model=CategoriesListResponse)
async def get_categories(
    parent_id: Optional[str] = Query(None, description="çˆ¶åˆ†ç±»IDï¼Œä¸ä¼ åˆ™è¿”å›é¡¶çº§åˆ†ç±»"),
    page: int = Query(default=1, ge=1),
    page_size: int = Query(default=20, ge=1, le=100),
    db: AsyncSession = Depends(get_db)
) -> CategoriesListResponse:
    """
    è·å–ç‰©æ–™åˆ†ç±»åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µå’Œå±‚çº§æŸ¥è¯¢ï¼‰
    """
```

**è¾“å…¥**:
- `parent_id`: string, å¯é€‰, çˆ¶åˆ†ç±»ID
- `page`: int, å¯é€‰, é»˜è®¤1
- `page_size`: int, å¯é€‰, é»˜è®¤20, èŒƒå›´1-100

**è¾“å‡º**:
```json
{
  "categories": [
    {
      "oracle_category_id": "string",
      "category_code": "string",
      "category_name": "string",
      "parent_category_id": "string",
      "category_level": 1,
      "material_count": 1500,
      "detection_keywords": ["è½´æ‰¿", "bearing"],
      "enable_state": 2
    }
  ],
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total_items": 100,
    "total_pages": 5
  }
}
```

---

#### ç«¯ç‚¹5: ç‰©æ–™æœç´¢
```python
@router.get("/search", response_model=MaterialSearchResponse)
async def search_materials(
    keyword: str = Query(..., min_length=1, description="æœç´¢å…³é”®è¯"),
    category_id: Optional[str] = Query(None, description="æŒ‰åˆ†ç±»ç­›é€‰"),
    enable_state: Optional[int] = Query(None, description="å¯ç”¨çŠ¶æ€"),
    page: int = Query(default=1, ge=1),
    page_size: int = Query(default=20, ge=1, le=100),
    db: AsyncSession = Depends(get_db)
) -> MaterialSearchResponse:
    """
    ç‰©æ–™æœç´¢ï¼ˆæ”¯æŒå…³é”®è¯ã€åˆ†ç±»ã€çŠ¶æ€ç­›é€‰ï¼‰
    
    æœç´¢èŒƒå›´:
    - material_name
    - specification
    - model
    - short_name
    - mnemonic_code
    """
```

**è¾“å…¥**:
- `keyword`: string, å¿…éœ€, æœç´¢å…³é”®è¯
- `category_id`: string, å¯é€‰, åˆ†ç±»ç­›é€‰
- `enable_state`: int, å¯é€‰, å¯ç”¨çŠ¶æ€
- `page`: int, å¯é€‰, é»˜è®¤1
- `page_size`: int, å¯é€‰, é»˜è®¤20

**è¾“å‡º**:
```json
{
  "materials": [
    {
      "erp_code": "string",
      "material_name": "string",
      "specification": "string",
      "category_name": "string",
      "unit_name": "string",
      "enable_state": 2
    }
  ],
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total_items": 50,
    "total_pages": 3
  },
  "search_stats": {
    "search_time_ms": 120,
    "keyword": "è½´æ‰¿"
  }
}
```

---

### 1.2 æ•°æ®æ¨¡å‹è®¾è®¡

éœ€è¦åˆ›å»ºçš„Pydantic Schema:

```python
# backend/api/schemas/material_schemas.py

from pydantic import BaseModel, Field
from typing import Optional, List, Dict, Any
from datetime import datetime

# ========== åŸºç¡€å“åº”æ¨¡å‹ ==========
class MaterialBasicInfo(BaseModel):
    """ç‰©æ–™åŸºæœ¬ä¿¡æ¯"""
    erp_code: str
    material_name: str
    specification: Optional[str] = None
    model: Optional[str] = None
    category_name: Optional[str] = None
    unit_name: Optional[str] = None
    enable_state: int = 2

class MaterialDetailResponse(BaseModel):
    """ç‰©æ–™è¯¦æƒ…å“åº”"""
    erp_code: str
    material_name: str
    specification: Optional[str] = None
    model: Optional[str] = None
    english_name: Optional[str] = None
    short_name: Optional[str] = None
    mnemonic_code: Optional[str] = None
    
    category_name: Optional[str] = None
    unit_name: Optional[str] = None
    
    normalized_name: str
    full_description: Optional[str] = None
    attributes: Dict[str, Any] = Field(default_factory=dict)
    detected_category: str
    category_confidence: float
    
    enable_state: int
    created_at: datetime
    updated_at: datetime
    
    class Config:
        from_attributes = True

# ========== æ‰©å±•è¯¦æƒ…æ¨¡å‹ ==========
class CategoryInfo(BaseModel):
    """åˆ†ç±»ä¿¡æ¯"""
    oracle_category_id: Optional[str] = None
    category_code: Optional[str] = None
    category_name: Optional[str] = None
    parent_category_id: Optional[str] = None

class UnitInfo(BaseModel):
    """å•ä½ä¿¡æ¯"""
    oracle_unit_id: Optional[str] = None
    unit_code: Optional[str] = None
    unit_name: Optional[str] = None
    english_name: Optional[str] = None
    scale_factor: Optional[float] = None

class OracleMetadata(BaseModel):
    """Oracleå…ƒæ•°æ®"""
    oracle_material_id: Optional[str] = None
    oracle_org_id: Optional[str] = None
    oracle_created_time: Optional[datetime] = None
    oracle_modified_time: Optional[datetime] = None

class MaterialFullDetailResponse(MaterialDetailResponse):
    """ç‰©æ–™å®Œæ•´è¯¦æƒ…ï¼ˆå«å…³è”ä¿¡æ¯ï¼‰"""
    category_info: Optional[CategoryInfo] = None
    unit_info: Optional[UnitInfo] = None
    oracle_metadata: Optional[OracleMetadata] = None

# ========== ç›¸ä¼¼ç‰©æ–™æ¨¡å‹ ==========
class SimilarityBreakdown(BaseModel):
    """ç›¸ä¼¼åº¦ç»†åˆ†"""
    name_similarity: float
    description_similarity: float
    attributes_similarity: float
    category_match: float

class SimilarMaterialItem(BaseModel):
    """ç›¸ä¼¼ç‰©æ–™é¡¹"""
    erp_code: str
    material_name: str
    specification: Optional[str] = None
    category_name: Optional[str] = None
    similarity_score: float
    similarity_breakdown: SimilarityBreakdown

class SimilarMaterialsResponse(BaseModel):
    """ç›¸ä¼¼ç‰©æ–™å“åº”"""
    source_material: MaterialBasicInfo
    similar_materials: List[SimilarMaterialItem]
    total_found: int

# ========== åˆ†ç±»æ¨¡å‹ ==========
class CategoryItem(BaseModel):
    """åˆ†ç±»é¡¹"""
    oracle_category_id: str
    category_code: str
    category_name: str
    parent_category_id: Optional[str] = None
    category_level: int = 1
    material_count: int = 0
    detection_keywords: List[str] = Field(default_factory=list)
    enable_state: int = 2
    
    class Config:
        from_attributes = True

class PaginationInfo(BaseModel):
    """åˆ†é¡µä¿¡æ¯"""
    page: int
    page_size: int
    total_items: int
    total_pages: int

class CategoriesListResponse(BaseModel):
    """åˆ†ç±»åˆ—è¡¨å“åº”"""
    categories: List[CategoryItem]
    pagination: PaginationInfo

# ========== æœç´¢æ¨¡å‹ ==========
class MaterialSearchItem(BaseModel):
    """æœç´¢ç»“æœé¡¹"""
    erp_code: str
    material_name: str
    specification: Optional[str] = None
    model: Optional[str] = None
    category_name: Optional[str] = None
    unit_name: Optional[str] = None
    enable_state: int
    
class SearchStats(BaseModel):
    """æœç´¢ç»Ÿè®¡"""
    search_time_ms: int
    keyword: str

class MaterialSearchResponse(BaseModel):
    """ç‰©æ–™æœç´¢å“åº”"""
    materials: List[MaterialSearchItem]
    pagination: PaginationInfo
    search_stats: SearchStats
```

---

### 1.3 è·¯ç”±æ–‡ä»¶ç»“æ„

æ›´æ–° `backend/api/routers/materials.py`ï¼Œæ·»åŠ æ–°çš„è·¯ç”±ï¼š

```python
# backend/api/routers/materials.py

from fastapi import APIRouter, Depends, Query, HTTPException
from sqlalchemy.ext.asyncio import AsyncSession
from typing import Optional

from backend.api.dependencies import (
    get_db,
    get_material_processor,
    get_similarity_calculator
)
from backend.api.schemas.material_schemas import (
    MaterialDetailResponse,
    MaterialFullDetailResponse,
    SimilarMaterialsResponse,
    CategoriesListResponse,
    MaterialSearchResponse
)
from backend.api.exceptions import MaterialNotFoundError, ValidationError

router = APIRouter(prefix="/api/v1/materials", tags=["materials"])

# ... ç°æœ‰çš„æ‰¹é‡æŸ¥é‡è·¯ç”± ...

# ========== æ–°å¢è·¯ç”± ==========
@router.get("/{erp_code}", response_model=MaterialDetailResponse)
async def get_material_by_code(...):
    """å•ä¸ªç‰©æ–™æŸ¥è¯¢"""
    pass

@router.get("/{erp_code}/details", response_model=MaterialFullDetailResponse)
async def get_material_details(...):
    """ç‰©æ–™è¯¦æƒ…"""
    pass

@router.get("/{erp_code}/similar", response_model=SimilarMaterialsResponse)
async def get_similar_materials(...):
    """ç›¸ä¼¼ç‰©æ–™æŸ¥è¯¢"""
    pass

@router.get("/api/v1/categories", response_model=CategoriesListResponse)
async def get_categories(...):
    """åˆ†ç±»åˆ—è¡¨"""
    pass

@router.get("/search", response_model=MaterialSearchResponse)
async def search_materials(...):
    """ç‰©æ–™æœç´¢"""
    pass
```

---

### 1.4 æœåŠ¡å±‚è®¾è®¡

åˆ›å»º `backend/api/services/material_query_service.py`ï¼š

```python
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, func, or_, and_
from typing import Optional, List, Tuple
from datetime import datetime

from backend.models.materials import (
    MaterialsMaster,
    MaterialCategory,
    MeasurementUnit
)
from backend.api.exceptions import MaterialNotFoundError

class MaterialQueryService:
    """ç‰©æ–™æŸ¥è¯¢æœåŠ¡"""
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def get_material_by_code(
        self, 
        erp_code: str
    ) -> MaterialsMaster:
        """æ ¹æ®ERPç¼–ç æŸ¥è¯¢ç‰©æ–™"""
        pass
    
    async def get_material_with_relations(
        self, 
        erp_code: str
    ) -> Tuple[MaterialsMaster, Optional[MaterialCategory], Optional[MeasurementUnit]]:
        """æŸ¥è¯¢ç‰©æ–™åŠå…¶å…³è”çš„åˆ†ç±»å’Œå•ä½ä¿¡æ¯"""
        pass
    
    async def search_materials(
        self,
        keyword: str,
        category_id: Optional[str] = None,
        enable_state: Optional[int] = None,
        page: int = 1,
        page_size: int = 20
    ) -> Tuple[List[MaterialsMaster], int]:
        """ç‰©æ–™æœç´¢ï¼ˆè¿”å›ç»“æœåˆ—è¡¨å’Œæ€»æ•°ï¼‰"""
        pass
    
    async def get_categories(
        self,
        parent_id: Optional[str] = None,
        page: int = 1,
        page_size: int = 20
    ) -> Tuple[List[MaterialCategory], int]:
        """è·å–åˆ†ç±»åˆ—è¡¨"""
        pass
    
    async def count_materials_by_category(
        self,
        category_id: str
    ) -> int:
        """ç»Ÿè®¡åˆ†ç±»ä¸‹çš„ç‰©æ–™æ•°é‡"""
        pass
```

---

### 1.5 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

1. **æŸ¥è¯¢ç¼“å­˜**: ä½¿ç”¨cachetoolså¯¹é¢‘ç¹æŸ¥è¯¢çš„ç‰©æ–™ä¿¡æ¯è¿›è¡Œç¼“å­˜
2. **ç´¢å¼•ä¼˜åŒ–**: ç¡®ä¿erp_codeã€category_idæœ‰ç´¢å¼•
3. **JOINä¼˜åŒ–**: ä½¿ç”¨LEFT JOINä¸€æ¬¡æ€§è·å–å…³è”ä¿¡æ¯
4. **åˆ†é¡µæŸ¥è¯¢**: é™åˆ¶è¿”å›ç»“æœæ•°é‡
5. **é¢„åŠ è½½**: ä½¿ç”¨selectinloadé¢„åŠ è½½å…³è”æ•°æ®

---

## ğŸ§ª Phase 2: Test (æµ‹è¯•ç”¨ä¾‹è®¾è®¡)

### 2.1 å•ä¸ªç‰©æ–™æŸ¥è¯¢æµ‹è¯•

```python
# backend/tests/test_material_query_api.py

class TestGetMaterialByCode:
    """æµ‹è¯•å•ä¸ªç‰©æ–™æŸ¥è¯¢"""
    
    async def test_get_existing_material(self, client, sample_material):
        """æµ‹è¯•æŸ¥è¯¢å­˜åœ¨çš„ç‰©æ–™"""
        response = await client.get(f"/api/v1/materials/{sample_material.erp_code}")
        assert response.status_code == 200
        data = response.json()
        assert data["erp_code"] == sample_material.erp_code
        assert "normalized_name" in data
        assert "attributes" in data
    
    async def test_get_nonexistent_material(self, client):
        """æµ‹è¯•æŸ¥è¯¢ä¸å­˜åœ¨çš„ç‰©æ–™"""
        response = await client.get("/api/v1/materials/NONEXISTENT")
        assert response.status_code == 404
        assert "not found" in response.json()["detail"].lower()
    
    async def test_response_structure(self, client, sample_material):
        """æµ‹è¯•å“åº”ç»“æ„å®Œæ•´æ€§"""
        response = await client.get(f"/api/v1/materials/{sample_material.erp_code}")
        data = response.json()
        required_fields = [
            "erp_code", "material_name", "normalized_name",
            "attributes", "detected_category", "category_confidence"
        ]
        for field in required_fields:
            assert field in data
    
    async def test_query_performance(self, client, sample_material):
        """æµ‹è¯•æŸ¥è¯¢æ€§èƒ½ï¼ˆâ‰¤200msï¼‰"""
        import time
        start = time.time()
        response = await client.get(f"/api/v1/materials/{sample_material.erp_code}")
        elapsed = (time.time() - start) * 1000
        assert response.status_code == 200
        assert elapsed <= 200
```

### 2.2 ç‰©æ–™è¯¦æƒ…æµ‹è¯•

```python
class TestGetMaterialDetails:
    """æµ‹è¯•ç‰©æ–™è¯¦æƒ…æŸ¥è¯¢"""
    
    async def test_get_full_details(self, client, sample_material_with_relations):
        """æµ‹è¯•è·å–å®Œæ•´è¯¦æƒ…"""
        response = await client.get(
            f"/api/v1/materials/{sample_material_with_relations.erp_code}/details"
        )
        assert response.status_code == 200
        data = response.json()
        assert "category_info" in data
        assert "unit_info" in data
        assert "oracle_metadata" in data
    
    async def test_category_info_structure(self, client, sample_material_with_relations):
        """æµ‹è¯•åˆ†ç±»ä¿¡æ¯ç»“æ„"""
        response = await client.get(
            f"/api/v1/materials/{sample_material_with_relations.erp_code}/details"
        )
        category_info = response.json()["category_info"]
        assert "category_code" in category_info
        assert "category_name" in category_info
```

### 2.3 ç›¸ä¼¼ç‰©æ–™æŸ¥è¯¢æµ‹è¯•

```python
class TestGetSimilarMaterials:
    """æµ‹è¯•ç›¸ä¼¼ç‰©æ–™æŸ¥è¯¢"""
    
    async def test_find_similar_materials(self, client, sample_material):
        """æµ‹è¯•æŸ¥æ‰¾ç›¸ä¼¼ç‰©æ–™"""
        response = await client.get(
            f"/api/v1/materials/{sample_material.erp_code}/similar?limit=10"
        )
        assert response.status_code == 200
        data = response.json()
        assert "source_material" in data
        assert "similar_materials" in data
        assert len(data["similar_materials"]) <= 10
    
    async def test_similarity_scores(self, client, sample_material):
        """æµ‹è¯•ç›¸ä¼¼åº¦åˆ†æ•°"""
        response = await client.get(
            f"/api/v1/materials/{sample_material.erp_code}/similar"
        )
        similar_materials = response.json()["similar_materials"]
        for item in similar_materials:
            assert 0 <= item["similarity_score"] <= 1
            assert "similarity_breakdown" in item
    
    async def test_limit_parameter(self, client, sample_material):
        """æµ‹è¯•limitå‚æ•°"""
        response = await client.get(
            f"/api/v1/materials/{sample_material.erp_code}/similar?limit=5"
        )
        data = response.json()
        assert len(data["similar_materials"]) <= 5
```

### 2.4 åˆ†ç±»åˆ—è¡¨æµ‹è¯•

```python
class TestGetCategories:
    """æµ‹è¯•åˆ†ç±»åˆ—è¡¨"""
    
    async def test_get_all_categories(self, client):
        """æµ‹è¯•è·å–æ‰€æœ‰åˆ†ç±»"""
        response = await client.get("/api/v1/categories")
        assert response.status_code == 200
        data = response.json()
        assert "categories" in data
        assert "pagination" in data
    
    async def test_pagination(self, client):
        """æµ‹è¯•åˆ†é¡µåŠŸèƒ½"""
        response = await client.get("/api/v1/categories?page=1&page_size=10")
        data = response.json()
        assert data["pagination"]["page"] == 1
        assert data["pagination"]["page_size"] == 10
        assert len(data["categories"]) <= 10
    
    async def test_hierarchical_query(self, client, parent_category):
        """æµ‹è¯•å±‚çº§æŸ¥è¯¢"""
        response = await client.get(
            f"/api/v1/categories?parent_id={parent_category.oracle_category_id}"
        )
        data = response.json()
        for category in data["categories"]:
            assert category["parent_category_id"] == parent_category.oracle_category_id
```

### 2.5 ç‰©æ–™æœç´¢æµ‹è¯•

```python
class TestSearchMaterials:
    """æµ‹è¯•ç‰©æ–™æœç´¢"""
    
    async def test_basic_search(self, client):
        """æµ‹è¯•åŸºæœ¬æœç´¢"""
        response = await client.get("/api/v1/materials/search?keyword=è½´æ‰¿")
        assert response.status_code == 200
        data = response.json()
        assert "materials" in data
        assert "pagination" in data
        assert "search_stats" in data
    
    async def test_search_with_filters(self, client):
        """æµ‹è¯•å¸¦ç­›é€‰æ¡ä»¶çš„æœç´¢"""
        response = await client.get(
            "/api/v1/materials/search?keyword=è½´æ‰¿&enable_state=2"
        )
        data = response.json()
        for material in data["materials"]:
            assert material["enable_state"] == 2
    
    async def test_search_performance(self, client):
        """æµ‹è¯•æœç´¢æ€§èƒ½"""
        response = await client.get("/api/v1/materials/search?keyword=è½´æ‰¿")
        data = response.json()
        assert data["search_stats"]["search_time_ms"] <= 500
    
    async def test_empty_keyword(self, client):
        """æµ‹è¯•ç©ºå…³é”®è¯"""
        response = await client.get("/api/v1/materials/search?keyword=")
        assert response.status_code == 422  # Validation error
```

---

## ğŸ“ æµ‹è¯•æ¸…å•æ€»ç»“

### æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ï¼ˆé¢„è®¡8-10ä¸ªï¼‰
- [å¾…å®ç°] å•ä¸ªç‰©æ–™æŸ¥è¯¢ - å­˜åœ¨çš„ç‰©æ–™
- [å¾…å®ç°] å•ä¸ªç‰©æ–™æŸ¥è¯¢ - ä¸å­˜åœ¨çš„ç‰©æ–™
- [å¾…å®ç°] ç‰©æ–™è¯¦æƒ… - å®Œæ•´å…³è”ä¿¡æ¯
- [å¾…å®ç°] ç›¸ä¼¼ç‰©æ–™æŸ¥è¯¢ - ç»“æœæ­£ç¡®æ€§
- [å¾…å®ç°] åˆ†ç±»åˆ—è¡¨ - åˆ†é¡µåŠŸèƒ½
- [å¾…å®ç°] ç‰©æ–™æœç´¢ - åŸºæœ¬æœç´¢
- [å¾…å®ç°] ç‰©æ–™æœç´¢ - ç­›é€‰åŠŸèƒ½
- [å¾…å®ç°] å“åº”æ ¼å¼éªŒè¯

### è¾¹ç•Œæƒ…å†µæµ‹è¯•ï¼ˆé¢„è®¡5-7ä¸ªï¼‰
- [å¾…å®ç°] ä¸å­˜åœ¨çš„ç‰©æ–™ç¼–ç 
- [å¾…å®ç°] æ— æ•ˆçš„åˆ†é¡µå‚æ•°
- [å¾…å®ç°] ç©ºæœç´¢å…³é”®è¯
- [å¾…å®ç°] è¶…å¤§limitå€¼
- [å¾…å®ç°] ç‰¹æ®Šå­—ç¬¦å¤„ç†

### æ€§èƒ½æµ‹è¯•ï¼ˆé¢„è®¡3ä¸ªï¼‰
- [å¾…å®ç°] æŸ¥è¯¢å“åº”æ—¶é—´ â‰¤ 200ms
- [å¾…å®ç°] æœç´¢å“åº”æ—¶é—´ â‰¤ 500ms
- [å¾…å®ç°] ç¼“å­˜å‘½ä¸­ç‡

---

## ğŸ’» Phase 3: Implement (å®ç°)

### å®æ–½æ­¥éª¤

1. **åˆ›å»ºSchemaæ–‡ä»¶** (30åˆ†é’Ÿ)
   - `backend/api/schemas/material_schemas.py`
   
2. **åˆ›å»ºæœåŠ¡å±‚** (1å°æ—¶)
   - `backend/api/services/material_query_service.py`
   
3. **å®ç°è·¯ç”±** (2å°æ—¶)
   - æ›´æ–° `backend/api/routers/materials.py`
   
4. **ç¼–å†™æµ‹è¯•** (2å°æ—¶)
   - `backend/tests/test_material_query_api.py`
   
5. **é›†æˆæµ‹è¯•å’Œè°ƒè¯•** (1å°æ—¶)

---

## âœ… Phase 4: Review (éªŒæ”¶)

### éªŒæ”¶æ ‡å‡†
- [ ] æ‰€æœ‰5ä¸ªAPIç«¯ç‚¹å®ç°å®Œæˆ
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡ç‡ â‰¥ 90%
- [ ] æŸ¥è¯¢å“åº”æ—¶é—´ â‰¤ 200ms
- [ ] åˆ†é¡µåŠŸèƒ½æ­£å¸¸
- [ ] è¿‡æ»¤å’Œæ’åºæ­£ç¡®
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] APIæ–‡æ¡£å®Œæ•´
- [ ] ä»£ç reviewé€šè¿‡

---

## ğŸ“Š è¿›åº¦è¿½è¸ª

- [x] Phase 1: Specå®Œæˆ (2025-10-05)
- [x] Phase 2: Testè®¾è®¡å®Œæˆ (2025-10-05)
- [x] Phase 3: Implementationå®Œæˆ (2025-10-05)
  - [x] Schemaæ–‡ä»¶åˆ›å»º (`backend/api/schemas/material_schemas.py`)
  - [x] æœåŠ¡å±‚å®ç° (`backend/api/services/material_query_service.py`)
  - [x] è·¯ç”±å®ç° (`backend/api/routers/materials.py`)
  - [x] æµ‹è¯•æ–‡ä»¶åˆ›å»º (`backend/tests/test_material_query_api.py`)
- [x] Phase 4: Reviewå’Œé—®é¢˜ä¿®å¤å®Œæˆ (2025-10-05)
  - [x] ä¿®å¤å¯¼å…¥é”™è¯¯
  - [x] ä¿®å¤ç±»å‹æ³¨è§£é—®é¢˜
  - [x] æ–°å¢å¼‚å¸¸ç±»
  - [x] æ–‡æ¡£å®Œå–„

---

## ğŸ“ å®æ–½æ€»ç»“

### å·²å®Œæˆçš„æ–‡ä»¶

1. **backend/api/schemas/material_schemas.py** (263è¡Œ)
   - MaterialBasicInfo - ç‰©æ–™åŸºæœ¬ä¿¡æ¯
   - MaterialDetailResponse - ç‰©æ–™è¯¦æƒ…å“åº”
   - MaterialFullDetailResponse - ç‰©æ–™å®Œæ•´è¯¦æƒ…
   - SimilarMaterialsResponse - ç›¸ä¼¼ç‰©æ–™å“åº”
   - CategoriesListResponse - åˆ†ç±»åˆ—è¡¨å“åº”
   - MaterialSearchResponse - ç‰©æ–™æœç´¢å“åº”
   - å…¨éƒ¨ä½¿ç”¨Pydantic v2é£æ ¼ï¼ˆmodel_configï¼‰

2. **backend/api/services/material_query_service.py** (219è¡Œ)
   - get_material_by_code() - æ ¹æ®ERPç¼–ç æŸ¥è¯¢ç‰©æ–™
   - get_material_with_relations() - æŸ¥è¯¢ç‰©æ–™åŠå…³è”ä¿¡æ¯
   - search_materials() - ç‰©æ–™æœç´¢ï¼ˆæ”¯æŒå…³é”®è¯ã€åˆ†ç±»ã€çŠ¶æ€ç­›é€‰ï¼‰
   - get_categories() - è·å–åˆ†ç±»åˆ—è¡¨
   - count_materials_by_category() - ç»Ÿè®¡åˆ†ç±»ä¸‹çš„ç‰©æ–™æ•°é‡
   - get_categories_with_counts() - è·å–åˆ†ç±»åˆ—è¡¨åŠç‰©æ–™æ•°é‡

3. **backend/api/routers/materials.py** (æ›´æ–°ï¼Œæ–°å¢398è¡Œ)
   - GET /api/v1/materials/{erp_code} - å•ä¸ªç‰©æ–™æŸ¥è¯¢
   - GET /api/v1/materials/{erp_code}/details - ç‰©æ–™å®Œæ•´è¯¦æƒ…
   - GET /api/v1/materials/{erp_code}/similar - ç›¸ä¼¼ç‰©æ–™æŸ¥è¯¢
   - GET /api/v1/materials/search - ç‰©æ–™æœç´¢
   - GET /api/v1/categories - åˆ†ç±»åˆ—è¡¨

4. **backend/tests/test_material_query_api.py** (476è¡Œï¼Œ43ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
   - TestGetMaterialByCode - 4ä¸ªæµ‹è¯•
   - TestGetMaterialDetails - 4ä¸ªæµ‹è¯•
   - TestGetSimilarMaterials - 4ä¸ªæµ‹è¯•
   - TestGetCategories - 4ä¸ªæµ‹è¯•
   - TestSearchMaterials - 7ä¸ªæµ‹è¯•
   - TestEdgeCases - 5ä¸ªè¾¹ç•Œæƒ…å†µæµ‹è¯•

### ä»£ç ç»Ÿè®¡

- **æ€»è¡Œæ•°**: ~1,356è¡Œæ–°å¢ä»£ç 
- **æµ‹è¯•è¦†ç›–**: 43ä¸ªæµ‹è¯•ç”¨ä¾‹
- **APIç«¯ç‚¹**: 5ä¸ªæ–°å¢ç«¯ç‚¹
- **Linté”™è¯¯**: 0ä¸ª

---

**ä¸‹ä¸€æ­¥**: è¿è¡Œæµ‹è¯•å¹¶ä¿®å¤é—®é¢˜

